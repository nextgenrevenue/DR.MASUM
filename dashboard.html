<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- pdfmake ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --gray: #6b7280;
      --light-gray: #f3f4f6;
      --white: #ffffff;
      --dark: #1f2937;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans Bengali', sans-serif;
      background-color: #f5f7fa;
      min-height: 100vh;
    }
    
    /* Admin Header */
    .admin-header {
      background-color: var(--dark);
      color: var(--white);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .admin-header h1 {
      font-size: 22px;
    }
    
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--white);
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }
    
    .logout-btn {
      padding: 8px 16px;
      background-color: var(--danger);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Noto Sans Bengali', sans-serif;
    }
    
    .logout-btn:hover {
      background-color: #b91c1c;
    }
    
    /* Admin Container */
    .admin-container {
      display: flex;
      min-height: calc(100vh - 60px);
    }
    
    /* Sidebar */
    .admin-sidebar {
      width: 250px;
      background-color: var(--white);
      border-right: 1px solid #e5e7eb;
      padding: 20px 0;
      transition: transform 0.3s ease;
    }
    
    .sidebar-menu {
      list-style: none;
    }
    
    .sidebar-menu li {
      margin-bottom: 5px;
    }
    
    .sidebar-menu a {
      display: block;
      padding: 12px 20px;
      color: var(--dark);
      text-decoration: none;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .sidebar-menu a:hover, 
    .sidebar-menu a.active {
      background-color: var(--light-gray);
      color: var(--primary);
    }
    
    .sidebar-menu a i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    /* Main Content */
    .admin-main {
      flex: 1;
      padding: 20px;
      background-color: #f9fafb;
    }
    
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background-color: var(--white);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .card h3 {
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .card p {
      font-size: 24px;
      font-weight: 700;
      color: var(--dark);
    }
    
    .card.thursday p {
      color: var(--primary);
    }
    
    .card.friday p {
      color: #8b5cf6;
    }

    .card.available p {
      color: var(--success);
    }

    .card.pending p {
      color: #4169E1;
    }
    
    .card.total p {
      color: var(--warning);
    }

    /* Content Sections */
    .content-section {
       margin-top: 20px;
    }

    /* Bulk Actions */
    .bulk-actions {
      background-color: var(--white);
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .bulk-checkbox {
      width: 18px;
      height: 18px;
    }
    
    .bulk-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* Admin Tables */
    .admin-table {
      width: 100%;
      background-color: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      overflow-x: auto;
    }
    
    .admin-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .admin-table-header h2 {
      font-size: 18px;
      color: var(--dark);
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .search-box {
      position: relative;
    }
    
    .search-box input {
      padding: 8px 15px 8px 35px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Noto Sans Bengali', sans-serif;
    }
    
    .search-box i {
      position: absolute;
      left: 12px;
      top: 10px;
      color: var(--gray);
    }
    
    .filter-group {
      display: flex;
      gap: 10px;
    }
    
    .filter-group select {
      padding: 8px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Noto Sans Bengali', sans-serif;
    }
    
    .export-btn {
      background-color: var(--success);
      color: var(--white);
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
    }
    
    .export-btn:hover {
      background-color: #15803d;
    }
    
    .add-serial-btn {
      background-color: var(--warning);
      color: var(--white);
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
    }
    
    .add-serial-btn:hover {
      background-color: #e58e0b;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    th {
      background-color: var(--light-gray);
      font-weight: 600;
      color: var(--dark);
    }
    
    tr:hover {
      background-color: #f9fafb;
    }
    
    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status.booked {
      background-color: #fee2e2;
      color: var(--danger);
    }
    
    .status.available {
      background-color: #dcfce7;
      color: var(--success);
    }
    
    .status.pending {
      background-color: #dbeafe;
      color: var(--primary);
    }
    
    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 13px;
      margin-right: 5px;
    }
    
    .edit-btn {
      background-color: #bfdbfe;
      color: var(--primary);
    }
    
    .cancel-btn {
      background-color: #fee2e2;
      color: var(--danger);
    }
    
    .add-btn {
      background-color: var(--primary);
      color: var(--white);
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
    }
    
    .add-btn:hover {
      background-color: var(--primary-hover);
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: var(--white);
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: var(--dark);
      font-size: 20px;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--gray);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Noto Sans Bengali', sans-serif;
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .form-actions button {
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
    }
    
    .submit-btn {
      background-color: var(--primary);
      color: var(--white);
      border: none;
    }
    
    .submit-btn:hover {
      background-color: var(--primary-hover);
    }
    
    .cancel-btn-modal {
      background-color: var(--light-gray);
      color: var(--dark);
      border: none;
    }
    
    /* Quick Serial Modal */
    .serial-types {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 15px 0;
    }
    
    .serial-type-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .serial-type-card:hover {
      border-color: var(--primary);
    }
    
    .serial-type-card.selected {
      border-color: var(--primary);
      background-color: #eff6ff;
    }
    #quickSerialModal .modal-content {
      max-height: 90vh;         
      overflow-y: auto;         
    }
    /* Serial Grid */
    .serial-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
      gap: 8px;
      margin: 15px 0;
      max-height: 250px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    
    .serial-item {
      padding: 10px;
      text-align: center;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: var(--white);
      font-weight: 500;
      font-size: 14px;
    }
    
/* Available - Green */
.serial-item.available {
  background-color: #dcfce7;
  color: var(--success);
  border-color: var(--success);
}

.serial-item.available:hover {
  background-color: #bbf7d0;
}

/* Selected - Yellow */
.serial-item.selected {
  background-color: #fef3c7;
  color: var(--warning);
  border-color: var(--warning);
}

/* Pending - Blue */
.serial-item.pending {
  background-color: #dbeafe;
  color: var(--primary);
  border-color: var(--primary);
  cursor: not-allowed;
  opacity: 0.7;
}

/* Booked - Red */
.serial-item.booked {
  background-color: #fecaca;
  color: var(--danger);
  border-color: var(--danger);
  cursor: not-allowed;
  opacity: 0.8;
}
    
    /* Export Modal */
    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .export-option {
      background-color: var(--light-gray);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .export-option:hover {
      background-color: #e5e7eb;
      transform: translateY(-2px);
    }
    
    .export-option i {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }
    
    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Alert Messages */
    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .alert-success {
      background-color: #dcfce7;
      color: var(--success);
      border: 1px solid #bbf7d0;
    }
    
    .alert-error {
      background-color: #fee2e2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }
/* PC/Destop Styles (default) */
.admin-sidebar {
  width: 250px;
  background-color: var(--white);
  border-right: 1px solid #e5e7eb;
  padding: 20px 0;
  display: block;
}

.admin-container {
  display: flex;
  min-height: calc(100vh - 60px);
}

.mobile-menu-btn {
  display: none; /* PC ‡¶§‡ßáÈöêËóè */
}

  /* Responsive */
/* Mobile Styles */
@media (max-width: 768px) {
  .mobile-menu-btn {
    display: block;
  }
  
  .admin-sidebar {
    position: fixed;
    top: 60px;
    left: 0;
    height: calc(100vh - 60px);
    transform: translateX(-100%);
    z-index: 100;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }
  
  .admin-sidebar.mobile-open {
    transform: translateX(0);
  }
  
  .admin-container {
    flex-direction: column;
  }
  
  /* ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ responsive ‡¶ï‡¶∞‡ßã */
  .admin-table {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  table {
    min-width: 800px; /* ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ minimum width */
  }
  
  /* ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ responsive */
  .admin-table-header {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }
  
  .header-actions {
    flex-direction: column;
    width: 100%;
    gap: 10px;
  }
  
  .filter-group {
    flex-wrap: wrap;
    width: 100%;
    gap: 8px;
  }
  
  .filter-group select {
    flex: 1;
    min-width: 120px;
    font-size: 14px;
    padding: 8px 12px;
  }
  
  .search-box {
    width: 100%;
  }
  
  .search-box input {
    width: 100%;
    font-size: 14px;
  }
  
  /* ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶≤‡¶ø */
  .add-serial-btn,
  .export-btn,
  .add-btn {
    width: 100%;
    padding: 10px;
    font-size: 14px;
    text-align: center;
  }
  
  /* ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
  .dashboard-cards {
    grid-template-columns: 1fr 1fr;
  }
  
  .bulk-actions {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }
  
  .bulk-buttons {
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .serial-types {
    grid-template-columns: 1fr;
  }
  
  .serial-grid {
    grid-template-columns: repeat(7, 1fr) !important;
    gap: 4px !important;
    max-height: none !important;
    overflow-y: visible !important;
    padding: 8px !important;
  }
  
  #quickSerialModal .modal-content {
    margin: 10px !important;
    width: calc(100% - 20px) !important;
    padding: 15px;
  }
}

/* ‡¶ñ‡ßÅ‡¶¨ ‡¶õ‡ßã‡¶ü ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
@media (max-width: 480px) {
  .admin-main {
    padding: 8px;
  }
  
  .dashboard-cards {
    gap: 8px;
  }
  
  .card {
    padding: 12px;
  }
  
  .admin-table-header h2 {
    font-size: 16px;
  }
  
  .filter-group select {
    min-width: 100px;
    font-size: 13px;
    padding: 6px 10px;
  }
  
  #quickSerialModal .modal-content {
    margin: 5px !important;
    width: calc(100% - 10px) !important;
    padding: 12px;
  }
  
  .serial-grid {
    grid-template-columns: repeat(7, 1fr) !important;
    gap: 3px !important;
  }
}
  </style>
</head>
<body>
  <!-- Admin Header -->
  <header class="admin-header">
    <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
    <h1>‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1>
    <button class="logout-btn" id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
  </header>
  
  <!-- Admin Container -->
  <div class="admin-container">
    <!-- Sidebar -->
    <nav class="admin-sidebar" id="sidebar">
      <ul class="sidebar-menu">
        <li><a href="/dashboard" class="active"><i>üìä</i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a></li>
        <li><a href="#"><i>üìÖ</i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a></li>
        <li><a href="/live"><i>üë®‚Äç‚öïÔ∏è</i> ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏</a></li>
        <li><a href="#"><i>‚è∞</i> ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a></li>
        <li><a href="/notice"><i>üë•</i> ‡¶®‡ßã‡¶ü‡¶ø‡¶∏</a></li>
        <li><a href="/settings"><i>‚öôÔ∏è</i> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</a></li>
      </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="admin-main">
      <!-- Alert Messages -->
      <div id="alertContainer"></div>
      
      <!-- Dashboard Cards -->
<div class="dashboard-cards">
  <!-- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
  <div class="card thursday">
    <h3>‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
    <p id="thursdayAppointments">0</p>
  </div>
  
  <div class="card friday">
    <h3>‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
    <p id="fridayAppointments">0</p>
  </div>
  
  <div class="card total-appointments">
    <h3>‡¶Æ‡ßã‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
    <p id="totalAppointments">0</p>
  </div>
  
  <!-- ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
  <div class="card pending">
    <h3>‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</h3>
    <p id="pendingSerials">0</p>
  </div>
    <div class="card available">
    <h3>‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</h3>
    <p id="availableSerials">0</p>
  </div>
  <div class="card total">
    <h3>‡¶Æ‡ßã‡¶ü ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú</h3>
    <p id="totalSerials">0</p>
  </div>
</div>

      <!-- Bulk Actions -->
      <div class="bulk-actions" id="bulkActions" style="display: none;">
        <input type="checkbox" id="selectAll" class="bulk-checkbox">
        <span id="selectedCount">0‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°</span>
        <div class="bulk-buttons">
          <button class="action-btn cancel-btn" id="deleteSelected">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
          <button class="action-btn" id="clearSelection">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞</button>
        </div>
      </div>
      
      <!-- Appointments Table -->
      <div class="admin-table">
        <div class="admin-table-header">
          <h2>‡¶∏‡¶ï‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
          <div class="header-actions">
            <div class="filter-group">
              <select id="dayFilterAppointments">
                <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶¶‡¶ø‡¶®</option>
                <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
                <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
              </select>
              <select id="typeFilterAppointments">
                <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶ß‡¶∞‡¶®</option>
                <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
                <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
              </select>
              <select id="timeFilterAppointments">
                <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>
              </select>
            </div>
            <div class="search-box">
              <i>üîç</i>
              <input type="text" id="searchAppointments" placeholder="‡¶®‡¶æ‡¶Æ, ‡¶´‡ßã‡¶® ‡¶¨‡¶æ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
            </div>
            <button class="add-serial-btn" id="addSerialQuickBtn">‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="export-btn" id="exportAppointmentsBtn">‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th width="50px">
                <input type="checkbox" id="selectAllHeader">
              </th>
              <th>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</th>
              <th>‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
              <th>‡¶¨‡ßü‡¶∏</th>
              <th>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
              <th>‡¶¶‡¶ø‡¶®</th>
              <th>‡¶∏‡¶Æ‡¶Ø‡¶º</th>
              <th>‡¶ß‡¶∞‡¶®</th>
              <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
            </tr>
          </thead>
          <tbody id="appointmentsTable">
            <tr>
              <td colspan="9" style="text-align: center; padding: 20px; color: var(--gray);">
                ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Serial Management Table -->
      <div class="admin-table">
        <div class="admin-table-header">
          <h2>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
          <div class="header-actions">
            <div class="filter-group">
              <select id="dayFilterSerial">
                <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶¶‡¶ø‡¶®</option>
                <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
                <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
              </select>
              <select id="typeFilterSerial">
                <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶ß‡¶∞‡¶®</option>
                <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
                <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
              </select>
              <select id="timeFilterSerial">
                <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>
              </select>
            </div>
            <div class="search-box">
              <i>üîç</i>
              <input type="text" id="searchSerials" placeholder="‡¶∏‡¶Æ‡ßü ‡¶¨‡¶æ ‡¶ß‡¶∞‡¶® ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
            </div>
            <button class="add-btn" id="addSerialBtn">‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>‡¶¶‡¶ø‡¶®</th>
              <th>‡¶∏‡¶Æ‡¶Ø‡¶º</th>
              <th>‡¶ß‡¶∞‡¶®</th>
              <th>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú</th>
              <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
              <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
            </tr>
          </thead>
          <tbody id="serialsTable">
            <tr>
              <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>
  
  <!-- Add/Edit Serial Modal -->
  <div class="modal" id="serialModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <form id="serialForm">
        <div class="form-group">
          <label for="modalDay">‡¶¶‡¶ø‡¶®</label>
          <select id="modalDay" required>
            <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
            <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
          </select>
        </div>
        <div class="form-group">
          <label for="modalTime">‡¶∏‡¶Æ‡¶Ø‡¶º</label>
          <input type="text" id="modalTime" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: 5:00 PM" required>
        </div>
        <div class="form-group">
          <label for="modalType">‡¶ß‡¶∞‡¶®</label>
          <select id="modalType" required>
            <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
            <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="modalStart">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</label>
          <input type="number" id="modalStart" min="1" required>
        </div>
        <div class="form-group">
          <label for="modalEnd">‡¶∂‡ßá‡¶∑ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</label>
          <input type="number" id="modalEnd" min="1" required>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn-modal" id="cancelModal">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
          <button type="submit" class="submit-btn" id="submitSerialBtn">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Add Serial Modal -->
  <div class="modal" id="quickSerialModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
        <button class="close-btn" id="closeQuickModal">&times;</button>
      </div>
      <form id="quickSerialForm">
        <div class="form-group">
          <label for="quickDay">‡¶¶‡¶ø‡¶®</label>
          <select id="quickDay" required>
            <option value="">-- ‡¶¶‡¶ø‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
            <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
          </select>
        </div>
        <div class="form-group">
          <label for="quickTime">‡¶∏‡¶Æ‡¶Ø‡¶º</label>
          <select id="quickTime" required>
            <option value="">-- ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
          </select>
        </div>
        
        <!-- Serial Grid -->
        <div class="form-group">
          <label>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
          <div class="serial-grid" id="serialGrid">
            <!-- Serial items will be dynamically added here -->
          </div>
        </div>
        
        <div class="serial-types">
          <div class="serial-type-card selected" data-type="new">
            <h4>‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</h4>
          </div>
          <div class="serial-type-card" data-type="old">
            <h4>‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</h4>
          </div>
        </div>
        <input type="hidden" id="selectedPatientType" value="new">
        <input type="hidden" id="selectedSerialNumber" value="">
        <div class="form-group">
          <label for="quickName">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
          <input type="text" id="quickName" required>
        </div>
        <div class="form-group">
          <label for="quickAge">‡¶¨‡ßü‡¶∏</label>
          <input type="number" id="quickAge" min="1" max="120" required>
        </div>
        <div class="form-group">
          <label for="quickPhone">‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
          <input type="text" id="quickPhone" required>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn-modal" id="cancelQuickModal">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
          <button type="submit" class="submit-btn" id="submitQuickBtn">‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Appointment Modal -->
  <div class="modal" id="editAppointmentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
        <button class="close-btn" id="closeEditModal">&times;</button>
      </div>
      <form id="editAppointmentForm">
        <input type="hidden" id="editAppointmentId">
        <div class="form-group">
          <label for="editName">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
          <input type="text" id="editName" required>
        </div>
        <div class="form-group">
          <label for="editAge">‡¶¨‡ßü‡¶∏</label>
          <input type="number" id="editAge" min="1" max="120" required>
        </div>
        <div class="form-group">
          <label for="editPhone">‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
          <input type="text" id="editPhone" required>
        </div>
        <div class="form-group">
          <label for="editDay">‡¶¶‡¶ø‡¶®</label>
          <select id="editDay" required>
            <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
            <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editTime">‡¶∏‡¶Æ‡¶Ø‡¶º</label>
          <input type="text" id="editTime" required>
        </div>
        <div class="form-group">
          <label for="editType">‡¶ß‡¶∞‡¶®</label>
          <select id="editType" required>
            <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
            <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editSerial">‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</label>
          <input type="number" id="editSerial" min="1" required>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn-modal" id="cancelEditModal">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
          <button type="submit" class="submit-btn" id="submitEditBtn">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶Ö‡¶™‡¶∂‡¶®</h2>
        <button class="close-btn" id="closeExportModal">&times;</button>
      </div>
      <div class="export-options">
        <div class="export-option" data-format="pdf">
          <i>üìÑ</i>
          <div>PDF</div>
        </div>
        <div class="export-option" data-format="excel">
          <i>üìä</i>
          <div>Excel</div>
        </div>
       <div class="export-option" data-format="word">
          <i>üìù</i>
          <div>Word</div>
        </div>
       <div class="export-option" data-format="docs">
         <i>üìã</i>
         <div>Docs</div>
       </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCUGkcHFSYVmA0KUSRHhY-ZFFAS6jpJe4M",
      authDomain: "doctor-appointment-syste-23828.firebaseapp.com",
      projectId: "doctor-appointment-syste-23828",
      storageBucket: "doctor-appointment-syste-23828.appspot.com",
      messagingSenderId: "79600391014",
      appId: "1:79600391014:web:9688db8bb62f431ae16ea7"
    };

    // Global variables
    let db;
    let serialRanges = {};
    let appointments = [];
    let realtimeListeners = [];
    let selectedAppointments = new Set();
    let searchTimer;
    let currentAdminPendingId = null;
    let allPendingSelections = {};

    // ==================== INITIALIZATION ====================
    function initializeFirebase() {
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        console.log("‚úÖ Firebase initialized successfully");
        return true;
      } catch (error) {
        console.error("‚ùå Firebase initialization error:", error);
        showAlert('Firebase initialization failed: ' + error.message, 'error');
        return false;
      }
    }

    async function initializeFirebaseData() {
      if (!db) return;
      
      try {
        const doc = await db.collection('settings').doc('serialRanges').get();
        if (!doc.exists) {
          await db.collection('settings').doc('serialRanges').set({
            Thursday: {},
            Friday: {}
          });
        }
      } catch (error) {
        console.error('‚ùå Error initializing Firebase data:', error);
      }
    }

    // ==================== DOM ELEMENTS ====================
    const elements = {
      // Header & Sidebar
      mobileMenuBtn: document.getElementById('mobileMenuBtn'),
      sidebar: document.getElementById('sidebar'),
      logoutBtn: document.getElementById('logoutBtn'),
      
      // Dashboard Cards
      thursdayAppointments: document.getElementById('thursdayAppointments'),
      fridayAppointments: document.getElementById('fridayAppointments'),
      totalSerials: document.getElementById('totalSerials'),
      totalPatients: document.getElementById('totalPatients'),
      
      // Tables
      appointmentsTable: document.getElementById('appointmentsTable'),
      serialsTable: document.getElementById('serialsTable'),
      
      // Filters
      dayFilterAppointments: document.getElementById('dayFilterAppointments'),
      typeFilterAppointments: document.getElementById('typeFilterAppointments'),
      timeFilterAppointments: document.getElementById('timeFilterAppointments'),
      searchAppointments: document.getElementById('searchAppointments'),
      
      // Serial Filters
      dayFilterSerial: document.getElementById('dayFilterSerial'),
      typeFilterSerial: document.getElementById('typeFilterSerial'),
      timeFilterSerial: document.getElementById('timeFilterSerial'),
      searchSerials: document.getElementById('searchSerials'),
      
      // Buttons
      addSerialBtn: document.getElementById('addSerialBtn'),
      addSerialQuickBtn: document.getElementById('addSerialQuickBtn'),
      exportAppointmentsBtn: document.getElementById('exportAppointmentsBtn'),
      
      // Bulk Actions
      bulkActions: document.getElementById('bulkActions'),
      selectAllHeader: document.getElementById('selectAllHeader'),
      selectAll: document.getElementById('selectAll'),
      selectedCount: document.getElementById('selectedCount'),
      deleteSelected: document.getElementById('deleteSelected'),
      clearSelection: document.getElementById('clearSelection'),
      
      // Modals
      serialModal: document.getElementById('serialModal'),
      quickSerialModal: document.getElementById('quickSerialModal'),
      editAppointmentModal: document.getElementById('editAppointmentModal'),
      exportModal: document.getElementById('exportModal'),
      
      // Forms
      serialForm: document.getElementById('serialForm'),
      quickSerialForm: document.getElementById('quickSerialForm'),
      editAppointmentForm: document.getElementById('editAppointmentForm'),
      
      // Modal Buttons
      closeModal: document.getElementById('closeModal'),
      cancelModal: document.getElementById('cancelModal'),
      closeQuickModal: document.getElementById('closeQuickModal'),
      cancelQuickModal: document.getElementById('cancelQuickModal'),
      closeEditModal: document.getElementById('closeEditModal'),
      cancelEditModal: document.getElementById('cancelEditModal'),
      closeExportModal: document.getElementById('closeExportModal'),
      
      // Alert Container
      alertContainer: document.getElementById('alertContainer')
    };

    // ==================== UTILITY FUNCTIONS ====================
    function showAlert(message, type = 'success') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      elements.alertContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function checkDatabase() {
      if (!db) {
        showAlert('‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
        return false;
      }
      return true;
    }

    function validateBangladeshiPhone(phone) {
      return /^(?:\+88|01)[3-9]\d{8}$/.test(phone.replace(/\s/g, ''));
    }

    // ==================== AUTHENTICATION CHECK ====================
function checkAuthentication() {
    console.log('üîê Checking authentication...');
    
    const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
    const loginTime = sessionStorage.getItem('loginTime');
    
    console.log('Login status:', isLoggedIn);
    console.log('Login time:', loginTime);
    
    if (!isLoggedIn) {
        console.log('‚ùå User not logged in, redirecting to login...');
        alert('Please login first!');
        window.location.href = '/login';
        return false;
    }
    
    // Check if session is expired (2 hours)
    const currentTime = new Date().getTime();
    const sessionDuration = 2 * 60 * 60 * 1000; // 2 hours
    
    if (currentTime - parseInt(loginTime) > sessionDuration) {
        console.log('‚ùå Session expired, redirecting to login...');
        sessionStorage.clear();
        alert('Session expired! Please login again.');
        window.location.href = '/login';
        return false;
    }
    
    console.log('‚úÖ Authentication successful!');
    return true;
}

// ==================== LOGOUT FUNCTION ====================
function handleLogout() {
    console.log('üö™ Logout initiated...');
    
    if (confirm('Are you sure you want to logout?')) {
        // Stop all Firebase listeners
        if (realtimeListeners && realtimeListeners.length > 0) {
            console.log('Stopping Firebase listeners...');
            realtimeListeners.forEach(unsubscribe => {
                if (unsubscribe && typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
        }
        
        // Clear session
        console.log('Clearing session storage...');
        sessionStorage.clear();
        
        // Show confirmation
        alert('Logout successful!');
        
        // Redirect to login page
        console.log('Redirecting to login page...');
        window.location.href = '/login';
    }
}

    // ==================== FIREBASE FUNCTIONS ====================
    async function loadSerialRanges() {
      if (!checkDatabase()) return;
      
      try {
        const doc = await db.collection('settings').doc('serialRanges').get();
        
        if (doc.exists) {
          serialRanges = doc.data();
          if (!serialRanges.Thursday) serialRanges.Thursday = {};
          if (!serialRanges.Friday) serialRanges.Friday = {};
        } else {
          serialRanges = { Thursday: {}, Friday: {} };
          await saveSerialRanges();
        }
        loadSerials();
        updateTimeFilterOptions();
        updateQuickTimeOptions();
        updateSerialTimeFilterOptions();
      } catch (error) {
        console.error('‚ùå Error loading serial ranges:', error);
        showAlert('‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
        serialRanges = { Thursday: {}, Friday: {} };
      }
    }

    async function saveSerialRanges() {
      if (!checkDatabase()) return false;
      
      try {
        await db.collection('settings').doc('serialRanges').set(serialRanges, { merge: true });
        loadSerials();
        return true;
      } catch (error) {
        console.error('‚ùå Error saving serial ranges:', error);
        showAlert('‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
        return false;
      }
    }

    function loadAppointmentsFromFirebase() {
      if (!checkDatabase()) return;
      
      realtimeListeners.forEach(unsubscribe => unsubscribe());
      realtimeListeners = [];

      const appointmentsListener = db.collection('appointments')
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
          appointments = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            appointments.push({
              id: doc.id,
              ...data
            });
          });
          loadSerials();
          updateStats();
          loadAppointments();
          console.log('‚úÖ Admin: Appointments updated in real-time');
        }, error => {
          console.error('‚ùå Error loading appointments:', error);
          showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
        });

      realtimeListeners.push(appointmentsListener);
    }

    // ==================== DASHBOARD FUNCTIONS ====================
    function initDashboard() {
      if (!checkDatabase()) {
        showAlert('‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
        return;
      }
      
      console.log('üöÄ Starting dashboard initialization...');
      
      initializeFirebaseData().then(() => {
        console.log('‚úÖ Firebase data initialized');
        loadSerialRanges();
        loadAppointmentsFromFirebase();
        loadPendingSelectionsInDashboard();
      }).catch(error => {
        console.error('‚ùå Dashboard init error:', error);
      });
    }

    function updateStats() {
      // Get current filter values
      const dayFilter = elements.dayFilterAppointments.value;
      const typeFilter = elements.typeFilterAppointments.value;
      const timeFilter = elements.timeFilterAppointments.value;
      const searchTerm = elements.searchAppointments.value.toLowerCase().trim();

      // Filter appointments based on current filters
      const filteredAppointments = appointments.filter(app => {
        // Search filter
        if (searchTerm && !(
          app.name.toLowerCase().includes(searchTerm) ||
          app.phone.includes(searchTerm) ||
          app.serial.toString().includes(searchTerm)
        )) {
          return false;
        }

        // Day filter
        if (dayFilter !== 'all' && app.day !== dayFilter) {
          return false;
        }

        // Type filter
        if (typeFilter !== 'all') {
          const patientType = app.patientType || app.type;
          if (patientType !== typeFilter) {
            return false;
          }
        }

        // Time filter
        if (timeFilter !== 'all' && app.time !== timeFilter) {
          return false;
        }

        return true;
      });

      // Calculate counts based on FILTERED data
      const thursdayApps = filteredAppointments.filter(app => app.day === 'Thursday');
      const fridayApps = filteredAppointments.filter(app => app.day === 'Friday');
      const totalApps = thursdayApps.length + fridayApps.length;

      // Calculate total serials count
      let totalSerialsCount = 0;
      for (const day in serialRanges) {
        for (const type in serialRanges[day]) {
          for (const time in serialRanges[day][type]) {
            const [start, end] = serialRanges[day][type][time];
            totalSerialsCount += (end - start + 1);
          }
        }
      }

      // Calculate available serials  
      const totalBookedApps = appointments.length; // ‡¶∏‡¶¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü
      const availableSerials = totalSerialsCount - totalBookedApps;

      // Update UI - ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶ï‡¶ö‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ
      document.getElementById('thursdayAppointments').textContent = thursdayApps.length;
      document.getElementById('fridayAppointments').textContent = fridayApps.length;
      document.getElementById('totalAppointments').textContent = totalApps;
      document.getElementById('availableSerials').textContent = availableSerials;
      document.getElementById('totalSerials').textContent = totalSerialsCount;
    }

    // ==================== PENDING COUNT FOR DASHBOARD ====================
    function updatePendingCountInDashboard() {
      let totalPendingCount = 0;
      
      // Calculate total pending count from all slots
      for (const key in allPendingSelections) {
        totalPendingCount += allPendingSelections[key].size;
      }
      
      // Update dashboard card
      document.getElementById('pendingSerials').textContent = totalPendingCount;
      console.log(`üìä Dashboard: Total pending serials = ${totalPendingCount}`);
    }

    // ==================== APPOINTMENT MANAGEMENT ====================
    function loadAppointments(searchTerm = '') {
      elements.appointmentsTable.innerHTML = '';
      selectedAppointments.clear();
      updateBulkActions();
      
      const normalizedSearchTerm = searchTerm.toLowerCase().trim();
      const dayFilter = elements.dayFilterAppointments.value;
      const typeFilter = elements.typeFilterAppointments.value;
      const timeFilter = elements.timeFilterAppointments.value;

      const filteredAppointments = appointments.filter(app => {
        // Search filter with debounce
        if (normalizedSearchTerm && !(
          app.name.toLowerCase().includes(normalizedSearchTerm) ||
          app.phone.includes(normalizedSearchTerm) ||
          app.serial.toString().includes(normalizedSearchTerm)
        )) {
          return false;
        }

        // Day filter
        if (dayFilter !== 'all' && app.day !== dayFilter) {
          return false;
        }

        // Type filter
        if (typeFilter !== 'all') {
          const patientType = app.patientType || app.type;
          if (patientType !== typeFilter) {
            return false;
          }
        }

        // Time filter
        if (timeFilter !== 'all' && app.time !== timeFilter) {
          return false;
        }

        return true;
      });

      filteredAppointments.sort((a, b) => a.serial - b.serial);
      
      if (filteredAppointments.length === 0) {
        elements.appointmentsTable.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 20px; color: var(--gray);">
              ${searchTerm ? '‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø' : '‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á'}
            </td>
          </tr>
        `;
        return;
      }
      
      filteredAppointments.forEach(app => {
        const typeText = (app.patientType || app.type) === 'new' ? '‡¶®‡¶§‡ßÅ‡¶®' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶®';
        const dayText = app.day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
        const age = app.age || 'N/A';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <input type="checkbox" class="appointment-checkbox" value="${app.id}">
          </td>
          <td>${app.serial}</td>
          <td>${app.name}</td>
          <td>${age} ‡¶¨‡¶õ‡¶∞</td>
          <td>${app.phone}</td>
          <td>${dayText}</td>
          <td>${app.time}</td>
          <td>${typeText}</td>
          <td>
            <button class="action-btn edit-btn" data-id="${app.id}">‡¶è‡¶°‡¶ø‡¶ü</button>
            <button class="action-btn cancel-btn" data-id="${app.id}">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
          </td>
        `;
        elements.appointmentsTable.appendChild(row);
      });
      
      // Add event listeners
      document.querySelectorAll('.appointment-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            selectedAppointments.add(this.value);
          } else {
            selectedAppointments.delete(this.value);
            elements.selectAllHeader.checked = false;
            elements.selectAll.checked = false;
          }
          updateBulkActions();
        });
      });
      
      document.querySelectorAll('#appointmentsTable .cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          cancelAppointment(id);
        });
      });
      
      document.querySelectorAll('#appointmentsTable .edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          editAppointment(id);
        });
      });
    }

    function updateBulkActions() {
      const count = selectedAppointments.size;
      elements.selectedCount.textContent = `${count}‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°`;
      
      if (count > 0) {
        elements.bulkActions.style.display = 'flex';
      } else {
        elements.bulkActions.style.display = 'none';
      }
    }

    async function cancelAppointment(id) {
      if (!checkDatabase()) return;
      
      if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
        try {
          await db.collection('appointments').doc(id).delete();
          showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        } catch (error) {
          console.error('‚ùå Error canceling appointment:', error);
          showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
        }
      }
    }

    async function deleteSelectedAppointments() {
      if (!checkDatabase() || selectedAppointments.size === 0) return;
      
      if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ${selectedAppointments.size}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
        try {
          const batch = db.batch();
          selectedAppointments.forEach(id => {
            batch.delete(db.collection('appointments').doc(id));
          });
          await batch.commit();
          selectedAppointments.clear();
          updateBulkActions();
          showAlert('‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        } catch (error) {
          console.error('‚ùå Error deleting appointments:', error);
          showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
        }
      }
    }

    function editAppointment(id) {
      const appointment = appointments.find(app => app.id === id);
      if (!appointment) return;
      
      document.getElementById('editAppointmentId').value = id;
      document.getElementById('editName').value = appointment.name;
      document.getElementById('editAge').value = appointment.age || '';
      document.getElementById('editPhone').value = appointment.phone;
      document.getElementById('editDay').value = appointment.day;
      document.getElementById('editTime').value = appointment.time;
      document.getElementById('editType').value = appointment.patientType || appointment.type;
      document.getElementById('editSerial').value = appointment.serial;
      
      elements.editAppointmentModal.style.display = 'flex';
    }

    async function updateAppointment(e) {
      e.preventDefault();
      
      if (!checkDatabase()) return;
      
      const id = document.getElementById('editAppointmentId').value;
      const updatedData = {
        name: document.getElementById('editName').value,
        age: parseInt(document.getElementById('editAge').value),
        phone: document.getElementById('editPhone').value,
        day: document.getElementById('editDay').value,
        time: document.getElementById('editTime').value,
        patientType: document.getElementById('editType').value,
        serial: parseInt(document.getElementById('editSerial').value),
        updatedAt: new Date()
      };

      try {
        await db.collection('appointments').doc(id).update(updatedData);
        elements.editAppointmentModal.style.display = 'none';
        showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
      } catch (error) {
        console.error('‚ùå Error updating appointment:', error);
        showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
      }
    }

    // ==================== SERIAL MANAGEMENT ====================
    function initializeSerialFilters() {
      elements.dayFilterSerial.addEventListener('change', () => {
        updateSerialTimeFilterOptions();
        loadSerials();
      });
      
      elements.typeFilterSerial.addEventListener('change', () => {
        updateSerialTimeFilterOptions();
        loadSerials();
      });
      
      elements.timeFilterSerial.addEventListener('change', loadSerials);
      
      // Debounced search for serials
      elements.searchSerials.addEventListener('input', (e) => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
          loadSerials(e.target.value);
        }, 300);
      });
    }

    function updateSerialTimeFilterOptions() {
      const dayFilter = elements.dayFilterSerial.value;
      const typeFilter = elements.typeFilterSerial.value;
      const times = new Set();
      
      for (const day in serialRanges) {
        // ‡¶¶‡¶ø‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï
        if (dayFilter !== 'all' && day !== dayFilter) {
          continue;
        }
        
        for (const type in serialRanges[day]) {
          // ‡¶ß‡¶∞‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï
          if (typeFilter !== 'all' && type !== typeFilter) {
            continue;
          }
          
          for (const time in serialRanges[day][type]) {
            times.add(time);
          }
        }
      }
      
      elements.timeFilterSerial.innerHTML = '<option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>';
      
      const sortedTimes = Array.from(times).sort((a, b) => {
        const timeA = a.toUpperCase();
        const timeB = b.toUpperCase();
        const isAM_A = timeA.includes('AM');
        const isAM_B = timeB.includes('AM');
        
        if (isAM_A && !isAM_B) return -1;
        if (!isAM_A && isAM_B) return 1;
        
        const numA = extractTimeNumber(timeA);
        const numB = extractTimeNumber(timeB);
        return numA - numB;
      });
      
      sortedTimes.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        elements.timeFilterSerial.appendChild(option);
      });
    }

    function loadSerials(searchTerm = '') {
      elements.serialsTable.innerHTML = '';
      
      // Get filter values
      const dayFilter = elements.dayFilterSerial.value;
      const typeFilter = elements.typeFilterSerial.value;
      const timeFilter = elements.timeFilterSerial.value;
      const normalizedSearchTerm = searchTerm.toLowerCase().trim();
      
      let serialsFound = false;
      let timeSlots = [];
      
      // Collect all time slots with filtering
      for (const dayKey in serialRanges) {
        // Apply day filter
        if (dayFilter !== 'all' && dayKey !== dayFilter) continue;
        
        for (const type in serialRanges[dayKey]) {
          // Apply type filter
          if (typeFilter !== 'all' && type !== typeFilter) continue;
          
          for (const time in serialRanges[dayKey][type]) {
            // Apply search filter
            if (normalizedSearchTerm && !(
              time.toLowerCase().includes(normalizedSearchTerm) ||
              type.includes(normalizedSearchTerm) ||
              dayKey.toLowerCase().includes(normalizedSearchTerm)
            )) {
              continue;
            }
            
            // Apply time filter
            if (timeFilter !== 'all' && time !== timeFilter) continue;
            
            timeSlots.push({
              day: dayKey,
              type: type,
              time: time,
              range: serialRanges[dayKey][type][time]
            });
          }
        }
      }
      
      // Sort time slots
      timeSlots.sort((a, b) => {
        const timeA = a.time.toUpperCase();
        const timeB = b.time.toUpperCase();
        
        const isAM_A = timeA.includes('AM');
        const isAM_B = timeB.includes('AM');
        
        if (isAM_A && !isAM_B) return -1;
        if (!isAM_A && isAM_B) return 1;
        
        const numA = extractTimeNumber(timeA);
        const numB = extractTimeNumber(timeB);
        
        return numA - numB;
      });
      
      // Display sorted and filtered time slots
      timeSlots.forEach(slot => {
        serialsFound = true;
        const [start, end] = slot.range;
        const dayKey = slot.day;
        const type = slot.type;
        const time = slot.time;
        
        // Count booked appointments for this slot
        const bookedCount = appointments.filter(app => {
          const patientType = app.patientType || app.type;
          return app.day === dayKey && 
                 app.time === time && 
                 patientType === type;
        }).length;
        
        // Count pending serials for this slot
        const currentKey = `${dayKey}_${time}_${type}`;
        const pendingSerials = allPendingSelections[currentKey] || new Set();
        const pendingCount = pendingSerials.size;
        
        const total = end - start + 1;
        const available = total - bookedCount - pendingCount;
        
        const dayText = dayKey === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
        const typeText = type === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${dayText}</td>
          <td>${time}</td>
          <td>${typeText}</td>
          <td>${start} - ${end} (‡¶Æ‡ßã‡¶ü: ${total})</td>
          <td>
            ${pendingCount > 0 ? `<span class="status pending" style="margin-right: 5px;">‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç: ${pendingCount}</span>` : ''}
            <span class="status booked" style="margin-right: 5px;">‡¶¨‡ßÅ‡¶ï‡¶°: ${bookedCount}</span>
            <span class="status available">‡¶ñ‡¶æ‡¶≤‡¶ø: ${available}</span>
          </td>
          <td>
            <button class="action-btn edit-btn" data-day="${dayKey}" data-type="${type}" data-time="${time}">‡¶è‡¶°‡¶ø‡¶ü</button>
            <button class="action-btn cancel-btn" data-day="${dayKey}" data-type="${type}" data-time="${time}">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
          </td>
        `;
        
        // Highlight based on availability
        if (available === 0) {
          row.style.backgroundColor = '#fef2f2'; // Fully booked - light red
        } else if (available === total) {
          row.style.backgroundColor = '#f0fdf4'; // Fully available - light green
        } else if (available < total / 2) {
          row.style.backgroundColor = '#fffbeb'; // Less than half available - light yellow
        }
        
        elements.serialsTable.appendChild(row);
      });
      
      if (!serialsFound) {
        elements.serialsTable.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
              ${searchTerm || dayFilter !== 'all' || typeFilter !== 'all' || timeFilter !== 'all' ? 
                '‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡ßç‡¶≤‡¶ü ‡¶®‡ßá‡¶á' : 
                '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡ßç‡¶≤‡¶ü ‡¶®‡ßá‡¶á‡•§ "‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'
              }
            </td>
          </tr>
        `;
      }
      
      // Add event listeners to edit and delete buttons
      document.querySelectorAll('#serialsTable .edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const day = this.getAttribute('data-day');
          const type = this.getAttribute('data-type');
          const time = this.getAttribute('data-time');
          editSerial(day, type, time);
        });
      });
      
      document.querySelectorAll('#serialsTable .cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const day = this.getAttribute('data-day');
          const type = this.getAttribute('data-type');
          const time = this.getAttribute('data-time');
          deleteSerial(day, type, time);
        });
      });
    }

    function extractTimeNumber(timeStr) {
      const timePart = timeStr.split(' ')[0];
      const [hours, minutes] = timePart.split(':');
      return parseInt(hours) * 100 + (parseInt(minutes) || 0);
    }

    function editSerial(day, type, time) {
      const [start, end] = serialRanges[day][type][time];
      
      document.getElementById('modalTitle').textContent = '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
      document.getElementById('modalDay').value = day;
      document.getElementById('modalTime').value = time;
      document.getElementById('modalType').value = type;
      document.getElementById('modalStart').value = start;
      document.getElementById('modalEnd').value = end;
      
      document.getElementById('modalDay').dataset.originalDay = day;
      document.getElementById('modalType').dataset.originalType = type;
      document.getElementById('modalTime').dataset.originalTime = time;
      
      elements.serialModal.style.display = 'flex';
    }

    async function deleteSerial(day, type, time) {
      if (!checkDatabase()) return;
      
      if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ${day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞'} ${time} ‡¶∏‡¶Æ‡ßü‡ßá‡¶∞ ${type === 'new' ? '‡¶®‡¶§‡ßÅ‡¶®' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶®'} ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
        try {
          delete serialRanges[day][type][time];
          
          if (Object.keys(serialRanges[day][type]).length === 0) {
            delete serialRanges[day][type];
          }
          if (Object.keys(serialRanges[day]).length === 0) {
            delete serialRanges[day];
          }
          
          const success = await saveSerialRanges();
          if (success) {
            loadSerials();
            updateStats();
            showAlert('‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
          }
        } catch (error) {
          console.error('‚ùå Error deleting serial:', error);
          showAlert('‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
        }
      }
    }

    function addNewSerial() {
      document.getElementById('modalTitle').textContent = '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
      elements.serialForm.reset();
      delete document.getElementById('modalDay').dataset.originalDay;
      delete document.getElementById('modalType').dataset.originalType;
      delete document.getElementById('modalTime').dataset.originalTime;
      elements.serialModal.style.display = 'flex';
    }

    async function saveSerial(e) {
      e.preventDefault();
      
      if (!checkDatabase()) return;
      
      const day = document.getElementById('modalDay').value;
      const time = document.getElementById('modalTime').value.trim();
      const type = document.getElementById('modalType').value;
      const start = parseInt(document.getElementById('modalStart').value);
      const end = parseInt(document.getElementById('modalEnd').value);
      
      if (!day || !time || !type || isNaN(start) || isNaN(end)) {
        showAlert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶ò‡¶∞ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
        return;
      }

      if (start > end) {
        showAlert('‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∂‡ßá‡¶∑ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶∞ ‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá ‡¶®‡¶æ', 'error');
        return;
      }

      if (start < 1) {
        showAlert('‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡ßß ‡¶¨‡¶æ ‡¶§‡¶æ‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá', 'error');
        return;
      }

      const isEdit = document.getElementById('modalDay').dataset.originalDay;
      const oldDay = document.getElementById('modalDay').dataset.originalDay;
      const oldType = document.getElementById('modalType').dataset.originalType;
      const oldTime = document.getElementById('modalTime').dataset.originalTime;
      
      if (!isEdit || (oldDay !== day || oldType !== type || oldTime !== time)) {
        if (serialRanges[day] && serialRanges[day][type] && serialRanges[day][type][time]) {
          showAlert('‡¶è‡¶á ‡¶¶‡¶ø‡¶®, ‡¶∏‡¶Æ‡ßü ‡¶è‡¶¨‡¶Ç ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá!', 'error');
          return;
        }
      }

      document.getElementById('submitSerialBtn').innerHTML = '<div class="loading"></div>';
      document.getElementById('submitSerialBtn').disabled = true;

      try {
        if (isEdit) {
          if (oldDay !== day || oldType !== type || oldTime !== time) {
            if (serialRanges[oldDay] && serialRanges[oldDay][oldType] && serialRanges[oldDay][oldType][oldTime]) {
              delete serialRanges[oldDay][oldType][oldTime];
            }
            if (serialRanges[oldDay] && serialRanges[oldDay][oldType] && Object.keys(serialRanges[oldDay][oldType]).length === 0) {
              delete serialRanges[oldDay][oldType];
            }
            if (serialRanges[oldDay] && Object.keys(serialRanges[oldDay]).length === 0) {
              delete serialRanges[oldDay];
            }
          }
        }
        
        if (!serialRanges[day]) serialRanges[day] = {};
        if (!serialRanges[day][type]) serialRanges[day][type] = {};
        
        serialRanges[day][type][time] = [start, end];
        const success = await saveSerialRanges();
        
        if (success) {
          elements.serialModal.style.display = 'none';
          loadSerials();
          updateStats();
          showAlert(isEdit ? '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá' : '‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'success');
        }
        
      } catch (error) {
        console.error('‚ùå Error saving serial:', error);
        showAlert('‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
      } finally {
        document.getElementById('submitSerialBtn').innerHTML = '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®';
        document.getElementById('submitSerialBtn').disabled = false;
      }
    }

    // ==================== QUICK SERIAL ADD ====================
    function setupQuickSerialAdd() {
      // Patient type selection
      document.querySelectorAll('.serial-type-card').forEach(card => {
        card.addEventListener('click', function() {
          document.querySelectorAll('.serial-type-card').forEach(c => {
            c.classList.remove('selected');
          });
          this.classList.add('selected');
          document.getElementById('selectedPatientType').value = this.getAttribute('data-type');
          updateQuickTimeOptions();
        });
      });

      // Day change event
      document.getElementById('quickDay').addEventListener('change', function() {
        updateQuickTimeOptions();
      });

      // Time change event  
      document.getElementById('quickTime').addEventListener('change', function() {
        updateSerialGrid();
      });

      // Quick serial form submission
      document.getElementById('quickSerialForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await addQuickSerial();
      });
    }

    // ==================== PENDING SELECTIONS FOR DASHBOARD ====================
    function loadPendingSelectionsInDashboard() {
      if (!db) return;
      
      const pendingSelectionsListener = db.collection('pendingSelections')
        .where('expiresAt', '>', new Date())
        .onSnapshot(snapshot => {
          allPendingSelections = {};
          let adminPendingFound = false;
          
          snapshot.forEach(doc => {
            const data = doc.data();
            const key = `${data.day}_${data.time}_${data.type}`;
            
            if (!allPendingSelections[key]) {
              allPendingSelections[key] = new Set();
            }
            allPendingSelections[key].add(data.serial);
            
            // Check if this is current admin's pending selection
            if (data.bookedBy === 'admin' && doc.id === currentAdminPendingId) {
              adminPendingFound = true;
            }
          });
          
          console.log('‚úÖ Admin Dashboard: Pending selections loaded', allPendingSelections);
          
          // ‚úÖ Update pending count in dashboard
          updatePendingCountInDashboard();
          
          // If admin's pending selection was deleted by someone else, reset
          if (currentAdminPendingId && !adminPendingFound) {
            console.log('üîÑ Admin pending selection was cleared by another user');
            currentAdminPendingId = null;
            document.getElementById('selectedSerialNumber').value = '';
            
            // Clear visual selection
            document.querySelectorAll('.serial-item.selected').forEach(item => {
              item.classList.remove('selected');
              if (!item.classList.contains('booked') && !item.classList.contains('pending')) {
                item.classList.add('available');
              }
            });
          }
          
          // Update serial table with pending selections
          loadSerials();
          
          // Update quick serial modal if open
          if (document.getElementById('quickSerialModal').style.display === 'flex') {
            updateSerialGrid();
          }
        }, error => {
          console.error('‚ùå Admin Dashboard: Error loading pending selections:', error);
        });

      realtimeListeners.push(pendingSelectionsListener);
    }

    // ==================== SERIAL GRID MANAGEMENT ====================
    function updateSerialGrid() {
      const day = document.getElementById('quickDay').value;
      const time = document.getElementById('quickTime').value;
      const patientType = document.getElementById('selectedPatientType').value;
      
      const serialGrid = document.getElementById('serialGrid');
      serialGrid.innerHTML = '';

      if (!day || !time) {
        serialGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--gray);">‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>';
        return;
      }

      const serialRange = serialRanges[day] && serialRanges[day][patientType] && serialRanges[day][patientType][time];
      
      if (!serialRange) {
        serialGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--gray);">‡¶è‡¶á ‡¶¶‡¶ø‡¶®, ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú ‡¶®‡ßá‡¶á</div>';
        return;
      }

      const [start, end] = serialRange;
      
      // Get booked serials for this slot
      const bookedSerials = appointments
        .filter(app => 
          app.day === day && 
          app.time === time && 
          (app.patientType || app.type) === patientType
        )
        .map(app => app.serial);

      // Get pending serials for this slot
      const currentKey = `${day}_${time}_${patientType}`;
      const pendingSerials = allPendingSelections[currentKey] || new Set();

      // ‚úÖ Get current admin's pending selection
      let adminPendingSerial = null;
      if (currentAdminPendingId) {
        // Find which serial is currently selected by admin
        for (const [key, serials] of Object.entries(allPendingSelections)) {
          if (key === currentKey) {
            serials.forEach(serial => {
              // We'll assume admin's selection is in this slot
              adminPendingSerial = serial;
            });
          }
        }
      }

      // Create serial grid items
      for (let serial = start; serial <= end; serial++) {
        const serialItem = document.createElement('div');
        serialItem.className = 'serial-item';
        serialItem.textContent = serial;
        serialItem.setAttribute('data-serial', serial);

        // 4-color system implementation
        if (bookedSerials.includes(serial)) {
          // Booked - Red
          serialItem.classList.add('booked');
          serialItem.style.cursor = 'not-allowed';
          serialItem.title = '‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';
        } else if (pendingSerials.has(serial)) {
          // Pending - Blue (Selected by users or admin)
          serialItem.classList.add('pending');
          serialItem.style.cursor = 'not-allowed';
          
          // Check if this is admin's own selection
          if (serial === adminPendingSerial) {
            serialItem.classList.remove('pending');
            serialItem.classList.add('selected');
            serialItem.title = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤';
            serialItem.style.cursor = 'pointer';
          } else {
            serialItem.title = '‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßá‡¶â ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®';
          }
        } else {
          // Available - Green
          serialItem.classList.add('available');
          serialItem.style.cursor = 'pointer';
          serialItem.title = '‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ - ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
          
          serialItem.addEventListener('click', async function() {
            await handleSerialSelection(serial, day, time, patientType);
          });
        }
        
        serialGrid.appendChild(serialItem);
      }
    }

    // ‚úÖ Handle serial selection properly
    async function handleSerialSelection(serial, day, time, type) {
      if (!db) return;
      
      try {
        // Remove previous admin pending selection first
        if (currentAdminPendingId) {
          await removeAdminPendingSelection(currentAdminPendingId);
          currentAdminPendingId = null;
        }
        
        // Remove selection from other items
        document.querySelectorAll('.serial-item.selected').forEach(item => {
          item.classList.remove('selected');
          const itemSerial = parseInt(item.getAttribute('data-serial'));
          if (!item.classList.contains('booked') && !item.classList.contains('pending')) {
            item.classList.add('available');
          }
        });
        
        // Add selection to clicked item
        const clickedItem = document.querySelector(`.serial-item[data-serial="${serial}"]`);
        if (clickedItem) {
          clickedItem.classList.remove('available');
          clickedItem.classList.add('selected');
          document.getElementById('selectedSerialNumber').value = serial;
          
          // Save new pending selection and store ID
          currentAdminPendingId = await addAdminPendingSelection(serial, day, time, type);
          
          if (currentAdminPendingId) {
            console.log(`‚úÖ Admin selected serial ${serial}, pending ID: ${currentAdminPendingId}`);
          }
        }
      } catch (error) {
        console.error('‚ùå Error handling serial selection:', error);
        showAlert('‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
      }
    }

    // ‚úÖ Add admin pending selection and return ID
    async function addAdminPendingSelection(serial, day, time, type) {
      if (!db) return null;
      
      try {
        const pendingData = {
          serial: serial,
          day: day,
          time: time,
          type: type,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          expiresAt: new Date(Date.now() + 5 * 60 * 1000), // 5 minutes
          status: 'pending',
          bookedBy: 'admin'
        };
        
        const docRef = await db.collection('pendingSelections').add(pendingData);
        console.log(`‚úÖ Admin pending selection added: ${docRef.id}`);
        return docRef.id;
      } catch (error) {
        console.error('‚ùå Error adding admin pending selection:', error);
        return null;
      }
    }

    // ‚úÖ Remove admin pending selection
    async function removeAdminPendingSelection(pendingId) {
      if (!db || !pendingId) return;
      
      try {
        await db.collection('pendingSelections').doc(pendingId).delete();
        console.log(`‚úÖ Admin pending selection removed: ${pendingId}`);
      } catch (error) {
        console.error('‚ùå Error removing admin pending selection:', error);
      }
    }

    async function addQuickSerial() {
      if (!checkDatabase()) return;

      const day = document.getElementById('quickDay').value;
      const time = document.getElementById('quickTime').value;
      const serial = parseInt(document.getElementById('selectedSerialNumber').value);
      const patientType = document.getElementById('selectedPatientType').value;
      const name = document.getElementById('quickName').value;
      const age = parseInt(document.getElementById('quickAge').value);
      const phone = document.getElementById('quickPhone').value;

      // Validation
      if (!serial) {
        showAlert('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
        return;
      }

      if (!name || !age || !phone) {
        showAlert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
        return;
      }

      if (!validateBangladeshiPhone(phone)) {
        showAlert('‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (01XXXXXXXXX)', 'error');
        return;
      }

      // Check if serial is available
      const isAvailable = await checkSerialAvailability(day, time, serial, patientType);
      if (!isAvailable) {
        showAlert('‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßÅ‡¶ï‡¶°!', 'error');
        return;
      }

      try {
        const appointmentData = {
          name: name,
          age: age,
          phone: phone,
          day: day,
          time: time,
          patientType: patientType,
          serial: serial,
          timestamp: new Date(),
          bookedBy: 'admin'
        };

        await db.collection('appointments').add(appointmentData);
        
        // ‚úÖ Remove pending selection after successful booking
        if (currentAdminPendingId) {
          await removeAdminPendingSelection(currentAdminPendingId);
          currentAdminPendingId = null;
        }
        
        // Reset form and close modal
        document.getElementById('quickSerialForm').reset();
        document.getElementById('quickSerialModal').style.display = 'none';
        
        // Clear visual selection
        document.querySelectorAll('.serial-item.selected').forEach(item => {
          item.classList.remove('selected');
        });
        
        document.getElementById('selectedSerialNumber').value = '';
        
        showAlert('‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
      } catch (error) {
        console.error('‚ùå Error adding quick serial:', error);
        showAlert('‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
      }
    }

    async function checkSerialAvailability(day, time, serial, type) {
      // Check if serial is booked
      const isBooked = appointments.some(app => 
        app.day === day && 
        app.time === time && 
        (app.patientType || app.type) === type && 
        app.serial === serial
      );
      
      if (isBooked) return false;

      // Check if serial is in range
      const range = serialRanges[day] && serialRanges[day][type] && serialRanges[day][type][time];
      if (!range) return false;

      const [start, end] = range;
      return serial >= start && serial <= end;
    }

    function updateQuickTimeOptions() {
      const day = document.getElementById('quickDay').value;
      const patientType = document.getElementById('selectedPatientType').value;
      const times = new Set();
      
      // ‡¶∂‡ßÅ‡¶ß‡ßÅ selected day ‡¶è‡¶¨‡¶Ç type ‡¶è‡¶∞ ‡¶∏‡¶Æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã show ‡¶ï‡¶∞‡¶¨‡ßá
      if (serialRanges[day] && serialRanges[day][patientType]) {
        for (const time in serialRanges[day][patientType]) {
          times.add(time);
        }
      }
      
      const quickTimeSelect = document.getElementById('quickTime');
      quickTimeSelect.innerHTML = '<option value="">-- ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
      
      const sortedTimes = Array.from(times).sort((a, b) => {
        const timeA = a.toUpperCase();
        const timeB = b.toUpperCase();
        const isAM_A = timeA.includes('AM');
        const isAM_B = timeB.includes('AM');
        
        if (isAM_A && !isAM_B) return -1;
        if (!isAM_A && isAM_B) return 1;
        
        const numA = extractTimeNumber(timeA);
        const numB = extractTimeNumber(timeB);
        return numA - numB;
      });
      
      sortedTimes.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        quickTimeSelect.appendChild(option);
      });

      // ‚úÖ ‡¶∏‡¶Æ‡ßü ‡¶Ö‡¶™‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶≤‡ßá ‡¶ó‡ßç‡¶∞‡¶ø‡¶° ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
      updateSerialGrid();
    }

    function updateTimeFilterOptions() {
      const dayFilter = elements.dayFilterAppointments.value;
      const typeFilter = elements.typeFilterAppointments.value;
      const times = new Set();
      
      for (const day in serialRanges) {
        // ‚úÖ ‡¶∂‡ßÅ‡¶ß‡ßÅ selected day ‡¶è‡¶∞ ‡¶∏‡¶Æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã show ‡¶ï‡¶∞‡¶¨‡ßá
        if (dayFilter !== 'all' && day !== dayFilter) continue;
        
        for (const type in serialRanges[day]) {
          // ‚úÖ ‡¶∂‡ßÅ‡¶ß‡ßÅ selected type ‡¶è‡¶∞ ‡¶∏‡¶Æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã show ‡¶ï‡¶∞‡¶¨‡ßá
          if (typeFilter !== 'all' && type !== typeFilter) continue;
          
          for (const time in serialRanges[day][type]) {
            times.add(time);
          }
        }
      }
      
      elements.timeFilterAppointments.innerHTML = '<option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>';
      
      // ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã
      const sortedTimes = Array.from(times).sort((a, b) => {
        const timeA = a.toUpperCase();
        const timeB = b.toUpperCase();
        const isAM_A = timeA.includes('AM');
        const isAM_B = timeB.includes('AM');
        
        if (isAM_A && !isAM_B) return -1;
        if (!isAM_A && isAM_B) return 1;
        
        const numA = extractTimeNumber(timeA);
        const numB = extractTimeNumber(timeB);
        return numA - numB;
      });
      
      sortedTimes.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        elements.timeFilterAppointments.appendChild(option);
      });
    }

   // ==================== EXPORT FUNCTIONS ====================
function setupExportFunctionality() {
  // Export button click
  elements.exportAppointmentsBtn.addEventListener('click', () => {
    elements.exportModal.style.display = 'flex';
  });

  // Export option selection
  document.querySelectorAll('.export-option').forEach(option => {
    option.addEventListener('click', function() {
      const format = this.getAttribute('data-format');
      exportData(format);
    });
  });

  // Close export modal
  elements.closeExportModal.addEventListener('click', () => {
    elements.exportModal.style.display = 'none';
  });
}

// ==================== EXPORT HELPER FUNCTIONS ====================
function getFilteredAppointmentsForExport() {
  const dayFilter = elements.dayFilterAppointments.value;
  const typeFilter = elements.typeFilterAppointments.value;
  const timeFilter = elements.timeFilterAppointments.value;
  const searchTerm = elements.searchAppointments.value.toLowerCase().trim();

  return appointments.filter(app => {
    if (searchTerm && !(
      app.name.toLowerCase().includes(searchTerm) ||
      app.phone.includes(searchTerm) ||
      app.serial.toString().includes(searchTerm)
    )) {
      return false;
    }

    if (dayFilter !== 'all' && app.day !== dayFilter) {
      return false;
    }

    if (typeFilter !== 'all') {
      const patientType = app.patientType || app.type;
      if (patientType !== typeFilter) {
        return false;
      }
    }

    if (timeFilter !== 'all' && app.time !== timeFilter) {
      return false;
    }

    return true;
  });
}

// ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function getDayFilterText() {
  const dayFilter = elements.dayFilterAppointments.value;
  return dayFilter === 'all' ? '‡¶∏‡¶ï‡¶≤ ‡¶¶‡¶ø‡¶®' : 
         (dayFilter === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞');
}

function getTypeFilterText() {
  const typeFilter = elements.typeFilterAppointments.value;
  return typeFilter === 'all' ? '‡¶∏‡¶ï‡¶≤ ‡¶ß‡¶∞‡¶®' : 
         (typeFilter === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ');
}

function getTimeFilterText() {
  const timeFilter = elements.timeFilterAppointments.value;
  return timeFilter === 'all' ? '‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º' : timeFilter;
}

// English ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function getDayFilterTextEnglish() {
  const dayFilter = elements.dayFilterAppointments.value;
  return dayFilter === 'all' ? 'All Days' : dayFilter;
}

function getTypeFilterTextEnglish() {
  const typeFilter = elements.typeFilterAppointments.value;
  return typeFilter === 'all' ? 'All Types' : 
         (typeFilter === 'new' ? 'New Patient' : 'Old Patient');
}

function getTimeFilterTextEnglish() {
  const timeFilter = elements.timeFilterAppointments.value;
  return timeFilter === 'all' ? 'All Times' : timeFilter;
}

// ==================== ADVANCED EXPORT FUNCTIONS ====================
function exportData(format) {
  const filteredAppointments = getFilteredAppointmentsForExport();

  if (filteredAppointments.length === 0) {
    showAlert('‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á', 'error');
    elements.exportModal.style.display = 'none';
    return;
  }

  console.log(`üìä Exporting ${filteredAppointments.length} appointments in ${format} format`);

  switch (format) {
    case 'pdf':
      exportToPDF(filteredAppointments);
      break;
    
    case 'excel':
      exportToExcel(filteredAppointments);
      break;
    
    case 'word':
      exportToWord(filteredAppointments);
      break;

    case 'docs':
      // Use HTML format for best Google Docs compatibility
      exportToHTMLDocs(filteredAppointments);
      break;
  }
  
  elements.exportModal.style.display = 'none';
}

// PDF ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü - English for better compatibility
function exportToPDF(appointments) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);
    
    // ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ - English
    doc.setFontSize(16);
    doc.setTextColor(40, 40, 150);
    doc.text('Doctor Appointment Report', 105, 20, { align: 'center' });
    
    // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º
    doc.setFontSize(10);
    doc.setTextColor(80, 80, 80);
    doc.text(`Generated Date: ${new Date().toLocaleDateString('en-BD')} | Time: ${new Date().toLocaleTimeString('en-BD')}`, 14, 30);
    
    // ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ - English
    doc.setFontSize(10);
    const summaryLines = [
      `‚Ä¢ Total Appointments: ${sortedAppointments.length}`,
      `‚Ä¢ Day: ${getDayFilterTextEnglish()}`,
      `‚Ä¢ Type: ${getTypeFilterTextEnglish()}`,
      `‚Ä¢ Filtered Time: ${getTimeFilterTextEnglish()}`
    ];
    
    let yPosition = 40;
    summaryLines.forEach((text, index) => {
      doc.text(text, 14, yPosition);
      yPosition += 6;
    });
    
    // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ - English
    const headers = [['Serial', 'Patient Name', 'Age', 'Phone', 'Time', 'Booking Date']];
    
    // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ
    const data = sortedAppointments.map(app => [
      app.serial.toString(),
      app.name,
      app.age ? app.age.toString() + ' Years' : 'N/A',
      app.phone,
      app.time,
      app.timestamp ? 
        new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
        new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : 'N/A'
    ]);
    
    // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø
    doc.autoTable({
      head: headers,
      body: data,
      startY: 65,
      styles: { 
        font: 'helvetica',
        fontSize: 9,
        cellPadding: 3
      },
      headStyles: { 
        fillColor: [41, 128, 185],
        textColor: 255,
        fontStyle: 'bold'
      },
      alternateRowStyles: {
        fillColor: [245, 245, 245]
      }
    });
    
    // ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞
    const pageCount = doc.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text(`Page ${i} / ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
    }
    
    // ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶≠
    const fileName = `appointments_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    showAlert(`${sortedAppointments.length}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü PDF ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
    
  } catch (error) {
    console.error('PDF export error:', error);
    showAlert('PDF ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
  }
}

// Excel ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü - Real Excel (.xlsx) with English
function exportToExcel(appointments) {
  try {
    // ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);
    
    // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ - English ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡¶π
    const data = sortedAppointments.map(app => ({
      'Serial No': app.serial,
      'Patient Name': app.name,
      'Age': app.age || 'N/A',
      'Phone Number': app.phone,
      'Time': app.time,
      'Booking Date': app.timestamp ? 
        new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
        new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : 'N/A'
    }));
    
    // ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶∂‡¶ø‡¶ü ‡¶§‡ßà‡¶∞‡¶ø
    const ws = XLSX.utils.json_to_sheet(data);
    
    // ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ width ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    const colWidths = [
      { wch: 10 }, // Serial
      { wch: 20 }, // Name
      { wch: 8 },  // Age
      { wch: 15 }, // Phone
      { wch: 12 }, // Time
      { wch: 20 }  // Booking Date
    ];
    ws['!cols'] = colWidths;
    
    // ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶¨‡ßÅ‡¶ï ‡¶§‡ßà‡¶∞‡¶ø
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Appointments');
    
    // ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
    const fileName = `appointments_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showAlert(`${sortedAppointments.length}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü Excel ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
    
  } catch (error) {
    console.error('Excel export error:', error);
    showAlert('Excel ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
  }
}

// Word/Docs ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü - Compatible with Google Docs
function exportToWord(appointments) {
  try {
    // ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);

    let wordContent = `
<meta charset="UTF-8">
<html>
<body>
  <h1 style="text-align: center; color: #2563eb; margin-bottom: 10px;">Doctor Appointment Report</h1>
  
  <!-- ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º -->
  <p style="text-align: center; color: #666; margin-bottom: 15px;">
    <strong>Generated Date:</strong> ${new Date().toLocaleDateString('en-BD')} | 
    <strong>Time:</strong> ${new Date().toLocaleTimeString('en-BD')}
  </p>
  
  <!-- ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ - ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã -->
  <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
    <strong>Summary:</strong><br>
    ‚Ä¢ Total Appointments: ${sortedAppointments.length}<br>
    ‚Ä¢ Day: ${getDayFilterTextEnglish()}<br>
    ‚Ä¢ Type: ${getTypeFilterTextEnglish()}<br>
    ‚Ä¢ Filtered Time: ${getTimeFilterTextEnglish()}
  </div>

  <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; font-size: 12px;">
    <tr style="background-color: #2563eb; color: white; font-weight: bold;">
      <th>Serial</th>
      <th>Patient Name</th>
      <th>Age</th>
      <th>Phone</th>
      <th>Time</th>
      <th>Booking Date</th>
    </tr>
    ${sortedAppointments.map(app => {
      const age = app.age ? app.age + ' Years' : 'N/A';
      const bookingDate = app.timestamp ? 
        new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
        new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : 'N/A';
      
      return `
    <tr>
      <td>${app.serial}</td>
      <td>${app.name}</td>
      <td>${age}</td>
      <td>${app.phone}</td>
      <td>${app.time}</td>
      <td>${bookingDate}</td>
    </tr>`;
    }).join('')}
  </table>
  
  <p style="margin-top: 20px; color: #666; font-size: 11px; text-align: center;">
    Generated by Admin Dashboard | ${new Date().getFullYear()}
  </p>
</body>
</html>`;

    const blob = new Blob([wordContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `appointments_${new Date().toISOString().split('T')[0]}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showAlert(`${sortedAppointments.length}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü Word ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`, 'success');
    
  } catch (error) {
    console.error('Word export error:', error);
    showAlert('Word ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
  }
}

// ==================== REAL DOCX EXPORT ====================
function exportToHTMLDocs(appointments) {
  try {
    const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);
    
    const htmlContent = `
<meta charset="UTF-8">
<html>
<head>
  <style>
    @page {
      size: A4;
      margin: 1cm;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      width: 210mm;
      height: 297mm;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #000;
      padding: 6px;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center; color: #2563eb; margin-bottom: 10px; font-size: 16px;">Doctor Appointment Report</h1>
  
  <p style="text-align: center; color: #666; margin-bottom: 15px; font-size: 12px;">
    <strong>Generated Date:</strong> ${new Date().toLocaleDateString('en-BD')} | 
    <strong>Time:</strong> ${new Date().toLocaleTimeString('en-BD')}
  </p>
  
  <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2563eb; font-size: 11px;">
    <strong>Summary:</strong><br>
    ‚Ä¢ Total Appointments: ${sortedAppointments.length}<br>
    ‚Ä¢ Day: ${getDayFilterTextEnglish()}<br>
    ‚Ä¢ Type: ${getTypeFilterTextEnglish()}<br>
    ‚Ä¢ Filtered Time: ${getTimeFilterTextEnglish()}
  </div>

  <table>
    <tr style="background-color: #2563eb; color: white; font-weight: bold;">
      <th style="width: 8%">Serial</th>
      <th style="width: 30%">Patient Name</th>
      <th style="width: 12%">Age</th>
      <th style="width: 15%">Phone</th>
      <th style="width: 12%">Time</th>
      <th style="width: 23%">Booking Date</th>
    </tr>
    ${sortedAppointments.map(app => {
      const age = app.age ? app.age + ' Years' : 'N/A';
      const bookingDate = app.timestamp ? 
        new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
        new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit'}) : 'N/A';
      
      return `
    <tr>
      <td style="width: 8%">${app.serial}</td>
      <td style="width: 30%">${app.name}</td>
      <td style="width: 12%">${age}</td>
      <td style="width: 15%">${app.phone}</td>
      <td style="width: 12%">${app.time}</td>
      <td style="width: 23%">${bookingDate}</td>
    </tr>`;
    }).join('')}
  </table>
  
  <p style="margin-top: 15px; color: #666; font-size: 10px; text-align: center;">
    Generated by Admin Dashboard | ${new Date().getFullYear()}
  </p>
</body>
</html>`;

    // Create HTML file
    const blob = new Blob([htmlContent], { 
      type: 'text/html; charset=utf-8'
    });
    
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `appointments_${new Date().toISOString().split('T')[0]}.html`;
    
    link.click();
    
    showAlert(`
      <div style="text-align: left;">
        <strong>‚úÖ ‡¶°‡¶ï‡ßç‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!</strong><br><br>
        <strong>Google Docs ‡¶è ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶§‡ßá:</strong><br>
        1. Google Docs ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®<br>
        2. File ‚Üí Import ‚Üí Upload<br>
        3. ‡¶è‡¶á HTML ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®<br>
        4. Insert ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
      </div>
    `, 'success', 8000);
    
    setTimeout(() => URL.revokeObjectURL(url), 5000);
    
  } catch (error) {
    console.error('Docs export error:', error);
    showAlert('‡¶°‡¶ï‡ßç‡¶∏ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
  }
}

     // ==================== EVENT LISTENERS ====================
    function initializeEventListeners() {
      // Mobile menu
      elements.mobileMenuBtn.addEventListener('click', () => {
        elements.sidebar.classList.toggle('mobile-open');
      });

      // Close sidebar when clicking outside on mobile
      document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
          if (!elements.sidebar.contains(e.target) && !elements.mobileMenuBtn.contains(e.target)) {
            elements.sidebar.classList.remove('mobile-open');
          }
        }
      });

      // Debounced search
      elements.searchAppointments.addEventListener('input', (e) => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
          loadAppointments(e.target.value);
          updateStats(); // Update counts when searching
        }, 300);
      });

      // Filters - update both table and counts
      elements.dayFilterAppointments.addEventListener('change', () => {
        updateTimeFilterOptions();
        loadAppointments();
        updateStats();
      });
      elements.typeFilterAppointments.addEventListener('change', () => {
        updateTimeFilterOptions();
        loadAppointments();
        updateStats();
      });
      elements.timeFilterAppointments.addEventListener('change', () => {
        loadAppointments();
        updateStats();
      });

      // Serial management
      elements.addSerialBtn.addEventListener('click', addNewSerial);

      // Initialize serial filters
      initializeSerialFilters();

      // Modal close buttons
      elements.closeModal.addEventListener('click', () => {
        elements.serialModal.style.display = 'none';
      });
      elements.cancelModal.addEventListener('click', () => {
        elements.serialModal.style.display = 'none';
      });
      elements.closeQuickModal.addEventListener('click', async () => {
        // ‚úÖ Remove pending selection when modal closes
        if (currentAdminPendingId) {
          await removeAdminPendingSelection(currentAdminPendingId);
          currentAdminPendingId = null;
        }
        elements.quickSerialModal.style.display = 'none';
      });
      elements.cancelQuickModal.addEventListener('click', async () => {
        // ‚úÖ Remove pending selection when modal closes
        if (currentAdminPendingId) {
          await removeAdminPendingSelection(currentAdminPendingId);
          currentAdminPendingId = null;
        }
        elements.quickSerialModal.style.display = 'none';
      });
      elements.closeEditModal.addEventListener('click', () => {
        elements.editAppointmentModal.style.display = 'none';
      });
      elements.cancelEditModal.addEventListener('click', () => {
        elements.editAppointmentModal.style.display = 'none';
      });
      elements.closeExportModal.addEventListener('click', () => {
        elements.exportModal.style.display = 'none';
      });

      // Form submissions
      elements.serialForm.addEventListener('submit', saveSerial);
      elements.editAppointmentForm.addEventListener('submit', updateAppointment);

      // Quick serial add
      elements.addSerialQuickBtn.addEventListener('click', () => {
        document.getElementById('quickSerialModal').style.display = 'flex';
        // ‚úÖ ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶® ‡¶π‡¶≤‡ßá ‡¶ó‡ßç‡¶∞‡¶ø‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        setTimeout(() => {
          updateSerialGrid();
        }, 100);
      });

      // Setup quick serial
      setupQuickSerialAdd();

      // Bulk actions
      elements.selectAllHeader.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.appointment-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
          if (this.checked) {
            selectedAppointments.add(checkbox.value);
          } else {
            selectedAppointments.delete(checkbox.value);
          }
        });
        updateBulkActions();
      });

      elements.selectAll.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.appointment-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
          if (this.checked) {
            selectedAppointments.add(checkbox.value);
          } else {
            selectedAppointments.delete(checkbox.value);
          }
        });
        updateBulkActions();
      });

      elements.deleteSelected.addEventListener('click', deleteSelectedAppointments);
      elements.clearSelection.addEventListener('click', () => {
        selectedAppointments.clear();
        document.querySelectorAll('.appointment-checkbox').forEach(cb => cb.checked = false);
        elements.selectAllHeader.checked = false;
        elements.selectAll.checked = false;
        updateBulkActions();
      });

      // Export functionality
      setupExportFunctionality();

      // Logout
      elements.logoutBtn.addEventListener('click', handleLogout);

      // Modal close on outside click
      window.addEventListener('click', (e) => {
        if (e.target === elements.serialModal) elements.serialModal.style.display = 'none';
        if (e.target === elements.quickSerialModal) elements.quickSerialModal.style.display = 'none';
        if (e.target === elements.editAppointmentModal) elements.editAppointmentModal.style.display = 'none';
        if (e.target === elements.exportModal) elements.exportModal.style.display = 'none';
      });
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAuthentication()) {
        return; 
    }
      initializeFirebase();
      initializeEventListeners();
      
      setTimeout(() => {
        initDashboard();
      }, 1000);
    });
  </script>
</body>
</html>