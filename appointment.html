<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="q6qnX2SH5llFty6Oy1rgN5_49L_ChMSuhR4jn8mZJNE" />
  <title>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Required Libraries for PDF/PNG Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --info: #3b82f6;
      --gray: #6b7280;
      --light-gray: #f3f4f6;
      --white: #ffffff;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans Bengali', sans-serif;
      background: linear-gradient(135deg, #f0f8ff, #e1f5fe);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 640px;
      margin: 20px auto;
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      position: relative;
    }
    
    .header {
      background: var(--primary);
      color: var(--white);
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    .header h2 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }
    
    .header::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 0;
      right: 0;
      height: 20px;
      background: var(--white);
      clip-path: ellipse(50% 50% at 50% 50%);
    }
    
    form {
      padding: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .input-field {
      position: relative;
    }
    
    input, select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Noto Sans Bengali', sans-serif;
      transition: all 0.2s ease;
      background-color: var(--white);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    input::placeholder {
      color: var(--gray);
      opacity: 0.6;
    }
    
    .error-msg {
      color: var(--danger);
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    
    .info-text {
      color: var(--gray);
      font-size: 13px;
      margin-top: 5px;
      display: block;
    }
    
    .no-slots-message {
      background-color: #fef3c7;
      color: var(--warning);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    
    .no-day-message {
      background-color: #fef3c7;
      color: var(--warning);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    
    .loading-message {
      background-color: #dbeafe;
      color: var(--primary);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 15px;
      display: none;
    }

    /* Custom Popup Modal */
    .popup-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: popupIn 0.3s ease-out;
    }

    @keyframes popupIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .popup-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .popup-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #1f2937;
    }

    .popup-message {
      font-size: 16px;
      margin-bottom: 20px;
      color: #6b7280;
      line-height: 1.5;
      text-align: left;
    }

    .popup-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .popup-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .popup-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }

    .popup-btn.cancel {
      background: var(--gray);
    }

    .popup-btn.cancel:hover {
      background: #4b5563;
    }

    .popup-btn.success {
      background: var(--success);
    }

    .popup-btn.success:hover {
      background: #15803d;
    }

    .popup-btn.warning {
      background: var(--warning);
    }

    .popup-btn.warning:hover {
      background: #d97706;
    }

    /* Fixed Super Compact Slip - No Scroll, All Devices Friendly */
    .confirmation-slip {
        background: white;
        border: 2px solid #2563eb;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        text-align: center;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        max-width: 280px;
    }

    .slip-header {
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 8px;
        margin-bottom: 10px;
    }

    .slip-header h3 {
        color: #2563eb;
        font-size: 14px;
        margin-bottom: 3px;
        font-weight: 700;
    }

    .slip-header p {
        color: #6b7280;
        font-size: 12px;
        margin: 0;
    }

    .slip-details {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
        margin-bottom: 12px;
        font-size: 12px;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail-label {
        font-weight: 600;
        color: #374151;
        text-align: left;
        flex: 1;
        min-width: 60px;
    }

    .detail-value {
        color: #1f2937;
        text-align: right;
        flex: 1;
        font-weight: 500;
        min-width: 100px;
    }

    .serial-number {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 20px;
        font-weight: 700;
        border: 2px solid #3b82f6;
    }

    .slip-footer {
        border-top: 1px solid #e5e7eb;
        padding-top: 8px;
        color: #6b7280;
        font-size: 10px;
        line-height: 1.3;
        margin-top: 8px;
    }

    /* Download Buttons CSS */
    .download-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .download-btn {
        background: #16a34a;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        min-width: 120px;
        justify-content: center;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .download-btn:hover {
        background: #15803d;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .download-btn.pdf {
        background: #dc2626;
    }

    .download-btn.pdf:hover {
        background: #b91c1c;
    }

    /* Mobile First Design for Slip */
    @media (max-width: 480px) {
        .confirmation-slip {
            max-width: 100%;
            padding: 12px;
        }
        
        .slip-details {
            gap: 4px;
            font-size: 11px;
        }
        
        .detail-item {
            padding: 2px 0;
        }
        
        .serial-number {
            font-size: 18px;
            padding: 10px;
        }
        
        .slip-footer {
            font-size: 9px;
            padding-top: 6px;
            margin-top: 6px;
        }
        
        .download-buttons {
            flex-direction: column;
            gap: 6px;
        }
        
        .download-btn {
            min-width: 100%;
            padding: 10px;
            font-size: 13px;
        }
    }

    /* Serial Selection Section */
    .serial-section {
      margin-top: 30px;
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
    }
    
    .serial-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .serial-header h3 {
      font-size: 18px;
      color: #1f2937;
    }
    
    .legend {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      font-size: 13px;
    }
    
    .legend-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .available-dot { background-color: var(--success); }
    .booked-dot { background-color: var(--danger); }
    .selected-dot { background-color: var(--warning); }
    .pending-dot { background-color: var(--info); }
    
    .serial-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .serial-slot {
      padding: 10px 0;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      user-select: none;
      font-size: 14px;
      position: relative;
    }
    
    .available {
      background-color: #dcfce7;
      color: var(--success);
      border: 2px solid var(--success);
    }
    
    .available:hover {
      background-color: #bbf7d0;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(34, 197, 94, 0.2);
    }
    
    .booked {
      background-color: #fecaca;
      color: var(--danger);
      border: 2px solid var(--danger);
      cursor: not-allowed;
      opacity: 0.8;
    }
    
    .selected {
      background-color: #fef3c7;
      color: var(--warning);
      border: 2px solid var(--warning);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      font-weight: 700;
    }
    
    .pending {
      background-color: #dbeafe;
      color: var(--info);
      border: 2px solid var(--info);
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    /* Submit Button */
    .submit-btn {
      width: 100%;
      padding: 14px;
      background-color: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 30px;
      transition: all 0.2s ease;
      font-family: 'Noto Sans Bengali', sans-serif;
    }
    
    .submit-btn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
    }
    
    .submit-btn:active {
      transform: translateY(0);
    }
    
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .success-message {
      background-color: #dcfce7;
      color: var(--success);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-top: 20px;
      display: none;
    }

    .helpline {
    /* ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡¶ï‡ßá DIV ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá */
    text-align: center; 
    
    /* ‡¶â‡¶™‡¶∞ ‡¶•‡ßá‡¶ï‡ßá 20 ‡¶™‡¶ø‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶æ‡¶Æ‡¶æ‡¶¨‡ßá (‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶Æ‡¶æ‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®) */
    padding-top: 20px; 
    
    /* ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡¶¶‡¶ø DIV ‡¶ï‡ßá ‡¶Ö‡¶®‡ßÅ‡¶≠‡ßÇ‡¶Æ‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá (horizontally) ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• (width) ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶™‡¶æ‡¶∞‡ßç‡¶ü‡¶ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§ ‡¶Ø‡¶¶‡¶ø‡¶ì text-align ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡¶ï‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶∏‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü‡•§ */
    /* width: 50%; */
    /* margin: 0 auto; */
}

/* ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶≠‡ßá‡¶§‡¶∞‡ßá‡¶∞ LABEL ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶®‡¶ü‡¶ø‡¶ï‡ßá‡¶ì ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®, ‡¶§‡¶¨‡ßá ‡¶è‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶® */
.helpline label {
    /* ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá */
    /* font-size: 16px; */
    /* color: #333; */
}
    
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .container {
        margin: 10px auto;
        border-radius: 0;
      }
      
      form {
        padding: 20px;
      }
      
      .serial-grid {
        grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
        gap: 8px;
      }
      
      .legend {
        flex-direction: column;
        gap: 8px;
      }

      .popup-content {
        padding: 20px;
        margin: 20px;
      }

      .slip-details {
        grid-template-columns: 1fr;
      }

      .popup-buttons {
        flex-direction: column;
      }

      .download-buttons {
        flex-direction: column;
      }
    }
    
    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-group {
      animation: fadeIn 0.3s ease forwards;
    }
    
    .form-group:nth-child(1) { animation-delay: 0.1s; }
    .form-group:nth-child(2) { animation-delay: 0.2s; }
    .form-group:nth-child(3) { animation-delay: 0.3s; }
    .form-group:nth-child(4) { animation-delay: 0.4s; }
    .form-group:nth-child(5) { animation-delay: 0.5s; }
    .form-group:nth-child(6) { animation-delay: 0.6s; }
    .serial-section { animation: fadeIn 0.3s ease 0.7s forwards; opacity: 0; }
  </style>
</head>
<body>
  </header>
  <!-- Unified Popup Modal -->
  <div class="popup-modal" id="universalPopup">
    <div class="popup-content">
      <div class="popup-icon" id="popupIcon">‚ö†Ô∏è</div>
      <div class="popup-title" id="popupTitle">‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</div>
      <div class="popup-message" id="popupMessage">
        ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá
      </div>
      <!-- Confirmation Slip for Download -->
      <div class="confirmation-slip" id="confirmationSlip" style="display: none;">
        <div class="slip-header">
          <h3>üè• ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
          <p>‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶≤‡¶ø‡¶™</p>
        </div>
        <div class="slip-details">
          <div class="detail-item">
            <div class="detail-label">‡¶®‡¶æ‡¶Æ:</div>
            <div class="detail-value" id="slipName">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶¨‡ßü‡¶∏:</div>
            <div class="detail-value" id="slipAge">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶´‡ßã‡¶®:</div>
            <div class="detail-value" id="slipPhone">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶ß‡¶∞‡¶®:</div>
            <div class="detail-value" id="slipType">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶¶‡¶ø‡¶®:</div>
            <div class="detail-value" id="slipDay">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶∏‡¶Æ‡ßü:</div>
            <div class="detail-value" id="slipTime">-</div>
          </div>
        </div>
        <div class="serial-number" id="slipSerial">#‡ß¶</div>
        <div class="slip-footer">
          ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶∏‡¶Æ‡ßü: <span id="slipDateTime">-</span> | ‡¶è‡¶á ‡¶∏‡ßç‡¶≤‡¶ø‡¶™‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶∏‡¶æ‡¶•‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶∏‡ßÅ‡¶®
        </div>
      </div>
      <div class="popup-buttons" id="popupButtons">
        <button class="popup-btn cancel" onclick="closePopup()">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
      <!-- Download Buttons for Confirmation Slip -->
      <div class="download-buttons" id="downloadButtons" style="display: none;">
        <button class="download-btn" onclick="downloadPNG()">
          üì∏ PNG ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        </button>
        <button class="download-btn pdf" onclick="downloadPDF()">
          üìÑ PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        </button>
      </div>
    </div>
  </div>

  <!-- Appointment Form -->
  <div class="container">
    <div class="header">
      <h2>‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ</h2>
    </div>
    
    <form id="appointmentForm" novalidate>
      <div class="form-group">
        <label for="name">‡¶®‡¶æ‡¶Æ</label>
        <div class="input-field">
          <input type="text" id="name" name="name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required
            pattern="[a-zA-Z\u0980-\u09FF\.\s]{3,50}" 
            title="‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ/‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞, ‡¶°‡¶ü (.) ‡¶ì ‡¶∏‡ßç‡¶™‡ßá‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (3-50 ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)">
        </div>
        <small id="nameError" class="error-msg">‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ö‡¶ø‡¶π‡ßç‡¶® ‡¶¨‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ)</small>
      </div>

      <div class="form-group">
        <label for="age">‡¶¨‡¶Ø‡¶º‡¶∏</label>
        <div class="input-field">
          <input type="number" id="age" name="age" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required min="1" max="120">
        </div>
        <small id="ageError" class="error-msg">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¨‡ßü‡¶∏ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (0-120)</small>
      </div>

      <div class="form-group">
        <label for="phone">‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
        <div class="input-field">
          <input type="tel" id="phone" name="phone" placeholder="01XXXXXXXXX" required pattern="01[0-9]{9}"
            title="‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
        </div>
        <small id="phoneError" class="error-msg">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (01XXXXXXXXX)</small>
        <small class="info-text">‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßá ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶á ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨</small>
      </div>

      <div class="form-group">
        <label for="patientType">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶ß‡¶∞‡¶®</label>
        <div class="input-field">
          <select id="patientType" name="patientType" required>
            <option value="">-- ‡¶ß‡¶∞‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
            <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
          </select>
          <small class="info-text">‡ß¶-‡ßØ‡ß¶ ‡¶¶‡¶ø‡¶® ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ó‡¶£‡ßç‡¶Ø ‡¶π‡¶¨‡ßá</small>
        </div>
      </div>

      <div class="form-group">
        <label for="day">‡¶¶‡¶ø‡¶®</label>
        <div class="input-field">
          <select id="day" name="day" required>
            <option value="">-- ‡¶¶‡¶ø‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
            <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="time">‡¶∏‡¶Æ‡ßü</label>
        <div class="input-field">
          <select id="time" name="time" required disabled>
            <option value="">-- ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
          </select>
          <small class="info-text">‡¶ö‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡¶Ø‡¶º</small>
        </div>
      </div>

      <!-- Hidden messages (kept for backup) -->
      <div class="no-day-message" id="noDayMessage" style="display: none;">
        ‚ö†Ô∏è ‡¶è‡¶á ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡ß¶‡ßß‡ß≠‡ß≠‡ß≠‡ßÆ‡ßÆ‡ßÆ‡ß™‡ßÆ‡ßØ ‡¶ï‡¶∞‡ßÅ‡¶® ‡•§
      </div>

      <div class="serial-section">
        <div class="serial-header">
          <h3>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
          <div class="legend">
            <div class="legend-item">
              <span class="legend-dot available-dot"></span>
              <span>‡¶ñ‡¶æ‡¶≤‡¶ø</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot pending-dot"></span>
              <span>‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° (‡¶Ö‡¶®‡ßç‡¶Ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞)</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot selected-dot"></span>
              <span>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot booked-dot"></span>
              <span>‡¶¨‡ßÅ‡¶ï‡¶°</span>
            </div>
          </div>
        </div>
        
        <div class="loading-message" id="loadingMessage">
          üîÑ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
        </div>
        
        <div class="serial-grid" id="serialGrid">
          <!-- ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá -->
        </div>
        
        <!-- Hidden no slots message -->
        <div class="no-slots-message" id="noSlotsMessage" style="display: none;">
          ‚ö†Ô∏è ‡¶è‡¶á ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Æ‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
        </div>
        
        <input type="hidden" name="serial" id="serialInput" required>
        <small id="serialError" class="error-msg">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</small>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      
      <!-- Hidden success message -->
      <div class="success-message" id="successMessage" style="display: none;">
        ‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!
      </div>
      <div class="helpline">
      <label for="day">‡¶π‡ßá‡¶≤‡ßç‡¶™ ‡¶≤‡¶æ‡¶á‡¶® ‡ß¶‡ßß‡ß≠‡ß≠‡ß≠‡ßÆ‡ßÆ‡ßÆ‡ß™‡ßÆ‡ßØ</label>
      </div>
    </form>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCUGkcHFSYVmA0KUSRHhY-ZFFAS6jpJe4M",
      authDomain: "doctor-appointment-syste-23828.firebaseapp.com",
      projectId: "doctor-appointment-syste-23828",
      storageBucket: "doctor-appointment-syste-23828.appspot.com",
      messagingSenderId: "79600391014",
      appId: "1:79600391014:web:9688db8bb62f431ae16ea7"
    };

    // Global db variable
    let db;

    // Firebase initialization with better error handling
    function initializeFirebase() {
      try {
        // Check if Firebase is already initialized
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        console.log("‚úÖ Firebase initialized successfully in appointment form");
        return true;
      } catch (error) {
        console.error("‚ùå Firebase initialization error in appointment form:", error);
        return false;
      }
    }

    // Initialize Firebase immediately
    initializeFirebase();

    // ==================== APP CONSTANTS AND VARIABLES ====================
    let serialRanges = {};
    let appointments = [];
    let realtimeListeners = [];
    let currentUserSelection = null;
    let currentUserPendingId = null;
    let currentAppointmentData = null;

    // DOM Elements
    const daySelect = document.getElementById('day');
    const typeSelect = document.getElementById('patientType');
    const timeSelect = document.getElementById('time');
    const serialGrid = document.getElementById('serialGrid');
    const serialInput = document.getElementById('serialInput');
    const nameInput = document.getElementById('name');
    const nameError = document.getElementById('nameError');
    const ageInput = document.getElementById('age');
    const ageError = document.getElementById('ageError');
    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phoneError');
    const serialError = document.getElementById('serialError');
    const submitBtn = document.getElementById('submitBtn');
    const successMessage = document.getElementById('successMessage');
    const noSlotsMessage = document.getElementById('noSlotsMessage');
    const noDayMessage = document.getElementById('noDayMessage');
    const loadingMessage = document.getElementById('loadingMessage');

    // Popup Elements
    const universalPopup = document.getElementById('universalPopup');
    const popupIcon = document.getElementById('popupIcon');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');
    const popupButtons = document.getElementById('popupButtons');
    const confirmationSlip = document.getElementById('confirmationSlip');
    const downloadButtons = document.getElementById('downloadButtons');

    // Slip Elements
    const slipName = document.getElementById('slipName');
    const slipAge = document.getElementById('slipAge');
    const slipPhone = document.getElementById('slipPhone');
    const slipType = document.getElementById('slipType');
    const slipDay = document.getElementById('slipDay');
    const slipTime = document.getElementById('slipTime');
    const slipSerial = document.getElementById('slipSerial');
    const slipDateTime = document.getElementById('slipDateTime');

    // ==================== UNIFIED POPUP SYSTEM ====================
    function showPopup(type, title, message, options = {}) {
      // Reset popup state
      confirmationSlip.style.display = 'none';
      downloadButtons.style.display = 'none';
      popupButtons.innerHTML = '';

      // Set icon based on type
      const icons = {
        warning: '‚ö†Ô∏è',
        error: '‚ùå',
        success: '‚úÖ',
        info: '‚ÑπÔ∏è',
        confirm: '‚ùì'
      };

      popupIcon.textContent = icons[type] || '‚ö†Ô∏è';
      popupTitle.textContent = title;
      popupMessage.innerHTML = message;

      // Set button colors based on type
      const buttonColors = {
        warning: 'warning',
        error: 'cancel',
        success: 'success',
        info: 'primary',
        confirm: 'primary'
      };

      // Add buttons based on options
      if (options.showConfirm) {
        popupButtons.innerHTML = `
          <button class="popup-btn ${buttonColors[type]}" id="confirmYes">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å</button>
          <button class="popup-btn cancel" id="confirmNo">‡¶®‡¶æ</button>
        `;
        
        // Add event listeners for confirm buttons
        setTimeout(() => {
          document.getElementById('confirmYes').onclick = function() {
            if (window.popupResolve) {
              window.popupResolve(true);
            }
            closePopup();
          };
          
          document.getElementById('confirmNo').onclick = function() {
            if (window.popupResolve) {
              window.popupResolve(false);
            }
            closePopup();
          };
        }, 0);
        
      } else if (type === 'success' && options.showSlip) {
        popupButtons.innerHTML = `
          <button class="popup-btn success" onclick="resetFormAndClosePopup()">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
        `;
      } else if (type === 'success') {
        popupButtons.innerHTML = `
          <button class="popup-btn success" onclick="resetFormAndClosePopup()">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
        `;
      } else {
        popupButtons.innerHTML = `
          <button class="popup-btn ${buttonColors[type]}" onclick="closePopup()">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
        `;
      }

      // Show confirmation slip if requested
      if (options.showSlip && currentAppointmentData) {
        showConfirmationSlip(currentAppointmentData);
      }

      universalPopup.style.display = 'flex';
  
      // Return promise for confirm dialogs
      if (options.showConfirm) {
        return new Promise((resolve) => {
          window.popupResolve = resolve;
        });
      }
    }

    function closePopup() {
      universalPopup.style.display = 'none';
      // Clear any pending resolve function
      if (window.popupResolve) {
        window.popupResolve = null;
      }
    }

    // Close popup when clicking outside
    universalPopup.addEventListener('click', function(e) {
      if (e.target === universalPopup) {
        closePopup();
      }
    });

    // Form reset ‡¶è‡¶¨‡¶Ç popup close
    function resetFormAndClosePopup() {
      // Form reset ‡¶ï‡¶∞‡ßÅ‡¶®
      document.getElementById('appointmentForm').reset();
      serialGrid.innerHTML = '';
      serialInput.value = '';
      submitBtn.classList.remove('loading');
      submitBtn.textContent = '‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
      currentUserSelection = null;
      timeSelect.disabled = true;
      timeSelect.innerHTML = '<option value="">-- ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
      noDayMessage.style.display = 'none';
      
      // Popup close ‡¶ï‡¶∞‡ßÅ‡¶®
      closePopup();
    }

    // ==================== CONFIRMATION SLIP SYSTEM ====================
    function showConfirmationSlip(appointmentData) {
      // Update slip content
      slipName.textContent = appointmentData.name;
      slipAge.textContent = appointmentData.age + ' ‡¶¨‡¶õ‡¶∞';
      slipPhone.textContent = appointmentData.phone;
      slipType.textContent = appointmentData.patientType === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
      slipDay.textContent = appointmentData.day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
      slipTime.textContent = appointmentData.time + "\n" + "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§/‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá ‡¶ö‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡¶®";
      slipSerial.textContent = '#' + appointmentData.serial;
      
      // Set current date and time
      const now = new Date();
      const dateTimeString = now.toLocaleDateString('bn-BD', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      }) + ' ' + now.toLocaleTimeString('bn-BD', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      slipDateTime.textContent = dateTimeString;
      
      // Show slip and download buttons
      confirmationSlip.style.display = 'block';
      downloadButtons.style.display = 'flex';
    }

    // ==================== FIXED DOWNLOAD FUNCTIONS ====================
    async function downloadPNG() {
      try {
        console.log('üîÑ Starting PNG download...');
        
        if (typeof html2canvas === 'undefined') {
          throw new Error('html2canvas library not loaded');
        }
        
        const slipElement = document.getElementById('confirmationSlip');
        
        if (!slipElement) {
          throw new Error('Confirmation slip element not found');
        }

        // Store original styles
        const originalStyles = {
          display: slipElement.style.display,
          position: slipElement.style.position,
          left: slipElement.style.left,
          top: slipElement.style.top,
          transform: slipElement.style.transform,
          zIndex: slipElement.style.zIndex,
          margin: slipElement.style.margin
        };

        // Create a clone for screenshot to avoid disturbing the original
        const clone = slipElement.cloneNode(true);
        clone.style.display = 'block';
        clone.style.position = 'fixed';
        clone.style.left = '0';
        clone.style.top = '0';
        clone.style.transform = 'none';
        clone.style.zIndex = '9999';
        clone.style.margin = '0';
        clone.style.background = 'white';
        
        // Append clone to body
        document.body.appendChild(clone);

        console.log('üé® Generating canvas...');
        const canvas = await html2canvas(clone, {
          scale: 3, // Higher quality
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          width: clone.offsetWidth,
          height: clone.offsetHeight,
          x: 0,
          y: 0,
          scrollX: 0,
          scrollY: 0,
          windowWidth: clone.offsetWidth,
          windowHeight: clone.offsetHeight
        });

        // Remove clone
        document.body.removeChild(clone);

        console.log('‚úÖ Canvas generated, creating download...');
        const link = document.createElement('a');
        link.download = `appointment-serial-${currentAppointmentData.serial}.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('‚úÖ PNG download completed');
        showPopup('success', '‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤', 'PNG ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
      } catch (error) {
        console.error('‚ùå PNG download error:', error);
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', `PNG ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${error.message}`);
      }
    }

    async function downloadPDF() {
      try {
        console.log('üîÑ Starting PDF download...');
        
        if (typeof window.jspdf === 'undefined') {
          throw new Error('jsPDF library not loaded');
        }
        if (typeof html2canvas === 'undefined') {
          throw new Error('html2canvas library not loaded');
        }

        const jsPDF = window.jspdf.jsPDF;
        const slipElement = document.getElementById('confirmationSlip');
        
        if (!slipElement) {
          throw new Error('Confirmation slip element not found');
        }

        // Create a clone for screenshot
        const clone = slipElement.cloneNode(true);
        clone.style.display = 'block';
        clone.style.position = 'fixed';
        clone.style.left = '0';
        clone.style.top = '0';
        clone.style.transform = 'none';
        clone.style.zIndex = '9999';
        clone.style.margin = '0';
        clone.style.background = 'white';
        
        // Append clone to body
        document.body.appendChild(clone);

        console.log('üé® Generating canvas for PDF...');
        const canvas = await html2canvas(clone, {
          scale: 3, // Higher quality for PDF
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          width: clone.offsetWidth,
          height: clone.offsetHeight,
          x: 0,
          y: 0,
          scrollX: 0,
          scrollY: 0
        });

        // Remove clone
        document.body.removeChild(clone);

        console.log('üìÑ Creating PDF...');
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a6' // Smaller format for slip
        });
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        // Add image to PDF
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`appointment-serial-${currentAppointmentData.serial}.pdf`);
        
        console.log('‚úÖ PDF download completed');
        showPopup('success', '‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤', 'PDF ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
      } catch (error) {
        console.error('‚ùå PDF download error:', error);
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', `PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${error.message}`);
      }
    }

    // ==================== FIREBASE FUNCTIONS ====================

    // Load serial ranges from Firebase
    async function loadSerialRanges() {
      if (!db) {
        console.error('‚ùå Database not initialized in appointment form');
        loadingMessage.style.display = 'none';
        return;
      }
      
      try {
        console.log('üîÑ Loading serial ranges in appointment form...');
        loadingMessage.style.display = 'block';
        serialGrid.innerHTML = '';
        
        const doc = await db.collection('settings').doc('serialRanges').get();
        
        if (doc.exists) {
          serialRanges = doc.data();
          console.log('‚úÖ Serial ranges loaded in appointment form:', serialRanges);
          
          // Ensure the structure exists with proper fallbacks
          if (!serialRanges.Thursday) serialRanges.Thursday = {};
          if (!serialRanges.Friday) serialRanges.Friday = {};
          if (!serialRanges.Thursday.new) serialRanges.Thursday.new = {};
          if (!serialRanges.Thursday.old) serialRanges.Thursday.old = {};
          if (!serialRanges.Friday.new) serialRanges.Friday.new = {};
          if (!serialRanges.Friday.old) serialRanges.Friday.old = {};
          
        } else {
          // No serial ranges found
          console.log('‚ÑπÔ∏è No serial ranges found in appointment form');
          serialRanges = { 
            Thursday: { new: {}, old: {} }, 
            Friday: { new: {}, old: {} } 
          };
        }
        
        loadingMessage.style.display = 'none';
        checkDayAvailability();
        
      } catch (error) {
        console.error('‚ùå Error loading serial ranges in appointment form:', error);
        serialRanges = { 
          Thursday: { new: {}, old: {} }, 
          Friday: { new: {}, old: {} } 
        };
        loadingMessage.style.display = 'none';
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
      }
    }

    // Check if selected day has any serial ranges
    function checkDayAvailability() {
      const day = daySelect.value;
      const type = typeSelect.value;
      
      console.log('üìÖ Checking day availability for:', day);
      
      // Reset all messages and fields
      noDayMessage.style.display = 'none';
      noSlotsMessage.style.display = 'none';
      timeSelect.disabled = true;
      timeSelect.innerHTML = '<option value="">-- ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
      serialGrid.innerHTML = '';
      serialInput.value = '';
      
      if (!day) {
        return;
      }
      
      // Check if day exists in serialRanges and has any time slots
      if (serialRanges[day] && 
          ((serialRanges[day].new && Object.keys(serialRanges[day].new).length > 0) || 
           (serialRanges[day].old && Object.keys(serialRanges[day].old).length > 0))) {
        
        console.log('‚úÖ Day has serial ranges:', day);
        timeSelect.disabled = false;
        updateTimeOptions();
        
      } else {
        console.log('‚ùå No serial ranges for day:', day);
        showPopup('warning', '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á', 
          '‡¶è‡¶á ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá‡ß¶‡ßß‡ß≠‡ß≠‡ß≠‡ßÆ‡ßÆ‡ßÆ‡ß™‡ßÆ‡ßØ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‡•§');
        timeSelect.disabled = true;
      }
    }

    // ==================== PENDING SELECTIONS SYSTEM ====================

    // Add pending selection to Firebase
    async function addPendingSelection(serialNumber) {
      if (!db) {
        console.error('‚ùå Database not initialized');
        return null;
      }
      
      const day = daySelect.value;
      const time = timeSelect.value;
      const type = typeSelect.value;
      
      if (!day || !time || !type) {
        console.error('‚ùå Missing selection data');
        return null;
      }

        // üî• NEW: Also store user data with pending selection
  const userData = {
    name: nameInput.value.trim(),
    phone: phoneInput.value,
    age: ageInput.value
  };
      try {
        const pendingData = {
          serial: serialNumber,
          day: day,
          time: time,
          type: type,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          expiresAt: new Date(Date.now() + 5 * 60 * 1000), // 5 minutes expiry
          status: 'pending'
        };
        
        const docRef = await db.collection('pendingSelections').add(pendingData);
        console.log(`‚úÖ Pending selection added for serial ${serialNumber}, ID: ${docRef.id}`);
        return docRef.id;
      } catch (error) {
        console.error('‚ùå Error adding pending selection:', error);
        return null;
      }
    }

    // Remove pending selection from Firebase
    async function removePendingSelection(pendingId) {
      if (!db || !pendingId) return;
      
      try {
        await db.collection('pendingSelections').doc(pendingId).delete();
        console.log(`‚úÖ Pending selection removed: ${pendingId}`);
      } catch (error) {
        console.error('‚ùå Error removing pending selection:', error);
      }
    }

    // Load pending selections from Firebase
    function loadPendingSelectionsFromFirebase() {
      if (!db) return;
      
      const pendingListener = db.collection('pendingSelections')
        .where('expiresAt', '>', new Date())
        .onSnapshot(snapshot => {
          const pendingSelections = {};
          
          snapshot.forEach(doc => {
            const data = doc.data();
            const key = `${data.day}_${data.time}_${data.type}`;
            
            if (!pendingSelections[key]) {
              pendingSelections[key] = new Set();
            }
            pendingSelections[key].add(data.serial);
          });
          
          console.log('üìã Pending selections updated:', pendingSelections);
          updateSerialDisplay(pendingSelections);
        }, error => {
          console.error('‚ùå Error loading pending selections:', error);
        });
      
      realtimeListeners.push(pendingListener);
    }

// Update serial display with pending selections - IMPROVED VERSION
function updateSerialDisplay(pendingSelections) {
  const day = daySelect.value;
  const time = timeSelect.value;
  const type = typeSelect.value;
  const currentKey = `${day}_${time}_${type}`;
  
  const currentPending = pendingSelections[currentKey] || new Set();
  
  document.querySelectorAll('.serial-slot').forEach(slot => {
    const serial = parseInt(slot.dataset.serial);
    const isBooked = slot.classList.contains('booked');
    const isUserSelected = currentUserSelection === serial;
    
    // Remove previous classes
    slot.classList.remove('pending', 'available', 'selected');
    
    if (isBooked) {
      // Booked - Red
      slot.classList.add('booked');
      slot.style.pointerEvents = 'none';
      slot.title = '‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';
    } else if (isUserSelected) {
      // User's own selection - Yellow
      slot.classList.add('selected');
      slot.style.pointerEvents = 'auto';
      slot.title = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤';
    } else if (currentPending.has(serial)) {
      // Selected by another user - Blue
      slot.classList.add('pending');
      slot.style.pointerEvents = 'none';
      slot.title = '‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßá‡¶â ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®';
    } else {
      // Available - Green
      slot.classList.add('available');
      slot.style.pointerEvents = 'auto';
      slot.title = '‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ - ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
    }
  });
}
// Load appointments from Firebase - ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶è‡¶ü‡¶æ‡¶ï‡ßá ‡¶¨‡¶¶‡¶≤‡¶æ‡¶®
function loadAppointmentsFromFirebase() {
  if (!db) {
    console.error('‚ùå Database not initialized in appointment form');
    return;
  }
  
  // Remove existing listeners
  realtimeListeners.forEach(unsubscribe => unsubscribe());
  realtimeListeners = [];

  // üî• NEW: Immediately load pending selections for new user
  loadPendingSelectionsImmediately();

  // Load appointments
  const appointmentsListener = db.collection('appointments')
    .onSnapshot(snapshot => {
      console.log('üìÖ Appointments snapshot received');
      appointments = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        appointments.push({
          id: doc.id,
          ...data
        });
      });
      console.log('üìÖ Appointments loaded in appointment form:', appointments.length);
      
      // Always reload serials when appointments change
      if (daySelect.value && typeSelect.value && timeSelect.value) {
        console.log('üîÑ Reloading serials due to appointments change');
        loadSerials();
      }
    }, error => {
      console.error('‚ùå Error loading appointments in appointment form:', error);
    });

  realtimeListeners.push(appointmentsListener);

  // Load pending selections (real-time)
  loadPendingSelectionsFromFirebase();

  // Load serial ranges
  const serialRangesListener = db.collection('settings').doc('serialRanges')
    .onSnapshot(doc => {
      console.log('üîÑ Serial ranges snapshot received');
      if (doc.exists) {
        serialRanges = doc.data();
        console.log('üîÑ Serial ranges updated in appointment form:', serialRanges);
        
        // Ensure structure
        if (!serialRanges.Thursday) serialRanges.Thursday = {};
        if (!serialRanges.Friday) serialRanges.Friday = {};
        if (!serialRanges.Thursday.new) serialRanges.Thursday.new = {};
        if (!serialRanges.Thursday.old) serialRanges.Thursday.old = {};
        if (!serialRanges.Friday.new) serialRanges.Friday.new = {};
        if (!serialRanges.Friday.old) serialRanges.Friday.old = {};
        
        checkDayAvailability();
      } else {
        console.log('üì≠ No serial ranges document found');
      }
    }, error => {
      console.error('‚ùå Error listening to serial ranges in appointment form:', error);
    });

  realtimeListeners.push(serialRangesListener);
}

// üî• NEW: Add this function for immediate pending selections load
async function loadPendingSelectionsImmediately() {
  if (!db) return;
  
  try {
    console.log('üöÄ Loading pending selections immediately for new user...');
    
    const snapshot = await db.collection('pendingSelections')
      .where('expiresAt', '>', new Date())
      .get();
    
    const pendingSelections = {};
    const now = new Date();
    
    snapshot.forEach(doc => {
      const data = doc.data();
      
      // Filter expired data
      if (data.expiresAt && data.expiresAt.toDate() > now) {
        const key = `${data.day}_${data.time}_${data.type}`;
        
        if (!pendingSelections[key]) {
          pendingSelections[key] = new Set();
        }
        pendingSelections[key].add(data.serial);
      }
    });
    
    console.log('üìã Immediate pending selections loaded:', pendingSelections);
    updateSerialDisplay(pendingSelections);
    
  } catch (error) {
    console.error('‚ùå Error loading immediate pending selections:', error);
  }
}

    // Check if phone number already has an appointment for ANY day
    async function checkExistingAppointment(phoneNumber) {
      if (!db) {
        console.error('‚ùå Database not initialized in appointment form');
        return false;
      }
      
      try {
        const snapshot = await db.collection('appointments')
          .where('phone', '==', phoneNumber)
          .get();
        
        const hasAppointment = !snapshot.empty;
        
        if (hasAppointment) {
          console.log(`üìû Phone ${phoneNumber} already has appointments:`);
          snapshot.forEach(doc => {
            const data = doc.data();
            console.log(`   - ${data.day} at ${data.time}, Serial: ${data.serial}, Name: ${data.name}`);
          });
        } else {
          console.log(`üìû Phone ${phoneNumber} is FREE to use`);
        }
        
        return hasAppointment;
      } catch (error) {
        console.error('‚ùå Error checking existing appointment in appointment form:', error);
        return false;
      }
    }

    // Check if serial is already booked for current day (any time, any phone)
    // Check if serial is already booked for current day and type (same type)
    function isSerialBookedForDayAndType(serialNumber, day, type) {
      const isBooked = appointments.some(app => 
        app.day === day && 
        app.serial === serialNumber &&
        (app.patientType || app.type) === type
      );
      
      if (isBooked) {
        const bookedApp = appointments.find(app => 
          app.day === day && 
          app.serial === serialNumber && 
          (app.patientType || app.type) === type
        );
        console.log(`üî¥ Serial ${serialNumber} is already booked for ${day} and type ${type} by: ${bookedApp.name} (${bookedApp.phone})`);
      }
      
      return isBooked;
    }
    // ==================== FORM FUNCTIONS ====================

    // ‚úÖ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® - ‡¶è‡¶á‡¶ü‡¶æ ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ï‡ßã‡¶™‡ßá ‡¶è‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
function extractTimeNumber(timeStr) {
  const timePart = timeStr.split(' ')[0]; // "5:00" part
  const [hours, minutes] = timePart.split(':');
  return parseInt(hours) * 100 + (parseInt(minutes) || 0);
}

// ‚úÖ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° updateTimeOptions ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function updateTimeOptions() {
  const day = daySelect.value;
  const type = typeSelect.value;
  
  console.log('üïí Updating time options for:', day, type);
  
  timeSelect.innerHTML = '<option value="">-- ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
  serialGrid.innerHTML = '';
  serialInput.value = '';
  noSlotsMessage.style.display = 'none';
  currentUserSelection = null;

  let hasTimeSlots = false;
  let timeSlots = [];

  if(day && type && serialRanges[day] && serialRanges[day][type]) {
    timeSlots = Object.keys(serialRanges[day][type]);
    console.log('‚è∞ Available times:', timeSlots);
    
    if (timeSlots.length > 0) {
      hasTimeSlots = true;
      
      // ‚úÖ ‡¶∏‡¶Æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã
      const sortedTimes = timeSlots.sort((a, b) => {
        const timeA = a.toUpperCase();
        const timeB = b.toUpperCase();
        
        const isAM_A = timeA.includes('AM');
        const isAM_B = timeB.includes('AM');
        
        // AM ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶ó‡ßá, PM ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡¶∞‡ßá
        if (isAM_A && !isAM_B) return -1;
        if (!isAM_A && isAM_B) return 1;
        
        // ‡¶è‡¶ï‡¶á AM/PM ‡¶π‡¶≤‡ßá ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã
        const numA = extractTimeNumber(timeA);
        const numB = extractTimeNumber(timeB);
        
        return numA - numB;
      });
      
      console.log('üïí Sorted times:', sortedTimes);
      
      // ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã ‡¶∏‡¶Æ‡ßü‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ö‡¶™‡¶∂‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
      sortedTimes.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        timeSelect.appendChild(option);
      });
    }
  }

  // Show popup if no time slots available
  if (!hasTimeSlots) {
    const dayText = day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
    const typeText = type === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
    
    const message = `"${dayText}" ‡¶è‡¶¨‡¶Ç "${typeText}" ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡ßü ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶¶‡¶ø‡¶® ‡¶¨‡¶æ ‡¶ß‡¶∞‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`;
    
    showPopup('warning', '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡ßü ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á', message);
    
    timeSelect.innerHTML = '<option value="">-- ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡ßü ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á --</option>';
    console.log('‚è∞ No times available for:', day, type);
  }
}

    function loadSerials() {
      const day = daySelect.value;
      const type = typeSelect.value;
      const time = timeSelect.value;
      
      console.log('üéØ Loading serials for:', day, type, time);
      
      serialGrid.innerHTML = '';
      serialInput.value = '';
      noSlotsMessage.style.display = 'none';
      loadingMessage.style.display = 'block';
      
      // Remove user's pending selection when changing time
      if (currentUserPendingId) {
        removePendingSelection(currentUserPendingId);
        currentUserPendingId = null;
      }
      currentUserSelection = null;

      if(serialRanges[day] && serialRanges[day][type] && serialRanges[day][type][time]) {
        const [start, end] = serialRanges[day][type][time];
        let availableSlots = 0;

        console.log(`üî¢ Serial range: ${start} - ${end}`);

        for(let i = start; i <= end; i++) {
          const slot = document.createElement('div');
          slot.classList.add('serial-slot');
          slot.dataset.serial = i;
          
          // Check if serial is booked for this day
         const isBookedForDay = isSerialBookedForDayAndType(i, day, type);
          
          if(isBookedForDay) {
            // Booked - Red
            slot.classList.add('booked');
            slot.textContent = i;
            slot.title = '‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';
          } else {
            // Available - Green (will be updated by pending selections)
            slot.classList.add('available');
            availableSlots++;
            slot.textContent = i;
            slot.title = '‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ - ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            
            // Add click event listener
            slot.addEventListener('click', function() {
              selectSerial(i);
            });
          }
          serialGrid.appendChild(slot);
        }

        loadingMessage.style.display = 'none';
        
        if (availableSlots === 0) {
          showPopup('warning', '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á', 
            '‡¶è‡¶á ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
          console.log('‚ö†Ô∏è No available slots');
        }
        
        console.log(`üìä Total slots: ${end - start + 1}, Available: ${availableSlots}, Booked: ${(end - start + 1) - availableSlots}`);
      } else {
        // ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡ßç‡¶≤‡¶ü ‡¶®‡ßá‡¶á
        loadingMessage.style.display = 'none';
        showPopup('warning', '‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á', 
          '‡¶è‡¶á ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        console.log('‚ùå No serial slots found for selected day, type, and time');
      }
    }

// Handle serial selection - IMPROVED VERSION
async function selectSerial(serialNumber) {
  console.log(`üéØ User attempting to select serial ${serialNumber}`);
  
  const day = daySelect.value;
  const time = timeSelect.value;
  const type = typeSelect.value;

  // üî• NEW: Check if form has basic data before allowing selection
  const name = nameInput.value.trim();
  const age = ageInput.value;
  const phone = phoneInput.value;
  
  let hasError = false;
  
  // Reset all error messages first
  nameError.style.display = 'none';
  ageError.style.display = 'none';
  phoneError.style.display = 'none';
  
  // Validate each field and show individual errors
  if (!name) {
    nameError.style.display = 'block';
    nameError.textContent = '‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶π‡¶¨‡ßá';
    nameInput.setCustomValidity('invalid');
    hasError = true;
  } else if (!/^[\p{L}\p{M}\. ]{3,50}$/u.test(name)) {
    nameError.style.display = 'block';
    nameError.textContent = '‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ö‡¶ø‡¶π‡ßç‡¶® ‡¶¨‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ)';
    nameInput.setCustomValidity('invalid');
    hasError = true;
  }
  
  if (!age) {
    ageError.style.display = 'block';
    ageError.textContent = '‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶π‡¶¨‡ßá';
    ageInput.setCustomValidity('invalid');
    hasError = true;
  } else if (age < 1 || age > 120) {
    ageError.style.display = 'block';
    ageError.textContent = '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¨‡ßü‡¶∏ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (1-120)';
    ageInput.setCustomValidity('invalid');
    hasError = true;
  }
  
  if (!phone) {
    phoneError.style.display = 'block';
    phoneError.textContent = '‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶π‡¶¨‡ßá';
    phoneInput.setCustomValidity('invalid');
    hasError = true;
  } else if (!/^01[0-9]{9}$/.test(phone)) {
    phoneError.style.display = 'block';
    phoneError.textContent = '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (01XXXXXXXXX)';
    phoneInput.setCustomValidity('invalid');
    hasError = true;
  }
  
  if (hasError) {
    // Show popup AND scroll to first error
    showPopup('error', '‡¶Ö‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶§‡¶•‡ßç‡¶Ø', 
      '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶®‡¶æ‡¶Æ, ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§');
    
    // Scroll to the first error field
    if (!name) {
      nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      nameInput.focus();
    } else if (!age) {
      ageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      ageInput.focus();
    } else if (!phone) {
      phoneInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      phoneInput.focus();
    }
    return;
  }
  // Quick client-side check
  const slot = document.querySelector(`.serial-slot[data-serial="${serialNumber}"]`);
  if (slot.classList.contains('pending') || slot.classList.contains('booked')) {
    showPopup('error', '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ unavailable', '‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
    return;
  }
  
  // Remove previous pending selection
  if (currentUserPendingId) {
    await removePendingSelection(currentUserPendingId);
    currentUserPendingId = null;
  }
  
  // Remove 'selected' class from all slots
  document.querySelectorAll('.serial-slot').forEach(slot => {
    slot.classList.remove('selected');
  });
  
  // Add 'selected' class to clicked slot
  if (slot) {
    slot.classList.add('selected');
    slot.classList.remove('available', 'pending');
  }
  
  // Update current selection and add to pending
  currentUserSelection = serialNumber;
  serialInput.value = serialNumber;
  serialError.style.display = 'none';
  
  // Add to pending selections in Firebase
  currentUserPendingId = await addPendingSelection(serialNumber);
  
  if (!currentUserPendingId) {
    showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡¶ø‡¶ú‡¶æ‡¶∞‡ßç‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
    return;
  }
  
  console.log(`‚úÖ Serial ${serialNumber} successfully reserved with ID: ${currentUserPendingId}`);
}

    // ==================== EVENT LISTENERS ====================

    daySelect.addEventListener('change', () => {
      console.log('üìÖ Day changed to:', daySelect.value);
      checkDayAvailability();
      serialGrid.innerHTML = '';
      serialInput.value = '';
      timeSelect.value = '';
      noSlotsMessage.style.display = 'none';
      currentUserSelection = null;
    });
    
    typeSelect.addEventListener('change', () => {
      console.log('üë• Type changed to:', typeSelect.value);
      checkDayAvailability();
      serialGrid.innerHTML = '';
      serialInput.value = '';
      timeSelect.value = '';
      noSlotsMessage.style.display = 'none';
      currentUserSelection = null;
    });
    
timeSelect.addEventListener('change', () => {
  console.log('‚è∞ Time changed to:', timeSelect.value);
  
  // üî• NEW: Immediately load pending selections when time changes
  if (timeSelect.value) {
    loadPendingSelectionsImmediately();
  }
  
  loadSerials();
});

    // Name validation
    nameInput.addEventListener('input', () => {
      const val = nameInput.value.trim();
      const valid = /^[\p{L}\p{M}\. ]{3,50}$/u;
      const invalidChars = /[-,;@#$%^&*]/;
      
      if(!valid.test(val) || invalidChars.test(val)) {
        nameError.style.display = 'block';
        nameInput.setCustomValidity('invalid');
      } else {
        nameError.style.display = 'none';
        nameInput.setCustomValidity('');
      }
    });

    // Age validation
    ageInput.addEventListener('input', () => {
      const val = ageInput.value;
      if(val < 1 || val > 120) {
        ageError.style.display = 'block';
        ageInput.setCustomValidity('invalid');
      } else {
        ageError.style.display = 'none';
        ageInput.setCustomValidity('');
      }
    });

    // Phone validation
    phoneInput.addEventListener('input', () => {
      const val = phoneInput.value;
      const valid = /^01[0-9]{9}$/.test(val);
      
      if(!valid) {
        phoneError.style.display = 'block';
        phoneInput.setCustomValidity('invalid');
      } else {
        phoneError.style.display = 'none';
        phoneInput.setCustomValidity('');
      }
    });

    // Form submission
    document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!db) {
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        return;
      }
      
      // Validation
      let isValid = true;
      
      if(!nameInput.value.trim()) {
        nameError.style.display = 'block';
        nameInput.setCustomValidity('invalid');
        isValid = false;
      }
      
      if(!ageInput.value || ageInput.value < 1 || ageInput.value > 120) {
        ageError.style.display = 'block';
        ageInput.setCustomValidity('invalid');
        isValid = false;
      }
      
      if(!/^01[0-9]{9}$/.test(phoneInput.value)) {
        phoneError.style.display = 'block';
        phoneInput.setCustomValidity('invalid');
        isValid = false;
      }
      
      if(!serialInput.value) {
        serialError.style.display = 'block';
        serialInput.setCustomValidity('invalid');
        isValid = false;
      }
      
      if(!isValid) {
        showPopup('error', '‡¶´‡¶∞‡ßç‡¶Æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        return false;
      }
      
      const selectedPhone = phoneInput.value;
      const selectedDay = daySelect.value;
      const selectedSerial = parseInt(serialInput.value);
      
      // Check 1: Phone number should be unique in entire system
      const hasExistingAppointment = await checkExistingAppointment(selectedPhone);
      if(hasExistingAppointment) {
        showPopup('error', '‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü', 
          '‡¶è‡¶á ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡•§<br><br>‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        return false;
      }
      
      // Check 2: Serial number should be unique per day and type
      const isSerialBookedForSameType = isSerialBookedForDayAndType(selectedSerial, selectedDay, typeSelect.value);
      if(isSerialBookedForSameType) {
        const dayText = selectedDay === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
        const typeText = typeSelect.value === 'new' ? '‡¶®‡¶§‡ßÅ‡¶®' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶®';
        showPopup('error', '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶°‡ßÅ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶ü', 
          `‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ${selectedSerial} ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ${dayText} ‡¶è‡¶¨‡¶Ç ${typeText} ‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
        return false;
      }
      
      const dayText = selectedDay === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
      const typeText = typeSelect.value === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
      
      // Show confirmation popup
      const confirmed = await showPopup('confirm', '‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶®', 
        `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?<br><br>
        <strong>‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§:</strong><br>
        ‚Ä¢ ‡¶¶‡¶ø‡¶®: ${dayText}<br>
        ‚Ä¢ ‡¶∏‡¶Æ‡¶Ø‡¶º: ${timeSelect.value}<br>
        ‚Ä¢ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤: ${selectedSerial} ‡¶®‡¶Ç<br>
        ‚Ä¢ ‡¶ß‡¶∞‡¶®: ${typeText}<br>
        ‚Ä¢ ‡¶´‡ßã‡¶®: ${selectedPhone}`, 
        { showConfirm: true });
      
      if(!confirmed) {
        console.log('‚ùå User cancelled the appointment');
        return false;
      }

      // Prepare data
      const appointmentData = {
        name: nameInput.value.trim(),
        age: parseInt(ageInput.value),
        phone: selectedPhone,
        patientType: typeSelect.value,
        day: selectedDay,
        time: timeSelect.value,
        serial: selectedSerial,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'confirmed'
      };

      // Store for slip generation
      currentAppointmentData = appointmentData;

      try {
        // Show loading
        submitBtn.classList.add('loading');
        submitBtn.textContent = '‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

        // Remove pending selection when submitting
        if (currentUserPendingId) {
          await removePendingSelection(currentUserPendingId);
          currentUserPendingId = null;
        }

        console.log('üíæ Saving appointment:', appointmentData);
        
        // Save to Firebase
        await db.collection('appointments').add(appointmentData);
        
        // Show success popup with download options
        showPopup('success', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 
          '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!<br><br>‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶≤‡¶ø‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§',
          { showSlip: true });
        
        console.log('‚úÖ Appointment saved successfully');
        
        // ‚ùå DON'T reset form here - it will be reset when user clicks "‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá"
        
      } catch (error) {
        console.error('‚ùå Error saving appointment:', error);
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        submitBtn.classList.remove('loading');
        submitBtn.textContent = '‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
      }
    });

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üèÅ Appointment form DOM loaded');
      
      // Wait for Firebase to initialize
      setTimeout(() => {
        if (db) {
          console.log('üöÄ Starting data loading...');
          loadSerialRanges();
          loadAppointmentsFromFirebase();
        } else {
          console.error('‚ùå Firebase not initialized in appointment form');
        }
      }, 1000);
    });

    // Clean up pending selections when page is closed or refreshed
    window.addEventListener('beforeunload', function() {
      if (currentUserPendingId) {
        // Note: This may not always work due to browser restrictions
        removePendingSelection(currentUserPendingId);
      }
    });
  </script>
</body>
</html>
