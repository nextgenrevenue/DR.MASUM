<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤ (‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶π‡ßá‡¶°‡¶æ‡¶∞/‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶Æ‡¶®‡ßç‡¶¨‡¶ø‡¶§) */
    :root {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --success: #16a34a; 
        --danger: #dc2626;
        --warning: #f59e0b;
        --gray: #6b7280; 
        --light-gray: #f3f4f6;
        --white: #ffffff;
        --dark: #1f2937;
        --border-color: #e5e7eb;
        
        /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶ì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ (‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá) */
        --token-color: #0d9488; 
        --called-color: var(--primary); /* ‡¶ï‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        --not-called-color: var(--warning);
        --undo-call-color: #7c3aed; 
        --undo-call-hover: #6d28d9;
        
        /* 4 ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶∞‡¶Ç */
        --card-called: var(--success); 
        --card-not-called: var(--warning); 
        --card-token-given: var(--token-color); 
        --card-token-not-given: var(--danger); 
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    body {
        font-family: 'Noto Sans Bengali', sans-serif;
        background-color: var(--light-gray);
        min-height: 100vh;
        color: #1f2937;
    }
    
    /* --- ‡ßß. ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶ì ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ (Original dashboard.html) --- */
    .admin-header {
      background-color: var(--dark);
      color: var(--white);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky; 
      top: 0;
      z-index: 1000;
    }
    
    .admin-header h1 {
      font-size: 22px;
    }
    
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--white);
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }
    
    .logout-btn {
      padding: 8px 16px;
      background-color: var(--danger);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Noto Sans Bengali', sans-serif;
    }
    
    .admin-container {
      display: flex;
      min-height: calc(100vh - 60px);
    }
    
    .admin-sidebar {
      width: 250px;
      background-color: var(--white);
      border-right: 1px solid var(--border-color);
      padding: 20px 0;
      transition: transform 0.3s ease;
      position: sticky; 
      top: 60px; 
      height: calc(100vh - 60px);
      overflow-y: auto;
    }
    
    .sidebar-menu {
      list-style: none;
    }
    
    .sidebar-menu a {
      display: block;
      padding: 12px 20px;
      color: var(--dark);
      text-decoration: none;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .sidebar-menu a.active {
      background-color: var(--light-gray);
      color: var(--primary);
    }
    
    .sidebar-menu a i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    .admin-main {
      flex: 1;
      padding: 20px;
      background-color: var(--light-gray);
    }
    
    /* --- ‡ß®. ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ (‡ß™ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶°) --- */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
        gap: 20px;
        margin-bottom: 30px;
    }
    .card {
        background-color: var(--white);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .card-title {
        font-size: 0.9em;
        color: var(--gray);
        margin-bottom: 5px;
    }
    .card-count {
        font-size: 1.8em;
        font-weight: 700;
    }
    /* 4 ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶∞‡¶Ç */
    .card.called-apps .card-count { color: var(--card-called); }
    .card.not-called-apps .card-count { color: var(--card-not-called); }
    .card.token-given-apps .card-count { color: var(--card-token-given); }
    .card.token-not-given-apps .card-count { color: var(--card-token-not-given); }


    /* --- ‡ß©. ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ì ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® (‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° ‡¶•‡ßá‡¶ï‡ßá) --- */
    
    .admin-table-section {
        background-color: var(--white);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .admin-table-section h1 {
        font-size: 24px;
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .filter-controls {
        display: flex;
        flex-wrap: wrap; /* ‡¶™‡¶ø‡¶∏‡¶ø‡¶§‡ßá ‡¶è‡¶ï ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá */
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px 0;
        align-items: flex-end; 
    }
    .filter-controls > div {
        display: flex;
        flex-direction: column;
        min-width: 150px;
        flex-grow: 1; 
    }
    #search-filter-wrapper { /* ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        min-width: 250px; 
    }

    .filter-controls label {
        font-size: 0.9em;
        font-weight: 500;
        color: #374151;
        margin-bottom: 5px;
    }
    .filter-controls select,
    #search-filter { 
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1em;
        font-family: 'Noto Sans Bengali', sans-serif;
    }
    #search-filter {
        flex-grow: 1;
    }

    .status-message {
        padding: 10px 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        font-weight: 500;
        background-color: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
        text-align: center;
    }

    .appointment-table {
        min-width: 1200px; 
        border-collapse: collapse;
        font-size: 14px;
        width: 100%;
    }

    .appointment-table thead th {
        background-color: var(--primary);
        color: var(--white);
        padding: 12px 15px;
        text-align: left;
        border-bottom: 2px solid var(--border-color);
        position: sticky;
        top: 0;
    }

    .appointment-table tbody td {
        padding: 10px 15px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
        white-space: nowrap; 
    }

    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
    }
    .status-not-called { background-color: var(--gray); color: var(--white); }
    .status-called { background-color: var(--success); color: var(--white); }
    .status-token-given { background-color: var(--called-color); color: var(--white); }
    .status-token-not-given { background-color: var(--gray); color: var(--white); }

    .action-btn {
        color: var(--white);
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.2s;
        width: 130px; 
    }
    .btn-call { background-color: var(--primary); }
    .btn-token { background-color: var(--token-color); }
    .btn-token-undo { background-color: #0c746a; }
    .btn-call-undo { background-color: var(--undo-call-color); } 
    .action-btn:hover:not([disabled]) { filter: brightness(1.15); }
    .btn-call-undo:hover:not([disabled]) { background-color: var(--undo-call-hover); filter: none; }
    .action-btn[disabled] { background-color: var(--gray); cursor: not-allowed; opacity: 0.7; }

    #loading-message {
        text-align: center;
        font-size: 1.2em;
        color: var(--gray);
        padding: 50px;
    }

    /* --- ‡ß™. ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡¶∏‡¶ø‡¶≠ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ (‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶≤‡ßá‡¶Ü‡¶â‡¶ü) --- */
    @media (max-width: 768px) {
        .mobile-menu-btn {
            display: block;
        }
        
        .admin-sidebar {
            position: fixed;
            top: 60px;
            height: calc(100vh - 60px);
            transform: translateX(-100%);
            z-index: 100;
        }
        
        .admin-sidebar.mobile-open {
            transform: translateX(0);
        }
        
        .admin-container {
            flex-direction: column;
        }
        
        .admin-main {
            padding: 10px;
        }
        
        .summary-cards {
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px;
        }
        
         /* **‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡ßß:** ‡ß¨‡¶ü‡¶ø ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞/‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ó‡ßç‡¶∞‡¶ø‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡ß© ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá ‡¶∏‡¶Æ‡¶æ‡¶® */
        .filter-controls {
            display: grid; 
            grid-template-columns: repeat(3, 1fr) !important; /* ‡ß© ‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶ú‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
            gap: 10px; 
            padding: 10px 0; 
        }
         
        /* **‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡ß®:** ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ div-‡¶è‡¶∞ min-width ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ */
        .filter-controls > div {
            min-width: 0 !important; 
            flex-grow: 1; 
            width: 100% !important; 
            overflow: hidden; /* ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Ø‡ßá‡¶® ‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• ‡¶®‡¶æ ‡¶¨‡¶æ‡ßú‡¶æ‡ßü */
        }
        
        /* ‡ß¨‡¶∑‡ßç‡¶† ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶® ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• ‡¶®‡ßá‡¶¨‡ßá ‡¶®‡¶æ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶ï‡ßã‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶Ø‡¶æ‡ßü, ‡¶§‡¶æ ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã) */
        .filter-controls > div:last-child {
             grid-column: unset !important; 
        }

        /* **‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡ß©:** ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ì ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏‡¶ï‡ßá ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶•‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ */
        .filter-controls select,
        .filter-controls input[type="text"] { 
            min-width: 0 !important; /* ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü min-width ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ */
            width: 100% !important; /* ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ */
            box-sizing: border-box; 
            /* ‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶Ø‡ßá‡¶® ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• ‡¶®‡¶æ ‡¶¨‡¶æ‡ßú‡ßá */
            max-width: 100% !important;
            text-overflow: ellipsis; 
        }

        /* ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡ßá‡¶∞ min-width: 250px ‡¶ì‡¶≠‡¶æ‡¶∞‡¶∞‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
        #search-filter {
            min-width: 0 !important; 
        }
        
        .appointment-table {
            min-width: 700px; 
        }
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
    <h1>‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1>
    <button class="logout-btn" id="logoutBtn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
  </header>
  
  <div class="admin-container">
    <nav class="admin-sidebar" id="sidebar">
      <ul class="sidebar-menu">
        <li><a href="/dashboard" class="active"><i>üìä</i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a></li>
        <li><a href="#"><i>üìÖ</i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a></li>
        <li><a href="/live"><i>üë®‚Äç‚öïÔ∏è</i> ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏</a></li>
        <li><a href="#"><i>‚è∞</i> ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</a></li>
        <li><a href="/notice"><i>üë•</i> ‡¶®‡ßã‡¶ü‡¶ø‡¶∏</a></li>
        <li><a href="/settings"><i>‚öôÔ∏è</i> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</a></li>
      </ul>
    </nav>
    
    <main class="admin-main">
      
      <div class="summary-cards">
        <div class="card called-apps">
            <div class="card-title">‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>
            <div class="card-count" id="called-count">‡ß¶</div>
        </div>
        <div class="card not-called-apps">
            <div class="card-title">‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º ‡¶®‡¶ø</div>
            <div class="card-count" id="not-called-count">‡ß¶</div>
        </div>
        <div class="card token-given-apps">
            <div class="card-title">‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>
            <div class="card-count" id="token-given-count">‡ß¶</div>
        </div>
         <div class="card token-not-given-apps">
            <div class="card-title">‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</div>
            <div class="card-count" id="token-not-given-count">‡ß¶</div>
        </div>
      </div>

        <div class="admin-table-section">
            <h1>‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h1>

            <div class="filter-controls">
                <div>
               
                    <select id="dayFilterAppointments">
                        <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶¶‡¶ø‡¶®</option>
                        <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞ </option>
                        <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞ </option>
                    </select>
                </div>
                <div>
             
                    <select id="typeFilterAppointments">
                        <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶ß‡¶∞‡¶®</option>
                        <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ </option>
                        <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶®</option>
                        </select>
                </div>
                <div>
           
                    <select id="time-filter">
                        <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>
                    </select>
                </div>
                <div>
        
                    <select id="call-status-filter">
                        <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</option>
                        <option value="called">‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</option>
                        <option value="not_called">‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</option>
                    </select>
                </div>
                <div>
              
                    <select id="token-status-filter">
                        <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</option>
                        <option value="given">‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</option>
                        <option value="not_given">‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</option>
                    </select>
                </div>
                <div id="search-filter-wrapper">
          
                    <input type="text" id="search-filter" placeholder="üîç‡¶®‡¶æ‡¶Æ, ‡¶´‡ßã‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
                </div>
            </div>
            
            <div id="status-message" class="status-message" style="display: none;"></div>

            <div id="loading-message">
                ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </div>

            <div style="overflow-x: auto;"> <table class="appointment-table" id="appointment-list" style="display: none;">
                    <thead>
                        <tr>
                            <th>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</th>
                            <th>‡¶ï‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                            <th>‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                            <th>‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                            <th>‡¶¨‡¶Ø‡¶º‡¶∏</th>
                            <th>‡¶´‡ßã‡¶®</th>
                            <th>‡¶¶‡¶ø‡¶®/‡¶∏‡¶Æ‡¶Ø‡¶º</th>
                            <th>‡¶ß‡¶∞‡¶®</th> 
                            <th>‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                            <th>‡¶ï‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            <th>‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

    </main>
  </div>

  <script>
    // =======================================================
    //                   ‡ßß. ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
    // =======================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCUGkcHFSYVmA0KUSRHhY-ZFFAS6jpJe4M",
        authDomain: "doctor-appointment-syste-23828.firebaseapp.com",
        projectId: "doctor-appointment-syste-23828",
        storageBucket: "doctor-appointment-syste-23828.appspot.com",
        messagingSenderId: "79600391014",
        appId: "1:79600391014:web:9688db8bb62f431ae16ea7"
    };

    let db;
    let allAppointmentsSnapshot; 
    try {
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore(app);
        console.log("‚úÖ Firebase initialized for Admin Panel");
    } catch (e) {
        console.error("‚ùå Firebase initialization error:", e);
    }
    
    // DOM ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® (‡ß™‡¶ü‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶π ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá)
    const loadingMessage = document.getElementById('loading-message');
    const appointmentTable = document.getElementById('appointment-list');
    const tableBody = appointmentTable.querySelector('tbody');
    const statusMessageDiv = document.getElementById('status-message');
    
    const dayFilterAppointments = document.getElementById('dayFilterAppointments');
    const typeFilterAppointments = document.getElementById('typeFilterAppointments');
    
    const timeFilter = document.getElementById('time-filter');
    const callStatusFilter = document.getElementById('call-status-filter');
    const tokenStatusFilter = document.getElementById('token-status-filter');
    const searchFilter = document.getElementById('search-filter'); 
    
    // ‡ß™‡¶ü‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ID
    const calledCountCard = document.getElementById('called-count');
    const notCalledCountCard = document.getElementById('not-called-count');
    const tokenGivenCountCard = document.getElementById('token-given-count');
    const tokenNotGivenCountCard = document.getElementById('token-not-given-count');

    // ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡¶Ø‡¶º‡¶ï‡¶∞‡¶£ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    const toBengaliNumber = (num) => {
        if (num === null || num === undefined || num === '‚Äî') return '‚Äî';
        const numStr = String(num); 
        const bengaliMap = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
        return numStr.replace(/\d/g, digit => bengaliMap[digit]);
    };

    const formatTimestamp = (timestamp) => {
        if (!timestamp || !timestamp.toDate) return '‚Äî';
        const date = timestamp.toDate();
        return date.toLocaleString('bn-BD', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second :'2-digit',
            hour12: true
        }).replace(/\d/g, toBengaliNumber);
    };
    
    // ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
    const getAgeDisplay = (data) => {
        const years = data.ageYears;
        const months = data.ageMonths;
        const days = data.ageDays;
        let ageDisplay = '';

        if (years !== undefined || months !== undefined || days !== undefined) {
            let tempAge = '';
            if (years > 0) {
                tempAge += `${toBengaliNumber(years)} ‡¶¨‡¶õ‡¶∞`;
            }
            if (months > 0) {
                if (tempAge) tempAge += ', ';
                tempAge += `${toBengaliNumber(months)} ‡¶Æ‡¶æ‡¶∏`;
            }
            if (days > 0) {
                if (tempAge) tempAge += ', ';
                tempAge += `${toBengaliNumber(days)} ‡¶¶‡¶ø‡¶®`;
            }
            ageDisplay = tempAge;
        } 
        else if (data.age) {
            if (typeof data.age === 'number' && data.age > 0 && data.age <= 150) {
                ageDisplay = `${toBengaliNumber(data.age)} ‡¶¨‡¶õ‡¶∞`;
            } else if (typeof data.age === 'string' && data.age.trim() !== '') {
                 ageDisplay = data.age;
            }
        }
        
        return ageDisplay || '‚Äî';
    };

    // =======================================================
    //                  ‡ß®. ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶°‡¶ø‡¶™‡ßá‡¶®‡ßç‡¶°‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶∞‡ßç‡¶ü‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
    // =======================================================
    
    // ‡¶á‡¶â‡¶®‡¶ø‡¶ï ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ 
    function populateDynamicFilters(snapshot) {
        const selectedDay = dayFilterAppointments.value;
        const selectedType = typeFilterAppointments.value;
        const uniqueTimes = new Set();
        
        snapshot.forEach(doc => {
            const data = doc.data();
            
            let dayMatch = (selectedDay === 'all' || (data.day || '').trim() === selectedDay);
            const dataCategory = (data.patientType || data.type || '').trim();
            let typeMatch = (selectedType === 'all' || dataCategory === selectedType);

            if (dayMatch && typeMatch && data.time) {
                uniqueTimes.add(data.time.trim());
            }
        });

        // ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶ó‡ßÅ‡¶≤‡ßã‡¶ï‡ßá ‡¶∏‡¶ï‡¶æ‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶æ‡¶§ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ï‡ßç‡¶∞‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã (‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
        const sortedTimes = Array.from(uniqueTimes).sort((a, b) => {
            // ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ/‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø‡¶§‡ßá AM/PM ‡¶∏‡¶π ‡¶™‡ßÅ‡¶∞‡ßã ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç‡¶ü‡¶ø‡¶ï‡ßá Date ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ
            const timeA = new Date(`2000/01/01 ${a}`); 
            const timeB = new Date(`2000/01/01 ${b}`);
            
            // ‡¶Ø‡¶¶‡¶ø Date ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º (‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü), ‡¶§‡¶¨‡ßá ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶ï‡¶Æ‡ßç‡¶™‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá
            if (isNaN(timeA) || isNaN(timeB)) {
                // ‡¶è‡¶ü‡¶ø ‡¶¨‡ßá‡¶∂‡¶ø‡¶∞‡¶≠‡¶æ‡¶ó ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡ßç‡¶∞‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶∏‡¶æ‡¶ú‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡ßá‡¶Ø‡¶º
                return a.localeCompare(b, 'en', { numeric: true }); 
            }
            
            return timeA - timeB; // ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ
        });


        const currentSelectedTime = timeFilter.value;
        timeFilter.innerHTML = '<option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>';
        
        sortedTimes.forEach(time => {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            if (time === currentSelectedTime) option.selected = true; 
            timeFilter.appendChild(option);
        });
        
        renderAppointments(allAppointmentsSnapshot);
    }

    // =======================================================
    //                  ‡ß©. ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
    // =======================================================

    function renderAppointments(querySnapshot) {
        
        // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶®‡ßá‡¶ì‡ßü‡¶æ
        const selectedDateFilter = dayFilterAppointments.value;
        const selectedCategoryFilter = typeFilterAppointments.value;
        const selectedTimeFilter = timeFilter.value;
        const selectedCallStatus = callStatusFilter.value;
        const selectedTokenStatus = tokenStatusFilter.value;
        const searchTerm = searchFilter.value.toLowerCase().trim();
        
        let filteredDocs = [];
        let calledCount = 0;
        let notCalledCount = 0;
        let tokenGivenCount = 0;
        let tokenNotGivenCount = 0;

        querySnapshot.forEach(doc => {
            const data = doc.data();
            let isPrimaryFilterMatch = true;
            
            // --- ‡ßß. ‡¶¶‡¶ø‡¶®, ‡¶ß‡¶∞‡¶®, ‡¶ì ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (Primary Filter) ---
            if (selectedDateFilter !== 'all' && (data.day || '').trim() !== selectedDateFilter) { 
                isPrimaryFilterMatch = false; 
            }
            
            if (isPrimaryFilterMatch && selectedCategoryFilter !== 'all') {
                const dataCategory = (data.patientType || data.type || '').trim();
                if (dataCategory !== selectedCategoryFilter) {
                    isPrimaryFilterMatch = false;
                }
            }

            if (isPrimaryFilterMatch && selectedTimeFilter !== 'all') {
                if ((data.time || '').trim() !== selectedTimeFilter.trim()) {
                    isPrimaryFilterMatch = false;
                }
            }

            // *** ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï: ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡ßã ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶π‡¶¨‡ßá ***
            if (isPrimaryFilterMatch) {
                if (data.called === true) {
                    calledCount++; 
                } else {
                    notCalledCount++; 
                }
                
                if (data.tokenGiven === true) { 
                    tokenGivenCount++;
                } else {
                    tokenNotGivenCount++;
                }
            }

            // `isMatch` ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞, ‡¶ß‡¶∞‡¶®, ‡¶∏‡¶Æ‡¶Ø‡¶º, ‡¶ï‡¶≤, ‡¶ü‡ßã‡¶ï‡ßá‡¶®, ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶∏‡¶π)
            let isMatch = isPrimaryFilterMatch;
            
            // --- ‡ß™. ‡¶ï‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (Secondary Filter) ---
            if (isMatch && selectedCallStatus !== 'all') {
                const isCalled = data.called === true;
                if (selectedCallStatus === 'called' && !isCalled) {
                    isMatch = false;
                } else if (selectedCallStatus === 'not_called' && isCalled) {
                    isMatch = false;
                }
            }

            // --- ‡ß´. ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (Secondary Filter) ---
            if (isMatch && selectedTokenStatus !== 'all') {
                const isTokenGiven = data.tokenGiven === true;
                if (selectedTokenStatus === 'given' && !isTokenGiven) {
                    isMatch = false;
                } else if (selectedTokenStatus === 'not_given' && isTokenGiven) {
                    isMatch = false;
                }
            }

            // --- ‡ß¨. ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ---
            if (isMatch && searchTerm) {
                const name = (data.name || '').toLowerCase();
                const phone = (data.phone ? String(data.phone) : '');
                const serial = (data.serial ? String(data.serial) : '');
                
                if (
                    !name.includes(searchTerm) && 
                    !phone.includes(searchTerm) && 
                    !serial.includes(searchTerm)
                ) {
                    isMatch = false;
                }
            }
            
            if (isMatch) {
                filteredDocs.push(doc);
            }
        });

        tableBody.innerHTML = ''; 
        
        // ‡ß™ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ 
        calledCountCard.textContent = toBengaliNumber(calledCount);
        notCalledCountCard.textContent = toBengaliNumber(notCalledCount);
        tokenGivenCountCard.textContent = toBengaliNumber(tokenGivenCount);
        tokenNotGivenCountCard.textContent = toBengaliNumber(tokenNotGivenCount);
        
        const totalPrimaryFilteredCount = calledCount + notCalledCount;

        // ‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶ø‡¶§ ‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        statusMessageDiv.textContent = `‡¶Æ‡ßã‡¶ü ‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç: ${toBengaliNumber(totalPrimaryFilteredCount)} ‡¶ü‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶ø‡¶§: ${toBengaliNumber(filteredDocs.length)} ‡¶ü‡¶ø‡•§`;


        if (filteredDocs.length === 0) {
            loadingMessage.textContent = "‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
            loadingMessage.style.display = 'block';
            appointmentTable.style.display = 'none';
            statusMessageDiv.style.display = 'none'; 
            return;
        } else {
             loadingMessage.style.display = 'none';
             statusMessageDiv.style.display = 'block';
             appointmentTable.style.display = 'table';
        }
        
        filteredDocs.forEach(doc => {
            const data = doc.data();
            const docId = doc.id; 
            
            // --- ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶≤‡¶ú‡¶ø‡¶ï ---
            const isCalled = data.called === true;
            const callStatusClass = isCalled ? 'status-called' : 'status-not-called';
            const callStatusText = isCalled ? '‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá' : '‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø';
            const callButtonText = isCalled ? '‡¶Ü‡¶®‡¶°‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®';
            const callButtonClass = isCalled ? 'btn-call-undo' : 'btn-call';

            const isTokenGiven = data.tokenGiven === true;
            const tokenStatusClass = isTokenGiven ? 'status-token-given' : 'status-token-not-given';
            const tokenStatusText = isTokenGiven ? '‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá' : '‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø';
            const tokenButtonText = isTokenGiven ? '‡¶Ü‡¶®‡¶°‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶¶‡¶ø‡¶®';
            const tokenButtonClass = isTokenGiven ? 'btn-token-undo' : 'btn-token';
            
            const ageToDisplay = getAgeDisplay(data); 

            const categoryValue = (data.patientType || data.type || '').trim();
            let categoryText = '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£';
            if (categoryValue === 'new') {
                categoryText = '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
            } else if (categoryValue === 'old') {
                categoryText = '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶®';
            }

            const row = tableBody.insertRow();
            
            // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶∞‡ßã ‡¶§‡ßà‡¶∞‡¶ø
            row.innerHTML = `
                <td>${toBengaliNumber(data.serial || 'N/A')}</td>
                <td><span class="status-badge ${callStatusClass}">${callStatusText}</span></td>
                <td><span class="status-badge ${tokenStatusClass}">${tokenStatusText}</span></td>
                <td>${data.name || '‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á'}</td>
                <td>${ageToDisplay}</td>
                <td>${data.phone ? toBengaliNumber(data.phone) : '‚Äî'}</td>
                <td>${data.day || '‚Äî'}, ${data.time || '‚Äî'}</td>
                <td>${categoryText}</td> 
                <td>${formatTimestamp(data.timestamp)}</td>
                
                <td>
                    <button class="action-btn ${callButtonClass}" 
                            data-id="${docId}" 
                            data-field="called" 
                            data-status="${isCalled ? 'true' : 'false'}">
                        ${callButtonText}
                    </button>
                </td>
                <td>
                    <button class="action-btn ${tokenButtonClass}" 
                            data-id="${docId}" 
                            data-field="tokenGiven" 
                            data-status="${isTokenGiven ? 'true' : 'false'}">
                        ${tokenButtonText}
                    </button>
                </td>
            `;

            // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
            const actionBtns = row.querySelectorAll('.action-btn');
            actionBtns.forEach(btn => {
                btn.addEventListener('click', () => updateStatus(btn));
            });
        });
    }

    // =======================================================
    //                  ‡ß™. ‡¶ü‡¶ó‡¶≤ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï
    // =======================================================

    async function updateStatus(buttonElement) {
        if (!db) return;

        const docId = buttonElement.getAttribute('data-id');
        const field = buttonElement.getAttribute('data-field'); 
        const currentStatusString = buttonElement.getAttribute('data-status');
        
        const isCurrentlyTrue = currentStatusString === 'true';
        const newStatus = !isCurrentlyTrue; 

        const originalText = buttonElement.textContent;
        buttonElement.textContent = '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
        buttonElement.disabled = true;

        try {
            const docRef = db.collection('appointments').doc(docId);
            
            const updateData = {};
            updateData[field] = newStatus;
            await docRef.update(updateData);
            
            // ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡•§

        } catch (error) {
            console.error(`‚ùå Error updating ${field} status:`, error);
            alert(`‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
            buttonElement.textContent = originalText;
            buttonElement.disabled = false;
        }
    }


    // =======================================================
    //                    ‡ß´. ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶ì ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
    // =======================================================
    function setupRealtimeListener() {
        if (!db) return;

        const appointmentsRef = db.collection('appointments');
        
        appointmentsRef.orderBy('serial', 'asc').onSnapshot(snapshot => {
            console.log('üîÑ Appointment data updated in real-time.');
            allAppointmentsSnapshot = snapshot; 
            // ‡¶¶‡¶ø‡¶®/‡¶ß‡¶∞‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡¶™‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá, ‡¶Ø‡¶æ ‡¶™‡¶∞‡ßá renderAppointments ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá
            populateDynamicFilters(allAppointmentsSnapshot);
        }, err => {
            console.error("‚ùå Realtime listener error:", err);
            loadingMessage.textContent = "‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ (‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶ï‡¶æ‡¶∞‡¶£: ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞‡¶ø‡¶ü‡¶ø ‡¶∞‡ßÅ‡¶≤‡¶∏)";
        });
    }
    
    // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
    function setupFilterListeners() {
        // ‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ß‡¶∞‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá, ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶™‡¶™‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá
        dayFilterAppointments.addEventListener('change', () => {
            if (allAppointmentsSnapshot) {
                populateDynamicFilters(allAppointmentsSnapshot);
            }
        });
        
        typeFilterAppointments.addEventListener('change', () => {
            if (allAppointmentsSnapshot) {
                populateDynamicFilters(allAppointmentsSnapshot);
            }
        });
        
        // ‡¶∏‡¶Æ‡¶Ø‡¶º, ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡¶¨‡ßá
        const secondaryFilters = [timeFilter, callStatusFilter, tokenStatusFilter, searchFilter];
        
        secondaryFilters.forEach(filter => {
            filter.addEventListener('change', () => {
                if (allAppointmentsSnapshot) {
                    renderAppointments(allAppointmentsSnapshot);
                }
            });
        });
        
        searchFilter.addEventListener('input', () => {
            if (allAppointmentsSnapshot) {
                renderAppointments(allAppointmentsSnapshot);
            }
        });

         // Mobile Menu Button Logic 
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
          document.getElementById('sidebar').classList.toggle('mobile-open');
        });
        
        // Logout Button (Placeholder)
        document.getElementById('logoutBtn').addEventListener('click', () => {
             alert('‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®'); 
        });
    }


    // =======================================================
    //                    ‡ß¨. ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ
    // =======================================================
    document.addEventListener('DOMContentLoaded', function() {
        
        setTimeout(() => {
            if (db) {
                setupRealtimeListener();
                setupFilterListeners();
            } else {
                loadingMessage.textContent = "‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: Firebase ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
            }
        }, 1000); 
    });
  </script>
</body>
</html>
