<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- SweetAlert2 for beautiful popups -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --gray: #6b7280;
      --light-gray: #f3f4f6;
      --white: #ffffff;
      --dark: #1f2937;
      --present: #10b981;
      --absent: #ef4444;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans Bengali', sans-serif;
      background-color: #f5f7fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Admin Container */
    .admin-container {
      display: flex;
      flex: 1;
      margin-top: 60px; /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ */
      height: calc(100vh - 60px);
    }
    
    /* Main Content */
    .admin-main {
      flex: 1;
      padding: 20px;
      background-color: #f9fafb;
      overflow-y: auto;
    }
    
    .page-title {
      color: var(--dark);
      margin-bottom: 25px;
      font-size: 24px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--light-gray);
    }
    
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background-color: var(--white);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card h3 {
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .card p {
      font-size: 28px;
      font-weight: 700;
    }
    
    .card.thursday p {
      color: var(--primary);
    }
    
    .card.friday p {
      color: #8b5cf6;
    }

    .card.available p {
      color: var(--success);
    }

    .card.pending p {
      color: #4169E1;
    }
    
    .card.total p {
      color: var(--warning);
    }
    
    .card.present p {
      color: var(--present);
    }
    
    .card.absent p {
      color: var(--absent);
    }
    
    /* Alert Messages */
    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .alert-success {
      background-color: #dcfce7;
      color: var(--success);
      border: 1px solid #bbf7d0;
    }
    
    .alert-error {
      background-color: #fee2e2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }
    
    /* Bulk Actions */
    .bulk-actions {
      background-color: var(--white);
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 15px;
      display: none; /* ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã */
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .bulk-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .bulk-buttons {
      display: flex;
      gap: 10px;
    }
    
    /* Appointments Table Styles */
    .appointments-management {
      margin-top: 20px;
    }
    
    .appointments-management .admin-table {
      width: 100%;
      background-color: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    
    .appointments-management .admin-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .appointments-management .admin-table-header h2 {
      font-size: 18px;
      color: var(--dark);
    }
    
    .appointments-management .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .appointments-management .filter-group {
      display: flex;
      gap: 10px;
    }
    
    .appointments-management .filter-group select {
      padding: 8px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Noto Sans Bengali', sans-serif;
      background-color: var(--white);
      cursor: pointer;
    }
    
    .appointments-management .filter-group select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .appointments-management .search-box {
      position: relative;
    }
    
    .appointments-management .search-box input {
      padding: 8px 15px 8px 35px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Noto Sans Bengali', sans-serif;
      width: 250px;
    }
    
    .appointments-management .search-box input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .appointments-management .search-box i {
      position: absolute;
      left: 12px;
      top: 10px;
      color: var(--gray);
    }
    
    .appointments-management .export-btn {
      background-color: var(--success);
      color: var(--white);
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .appointments-management .export-btn:hover {
      background-color: #15803d;
    }
    
    .appointments-management .add-appointment-btn {
      background-color: var(--primary);
      color: var(--white);
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }
    
    .appointments-management .add-appointment-btn:hover {
      background-color: var(--primary-hover);
    }
    
    .appointments-management .table-container {
      overflow-x: auto;
    }
    
    .appointments-management table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }
    
    .appointments-management th, 
    .appointments-management td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .appointments-management th {
      background-color: var(--light-gray);
      font-weight: 600;
      color: var(--dark);
    }
    
    .appointments-management tr:hover {
      background-color: #f9fafb;
    }
    
    /* Checkbox styling */
    .appointment-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Select all checkbox in header */
    .select-all-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    /* Row with Present Status - GREEN BACKGROUND */
    tr.present-row {
      background-color: #f0fdf4 !important;
    }
    
    tr.present-row:hover {
      background-color: #dcfce7 !important;
    }
    
    /* Action Buttons */
    .appointments-management .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 13px;
      margin-right: 5px;
      transition: all 0.2s ease;
    }
    
    .appointments-management .edit-btn {
      background-color: #bfdbfe;
      color: var(--primary);
    }
    
    .appointments-management .edit-btn:hover {
      background-color: #93c5fd;
    }
    
    .appointments-management .delete-btn {
      background-color: #fee2e2;
      color: var(--danger);
    }
    
    .appointments-management .delete-btn:hover {
      background-color: #fecaca;
    }
    
    /* Bulk Action Buttons */
    .bulk-delete-btn {
      background-color: var(--danger);
      color: var(--white);
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .bulk-delete-btn:hover {
      background-color: #b91c1c;
    }
    
    .clear-selection-btn {
      background-color: var(--gray);
      color: var(--white);
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
    }
    
    .clear-selection-btn:hover {
      background-color: #4b5563;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: var(--white);
      padding: 25px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      max-height: 90vh;
      overflow-y: auto;
      animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: var(--dark);
      font-size: 20px;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--gray);
    }
    
    .close-btn:hover {
      color: var(--dark);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 14px;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .form-actions button {
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Noto Sans Bengali', sans-serif;
      font-weight: 600;
      border: none;
      transition: background-color 0.2s ease;
    }
    
    .submit-btn {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .submit-btn:hover {
      background-color: var(--primary-hover);
    }
    
    .cancel-btn-modal {
      background-color: var(--light-gray);
      color: var(--dark);
    }
    
    .cancel-btn-modal:hover {
      background-color: #e5e7eb;
    }
    
    /* Serial Grid in Edit Modal */
    .serial-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 8px;
      margin: 15px 0;
      max-height: 250px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    
    .serial-item {
      padding: 10px;
      text-align: center;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: var(--white);
      font-weight: 500;
      font-size: 14px;
    }
    
    .serial-item.available {
      background-color: #dcfce7;
      color: var(--success);
      border-color: var(--success);
    }
    
    .serial-item.available:hover {
      background-color: #bbf7d0;
      transform: scale(1.05);
    }
    
    .serial-item.selected {
      background-color: #fef3c7;
      color: var(--warning);
      border-color: var(--warning);
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }
    
    .serial-item.pending {
      background-color: #dbeafe;
      color: var(--primary);
      border-color: var(--primary);
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .serial-item.booked {
      background-color: #fecaca;
      color: var(--danger);
      border-color: var(--danger);
      cursor: not-allowed;
      opacity: 0.8;
    }
    
    /* Export Options */
    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .export-option {
      background-color: var(--light-gray);
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .export-option:hover {
      background-color: #e5e7eb;
      transform: translateY(-2px);
    }
    
    .export-option i {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }
    
    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

      /* ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
  .date-filter-appointments {
    padding: 8px 15px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-family: 'Noto Sans Bengali', sans-serif;
    background-color: var(--white);
    cursor: pointer;
    min-width: 150px;
  }
  
  .date-filter-appointments:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  /* ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ï ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
  input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    background-color: var(--light-gray);
  }
  
  input[type="date"]::-webkit-calendar-picker-indicator:hover {
    background-color: #e5e7eb;
  }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .admin-main {
        padding: 15px;
      }
      
      .dashboard-cards {
      grid-template-columns: 1fr 1fr;
      }
      
      .card {
        padding: 15px;
      }
      
      .bulk-actions {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .bulk-buttons {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .appointments-management .admin-table-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .appointments-management .header-actions {
        flex-direction: column;
        width: 100%;
        gap: 10px;
      }
      
      .appointments-management .filter-group {
        flex-wrap: wrap;
        width: 100%;
        gap: 8px;
      }
      
      .appointments-management .filter-group select {
        flex: 1;
        min-width: 120px;
        font-size: 14px;
        padding: 8px 12px;
      }
      
      .appointments-management .search-box {
        width: 100%;
      }
      
      .appointments-management .search-box input {
        width: 100%;
        font-size: 14px;
      }
      
      .appointments-management .export-btn,
      .appointments-management .add-appointment-btn {
        width: 100%;
        padding: 10px;
        text-align: center;
      }
      
      .modal-content {
        margin: 10px;
        width: calc(100% - 20px);
        padding: 15px;
      }
      
      .serial-grid {
        grid-template-columns: repeat(7, 1fr);
      }
      
      .appointments-management th, 
      .appointments-management td {
        padding: 10px 12px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 480px) {
      .admin-main {
        padding: 10px;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .page-title {
        font-size: 20px;
      }
      
      .appointments-management .filter-group select {
        min-width: 100px;
        font-size: 13px;
        padding: 6px 10px;
      }
      
      .modal-content {
        margin: 5px;
        width: calc(100% - 10px);
        padding: 12px;
      }
      
      .serial-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 4px;
      }
      
      .appointments-management .action-btn {
        padding: 4px 8px;
        font-size: 12px;
        margin-right: 3px;
        margin-bottom: 3px;
      }
    }
  </style>
</head>
<body data-auto-load-components="true">
  <!-- ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
  <div id="header-container"></div>
  
  <!-- Admin Container -->
  <div class="admin-container">
    <!-- ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
    <div id="sidebar-container"></div>
    
    <!-- Main Content -->
    <main class="admin-main">
      <!-- Alert Messages Container -->
      <div id="alertContainer"></div>
      
      <!-- Dashboard Cards -->
      <div class="dashboard-cards">
        <!-- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
        <div class="card thursday">
          <h3>‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
          <p id="thursdayAppointments">0</p>
        </div>
        
        <div class="card friday">
          <h3>‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
          <p id="fridayAppointments">0</p>
        </div>
        
        <div class="card total-appointments">
          <h3>‡¶Æ‡ßã‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
          <p id="totalAppointments">0</p>
        </div>
        
        <!-- ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
        <div class="card pending">
          <h3>‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</h3>
          <p id="pendingSerials">0</p>
        </div>
        <div class="card available">
          <h3>‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</h3>
          <p id="availableSerials">0</p>
        </div>
        <div class="card total">
          <h3>‡¶Æ‡ßã‡¶ü ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡ßá‡¶û‡ßç‡¶ú</h3>
          <p id="totalSerials">0</p>
        </div>
      </div>
      
      <!-- Bulk Actions (‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã) -->
      <div class="bulk-actions" id="bulkActions">
        <input type="checkbox" id="selectAll" class="bulk-checkbox">
        <span id="selectedCount">0‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°</span>
        <div class="bulk-buttons">
          <button class="bulk-delete-btn" id="deleteSelectedBtn">
            <i>üóëÔ∏è</i> ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
          </button>
          <button class="clear-selection-btn" id="clearSelectionBtn">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞</button>
        </div>
      </div>
      
      <!-- Appointments Management Section -->
      <div class="appointments-management">
        <div class="admin-table">
          <div class="admin-table-header">
            <h2>‡¶∏‡¶ï‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
            <div class="header-actions">
              <div class="filter-group">
                <input type="date" id="dateFilter" class="date-filter-appointments">

                <select class="type-filter-appointments">
                  <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶ß‡¶∞‡¶®</option>
                  <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
                  <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
                </select>
                <select id="timeFilterSerial" class="time-filter">
                  <option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>
                </select>
              </div>
              <div class="search-box">
                <i>üîç</i>
                <input type="text" class="search-appointments" placeholder="‡¶®‡¶æ‡¶Æ, ‡¶´‡ßã‡¶® ‡¶¨‡¶æ ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
              </div>
              <button class="export-btn" id="exportAppointmentsBtn">
                <i>üì•</i> ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
              </button>
              <button class="add-appointment-btn" id="addAppointmentBtn">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th width="50">
                    <input type="checkbox" class="select-all-checkbox" id="selectAllAppointments">
                  </th>
                  <th>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤</th>
                  <th>‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                  <th>‡¶¨‡ßü‡¶∏</th>
                  <th>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
                  <th>‡¶¶‡¶ø‡¶®</th>
                  <th>‡¶∏‡¶Æ‡¶Ø‡¶º</th>
                  <th>‡¶ß‡¶∞‡¶®</th>
                  <th>‡¶≠‡¶ø‡¶ú‡¶ø‡¶ü‡¶ø ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                  <th>‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                  <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                </tr>
              </thead>
              <tbody id="appointmentsTableBody">
                <tr>
                  <td colspan="10" style="text-align: center; padding: 20px; color: #6b7280;">
                    ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
     <!-- Edit Appointment Modal -->
<div class="modal" id="editAppointmentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
      <button class="close-btn" id="closeEditModal">&times;</button>
    </div>
    <form id="editAppointmentForm">
      <input type="hidden" id="editAppointmentId">
      
      <div class="form-group">
        <label for="editName">‡¶∞‡ßã‡¶ó‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
        <input type="text" id="editName" required>
      </div>
      
      <div class="form-group">
        <label for="editAge">‡¶¨‡ßü‡¶∏</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <div style="flex: 1;">
            <input type="number" id="editAgeYears" min="0" max="120" placeholder="‡¶¨‡¶õ‡¶∞" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
          </div>
          <div style="flex: 1;">
            <input type="number" id="editAgeMonths" min="0" max="11" placeholder="‡¶Æ‡¶æ‡¶∏" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
          </div>
          <div style="flex: 1;">
            <input type="number" id="editAgeDays" min="0" max="30" placeholder="‡¶¶‡¶ø‡¶®" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
          </div>
        </div>
        <input type="hidden" id="editAge" value="">
      </div>
      
      <div class="form-group">
        <label for="editPhone">‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
        <input type="text" id="editPhone" required>
      </div>
      
      <!-- ‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶ß‡¶∞‡¶® -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div class="form-group">
          <label for="editDay">‡¶¶‡¶ø‡¶®</label>
          <select id="editDay" required>
            <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="Thursday">‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞</option>
            <option value="Friday">‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editType">‡¶ß‡¶∞‡¶®</label>
          <select id="editType" required>
            <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
            <option value="new">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
            <option value="old">‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ</option>
          </select>
        </div>
      </div>
      
      <!-- ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡ßç‡¶≤‡¶ü -->
      <div class="form-group">
        <label for="editTime">‡¶∏‡¶Æ‡¶Ø‡¶º</label>
        <select id="editTime" required>
          <option value="">-- ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
        </select>
      </div>
      
      <!-- ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ó‡ßç‡¶∞‡¶ø‡¶° -->
      <div class="form-group">
        <label for="editSerial">‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
        <div class="serial-grid" id="editSerialGrid">
          <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--gray);">
            ‡¶¶‡¶ø‡¶®, ‡¶ß‡¶∞‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
          </div>
        </div>
        <input type="hidden" id="editSerial" value="">
      </div>
      
      <div class="form-actions">
        <button type="button" class="cancel-btn-modal" id="cancelEditModal">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        <button type="submit" class="submit-btn" id="submitEditBtn">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </form>
  </div>
</div>

  <!-- Export Modal -->
  <div class="modal" id="exportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶Ö‡¶™‡¶∂‡¶®</h2>
        <button class="close-btn" id="closeExportModal">&times;</button>
      </div>
      <div class="export-options">
        <div class="export-option" data-format="pdf">
          <i>üìÑ</i>
          <div>PDF</div>
        </div>
        <div class="export-option" data-format="excel">
          <i>üìä</i>
          <div>Excel</div>
        </div>
       <div class="export-option" data-format="word">
          <i>üìù</i>
          <div>Word</div>
        </div>
       <div class="export-option" data-format="docs">
         <i>üìã</i>
         <div>Docs</div>
       </div>
      </div>
    </div>
  </div>

  <!-- ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
  <div id="footer-container"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <!-- ‡¶ï‡¶Æ‡ßç‡¶™‡ßã‡¶®‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶°‡¶æ‡¶∞ -->
  <script src="components-inline.js"></script>
  <script src="grid.js"></script>

<script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCUGkcHFSYVmA0KUSRHhY-ZFFAS6jpJe4M",
      authDomain: "doctor-appointment-syste-23828.firebaseapp.com",
      projectId: "doctor-appointment-syste-23828",
      storageBucket: "doctor-appointment-syste-23828.appspot.com",
      messagingSenderId: "79600391014",
      appId: "1:79600391014:web:9688db8bb62f431ae16ea7"
    };

    // Global variables
    let db;
    let realtimeListeners = [];
    let appointmentsManager = null;
    let selectedAppointments = new Set();
    let searchTimer;
    let serialRanges = {
      Thursday: {
        new: {},
        old: {}
      },
      Friday: {
        new: {},
        old: {}
      }
    };
    let pendingSelections = {};
    let adminSessionId = 'admin_' + Date.now();
    let editGridSystem = null; // Edit Modal ‡¶ó‡ßç‡¶∞‡¶ø‡¶° ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

    // ==================== UTILITY FUNCTIONS ====================
    function showAlert(message, type = 'success') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      document.getElementById('alertContainer').appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function showConfirmation(title, text, confirmButtonText = '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å', cancelButtonText = '‡¶®‡¶æ') {
      return Swal.fire({
        title: title,
        text: text,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#2563eb',
        cancelButtonColor: '#dc2626',
        confirmButtonText: confirmButtonText,
        cancelButtonText: cancelButtonText,
        backdrop: true,
        allowOutsideClick: false,
        allowEscapeKey: false
      });
    }

    function validateBangladeshiPhone(phone) {
      return /^(?:\+88|01)[3-9]\d{8}$/.test(phone.replace(/\s/g, ''));
    }

    function formatAge(years, months, days) {
      let ageString = '';
      if (years > 0) ageString += `${years} ‡¶¨‡¶õ‡¶∞`;
      if (months > 0) ageString += `${ageString ? ', ' : ''}${months} ‡¶Æ‡¶æ‡¶∏`;
      if (days > 0) ageString += `${ageString ? ', ' : ''}${days} ‡¶¶‡¶ø‡¶®`;
      return ageString || 'N/A';
    }

    function parseAgeString(ageString) {
      if (!ageString) return { years: 0, months: 0, days: 0 };
      
      let years = 0, months = 0, days = 0;
      
      if (ageString.includes('‡¶¨‡¶õ‡¶∞')) {
        const match = ageString.match(/(\d+)\s*‡¶¨‡¶õ‡¶∞/);
        years = match ? parseInt(match[1]) : 0;
      }
      if (ageString.includes('‡¶Æ‡¶æ‡¶∏')) {
        const match = ageString.match(/(\d+)\s*‡¶Æ‡¶æ‡¶∏/);
        months = match ? parseInt(match[1]) : 0;
      }
      if (ageString.includes('‡¶¶‡¶ø‡¶®')) {
        const match = ageString.match(/(\d+)\s*‡¶¶‡¶ø‡¶®/);
        days = match ? parseInt(match[1]) : 0;
      }
      
      return { years, months, days };
    }

    function formatDateTime(date) {
      if (!date) return 'N/A';
      const d = new Date(date);
      return d.toLocaleString('bn-BD', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (12:00 AM ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ - ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá)
    function sortTimes(times) {
      return times.sort((a, b) => {
        // Convert to 24-hour format for proper sorting
        const convertTo24Hour = (timeStr) => {
          const time = timeStr.toUpperCase();
          const [timePart, modifier] = time.split(' ');
          let [hours, minutes] = timePart.split(':').map(Number);
          
          if (modifier === 'PM' && hours !== 12) {
            hours += 12;
          }
          if (modifier === 'AM' && hours === 12) {
            hours = 0;
          }
          
          return hours * 60 + (minutes || 0);
        };
        
        const aMinutes = convertTo24Hour(a);
        const bMinutes = convertTo24Hour(b);
        
        return aMinutes - bMinutes;
      });
    }

    // ==================== ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ====================
    function getCurrentWeekDateRange() {
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0=‡¶∞‡¶¨‡¶ø, 1=‡¶∏‡ßã‡¶Æ, ..., 6=‡¶∂‡¶®‡¶ø
    
    // Find the most recent Saturday (including today if it's Saturday)
    const lastSaturday = new Date(today);
    
    // Calculate days to subtract to get to Saturday
    // If today is Saturday (6), don't subtract
    // If today is Sunday (0), subtract 1 day to get Saturday
    // etc.
    const daysSinceSaturday = (dayOfWeek + 1) % 7;
    lastSaturday.setDate(today.getDate() - daysSinceSaturday);
    lastSaturday.setHours(0, 0, 0, 0); // Set to 12:00 AM
    
    // Calculate next Friday
    const nextFriday = new Date(lastSaturday);
    nextFriday.setDate(lastSaturday.getDate() + 6); // Saturday + 6 = Friday
    nextFriday.setHours(23, 59, 59, 999); // Set to 11:59:59.999 PM
    
    return {
        startDate: lastSaturday,
        endDate: nextFriday,
        startString: formatDateForFilter(lastSaturday),
        endString: formatDateForFilter(nextFriday),
        isInCurrentWeek: function(dateToCheck) {
            const date = new Date(dateToCheck);
            return date >= lastSaturday && date <= nextFriday;
        }
    };
}

    // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡¶ï‡ßá YYYY-MM-DD ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    function formatDateForFilter(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç‡¶ï‡ßá Date ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞
    function parseDateString(dateString) {
      if (!dateString) return null;
      const [year, month, day] = dateString.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    // ==================== ‡¶¶‡¶ø‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ ====================
    function getNextDateByDay(targetDay) {
      const daysMap = {
        "Sunday": 0,
        "Monday": 1,
        "Tuesday": 2,
        "Wednesday": 3,
        "Thursday": 4,
        "Friday": 5,
        "Saturday": 6
      };
      
      const targetDayIndex = daysMap[targetDay];
      const today = new Date();
      
      const todayIndex = today.getDay();
      let daysToAdd = targetDayIndex - todayIndex;
      
      if (daysToAdd < 0) {
        daysToAdd += 7;
      }
      
      const nextDate = new Date(today);
      nextDate.setDate(today.getDate() + daysToAdd);
      
      const year = nextDate.getFullYear();
      const month = String(nextDate.getMonth() + 1).padStart(2, '0');
      const day = String(nextDate.getDate()).padStart(2, '0');
      
      const banglaMonths = [
        '‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡ßÄ', '‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡ßÄ', '‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö', '‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤', '‡¶Æ‡ßá', '‡¶ú‡ßÅ‡¶®',
        '‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á', '‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü', '‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞', '‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'
      ];
      
      const banglaDays = [
        '‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞', '‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞', 
        '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞', '‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞'
      ];
      
      const banglaDate = `${banglaDays[nextDate.getDay()]}, ${nextDate.getDate()} ${banglaMonths[nextDate.getMonth()]} ${year}`;
      
      return {
        date: nextDate,
        dateString: `${year}-${month}-${day}`,
        displayDate: nextDate.toLocaleDateString('bn-BD', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        }),
        banglaDate: banglaDate,
        isToday: daysToAdd === 0
      };
    }

    // ==================== EDIT MODAL GRID SYSTEM ====================
    function initializeEditGridSystem() {
      if (!window.db) {
        console.error('‚ùå Database not available for edit grid system');
        return;
      }

      editGridSystem = new RealTimeGridSystem({
        db: window.db,
        gridContainerId: 'editSerialGrid',
        selectedSerialInputId: 'editSerial',
        dayElementId: 'editDay',
        timeElementId: 'editTime',
        typeElementId: 'editType',
        mode: 'admin',
        adminSessionId: adminSessionId,
        userPendingExpiry: 1 * 60 * 1000,
        adminPendingExpiry: 5 * 60 * 1000,
        
        onSerialClick: function(data) {
          console.log('Edit Modal - Serial clicked:', data);
          
          if (data.status === 'booked') {
            Swal.fire({
              title: '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶¨‡ßÅ‡¶ï‡¶°',
              text: `‡¶è‡¶á ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ${data.date} ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,
              icon: 'error'
            });
          } else if (data.status === 'pending') {
            document.getElementById('editSerial').value = data.serial;
            
            // Show success message
            Swal.fire({
              title: '‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá',
              text: `‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ${data.serial} ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá`,
              icon: 'success',
              timer: 1500,
              showConfirmButton: false
            });
          }
        },
        
        onGridUpdate: function(type, data) {
          console.log('Edit Modal - Grid updated:', type, data);
          
          // Update serial input with date info
          const serialInput = document.getElementById('editSerial');
          if (serialInput && data.date) {
            serialInput.dataset.date = data.date;
          }
        }
      });
      
      editGridSystem.init().then(success => {
        if (success) {
          console.log('‚úÖ Edit Modal Grid System initialized successfully');
        } else {
          console.error('‚ùå Failed to initialize Edit Modal Grid System');
        }
      });
    }

    // ==================== ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø UI-‡¶§‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ====================
    function displayCurrentWeekInfo() {
      const currentWeek = getCurrentWeekDateRange();
      const weekInfo = document.createElement('div');
      weekInfo.id = 'currentWeekInfo';
      weekInfo.style.cssText = `
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
      `;
      
      const startDateStr = currentWeek.startDate.toLocaleDateString('bn-BD', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      const endDateStr = currentWeek.endDate.toLocaleDateString('bn-BD', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      weekInfo.innerHTML = `
        üìÖ <strong>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π:</strong> ${startDateStr} - ${endDateStr} 
        | ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶á ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá
      `;
      
      const dashboardCards = document.querySelector('.dashboard-cards');
      if (dashboardCards && !document.getElementById('currentWeekInfo')) {
        dashboardCards.parentNode.insertBefore(weekInfo, dashboardCards);
      }
    }

    function showFilteredDateInfo(dateString) {
      let filterInfo = document.getElementById('filteredDateInfo');
      
      if (!filterInfo) {
        filterInfo = document.createElement('div');
        filterInfo.id = 'filteredDateInfo';
        filterInfo.style.cssText = `
          background: linear-gradient(135deg, #10b981, #059669);
          color: white;
          padding: 10px 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        `;
        
        const dashboardCards = document.querySelector('.dashboard-cards');
        if (dashboardCards) {
          dashboardCards.parentNode.insertBefore(filterInfo, dashboardCards);
        }
      }
      
      const date = new Date(dateString);
      const dateStr = date.toLocaleDateString('bn-BD', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });
      
      filterInfo.innerHTML = `
        üîç <strong>‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${dateStr}
        | ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶è‡¶á ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá
      `;
      filterInfo.style.display = 'block';
    }

    // ==================== AUTHENTICATION CHECK ====================
    function checkAuthentication() {
      const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
      const loginTime = sessionStorage.getItem('loginTime');
      
      if (!isLoggedIn) {
        Swal.fire({
          title: 'Need Login',
          text: 'Please login first!!',
          icon: 'warning',
          confirmButtonText: 'Go to Login page'
        }).then(() => {
          window.location.href = '/login';
        });
        return false;
      }
      
      const currentTime = new Date().getTime();
      const sessionDuration = 2 * 60 * 60 * 1000;
      
      if (currentTime - parseInt(loginTime) > sessionDuration) {
        sessionStorage.clear();
        Swal.fire({
          title: 'Session expired',
          text: 'Session expired! Please login again.',
          icon: 'info',
          confirmButtonText: 'ok'
        }).then(() => {
          window.location.href = '/login';
        });
        return false;
      }
      
      return true;
    }

    // ==================== BULK ACTIONS FUNCTIONS ====================
    function updateBulkActions() {
      const count = selectedAppointments.size;
      document.getElementById('selectedCount').textContent = `${count}‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°`;
      
      if (count > 0) {
        document.getElementById('bulkActions').style.display = 'flex';
      } else {
        document.getElementById('bulkActions').style.display = 'none';
      }
    }

    async function deleteSelectedAppointments() {
      if (!db || selectedAppointments.size === 0) return;
      
      const count = selectedAppointments.size;
      const appointmentsText = count === 1 ? '‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶ü‡¶ø' : `${count}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü`;
      
      const result = await showConfirmation(
        '‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®',
        `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ${appointmentsText} ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶è‡¶á ‡¶è‡¶ï‡¶∂‡¶®‡¶ü‡¶ø ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!`,
        '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®',
        '‡¶®‡¶æ, ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®'
      );
      
      if (!result.isConfirmed) {
        return;
      }
      
      try {
        const batch = db.batch();
        selectedAppointments.forEach(id => {
          batch.delete(db.collection('appointments').doc(id));
        });
        
        await batch.commit();
        
        selectedAppointments.clear();
        document.querySelectorAll('.appointment-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllAppointments').checked = false;
        document.getElementById('selectAll').checked = false;
        
        updateBulkActions();
        
        Swal.fire({
          title: '‡¶∏‡¶´‡¶≤!',
          text: `${count}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        console.error('‚ùå Error deleting appointments:', error);
        Swal.fire({
          title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
          text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
          icon: 'error'
        });
      }
    }

    function clearSelection() {
      selectedAppointments.clear();
      document.querySelectorAll('.appointment-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAllAppointments').checked = false;
      document.getElementById('selectAll').checked = false;
      updateBulkActions();
    }

    // ==================== APPOINTMENTS MANAGEMENT CLASS ====================
    class AppointmentsManagement {
      constructor() {
        this.db = window.db;
        this.appointments = [];
        this.timeOptions = new Set();
        this.realtimeListeners = [];
        this.searchTimer = null;
        this.currentEditSelection = null;
        this.pendingSelectionsListener = null;
        
        this.initialize();
      }
      
      async initialize() {
        await this.loadSerialRanges();
        await this.setupPendingSelectionsListener();
        await this.loadAppointments();
        this.setupEventListeners();
        this.updateStats();
      }
      
      async loadSerialRanges() {
        try {
          const doc = await this.db.collection('settings').doc('serialRanges').get();
          if (doc.exists) {
            serialRanges = doc.data();
            console.log('‚úÖ Serial ranges loaded:', serialRanges);
            
            // Ensure proper structure
            if (!serialRanges.Thursday) serialRanges.Thursday = { new: {}, old: {} };
            if (!serialRanges.Friday) serialRanges.Friday = { new: {}, old: {} };
            if (!serialRanges.Thursday.new) serialRanges.Thursday.new = {};
            if (!serialRanges.Thursday.old) serialRanges.Thursday.old = {};
            if (!serialRanges.Friday.new) serialRanges.Friday.new = {};
            if (!serialRanges.Friday.old) serialRanges.Friday.old = {};
            
          } else {
            serialRanges = {
              Thursday: { new: {}, old: {} },
              Friday: { new: {}, old: {} }
            };
          }
        } catch (error) {
          console.error('‚ùå Error loading serial ranges:', error);
        }
      }
      
      async setupPendingSelectionsListener() {
        try {
          this.pendingSelectionsListener = this.db.collection('pendingSelections')
            .where('expiresAt', '>', new Date())
            .onSnapshot(snapshot => {
              this.updatePendingSelections(snapshot);
              this.updateStats(); // ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
              
              // ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßã‡¶° ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶ó‡ßç‡¶∞‡¶ø‡¶° ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
              if (editGridSystem) {
                editGridSystem.updateGrid();
              }
            }, error => {
              console.error('‚ùå Error listening to pending selections:', error);
            });
          
          this.realtimeListeners.push(this.pendingSelectionsListener);
        } catch (error) {
          console.error('‚ùå Error setting up pending selections listener:', error);
        }
      }
      
      updatePendingSelections(snapshot) {
        pendingSelections = {};
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const key = `${data.day}_${data.time}_${data.type}`;
          
          if (!pendingSelections[key]) {
            pendingSelections[key] = {
              user: [],
              admin: {}
            };
          }
          
          if (data.bookedBy === 'user') {
            pendingSelections[key].user.push({
              serial: data.serial,
              id: doc.id,
              expiresAt: data.expiresAt
            });
          } else if (data.bookedBy === 'admin') {
            if (!pendingSelections[key].admin[data.adminId]) {
              pendingSelections[key].admin[data.adminId] = [];
            }
            pendingSelections[key].admin[data.adminId].push({
              serial: data.serial,
              sessionId: data.sessionId,
              id: doc.id,
              expiresAt: data.expiresAt
            });
          }
        });
        
        console.log('‚úÖ Pending selections updated:', pendingSelections);
      }
      
      async loadAppointments() {
        try {
          if (!this.db) return;
          
          const listener = this.db.collection('appointments')
            .orderBy('timestamp', 'desc')
            .onSnapshot(snapshot => {
              this.appointments = [];
              this.timeOptions.clear();
              
              snapshot.forEach(doc => {
                const data = {
                  id: doc.id,
                  ...doc.data()
                };
                this.appointments.push(data);
                
                if (data.time) {
                  this.timeOptions.add(data.time);
                }
              });
              
              this.populateTimeFilter();
              this.loadAppointmentsTable();
              this.updateStats();
            }, error => {
              console.error('‚ùå Error loading appointments:', error);
              showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
            });
          
          this.realtimeListeners.push(listener);
          
        } catch (error) {
          console.error('‚ùå Error loading appointments:', error);
          showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá', 'error');
        }
      }
      
      populateTimeFilter() {
        const timeFilter = document.getElementById('timeFilterSerial');
        if (!timeFilter) return;
        
        timeFilter.innerHTML = '<option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>';
        
        const sortedTimes = sortTimes(Array.from(this.timeOptions));
        
        sortedTimes.forEach(time => {
          const option = document.createElement('option');
          option.value = time;
          option.textContent = time;
          timeFilter.appendChild(option);
        });
      }
      
      getFilteredTimes(day, type) {
        const times = new Set();
        
        if (serialRanges[day] && serialRanges[day][type]) {
          Object.keys(serialRanges[day][type]).forEach(time => {
            times.add(time);
          });
        }
        
        this.appointments.forEach(app => {
          if (app.day === day && (app.patientType || app.type) === type && app.time) {
            times.add(app.time);
          }
        });
        
        return sortTimes(Array.from(times));
      }
      
      // ==================== CORRECTED LOAD APPOINTMENTS TABLE ====================
      loadAppointmentsTable(searchTerm = '') {
        const tableBody = document.getElementById('appointmentsTableBody');
        if (!tableBody) return;
        
        const dateFilter = document.getElementById('dateFilter')?.value || '';
        const typeFilter = document.querySelector('.type-filter-appointments')?.value || 'all';
        const timeFilter = document.getElementById('timeFilterSerial')?.value || 'all';
        
        let html = '';
        let foundAppointments = false;
        
        const filteredAppointments = this.appointments.filter(app => {
          // Search term filter
          if (searchTerm && !(
            (app.name && app.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (app.phone && app.phone.includes(searchTerm)) ||
            (app.serial && app.serial.toString().includes(searchTerm))
          )) {
            return false;
          }
          
          // **CORRECTED DATE FILTER - ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá appointmentDate ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®**
          if (dateFilter) {
            if (app.appointmentDate) {
              // ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø YYYY-MM-DD ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ
              if (app.appointmentDate !== dateFilter) {
                return false;
              }
            } else if (app.timestamp) {
              // Firebase Timestamp ‡¶ï‡ßá JavaScript Date ‡¶§‡ßá ‡¶∞‡ßÇ‡¶™‡¶æ‡¶®‡ßç‡¶§‡¶∞
              let appointmentDate;
              if (app.timestamp && app.timestamp.seconds) {
                appointmentDate = new Date(app.timestamp.seconds * 1000);
              } else if (app.timestamp instanceof Date) {
                appointmentDate = app.timestamp;
              } else if (app.timestamp && app.timestamp.toDate) {
                appointmentDate = app.timestamp.toDate();
              } else {
                return false;
              }
              
              // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® YYYY-MM-DD ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá
              const appointmentDateStr = appointmentDate.toISOString().split('T')[0];
              if (appointmentDateStr !== dateFilter) {
                return false;
              }
            } else {
              // ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á
              return false;
            }
          }
          
          // Type filter
          if (typeFilter !== 'all') {
            const patientType = app.patientType || app.type;
            if (patientType !== typeFilter) {
              return false;
            }
          }
          
          // Time filter
          if (timeFilter !== 'all' && app.time !== timeFilter) {
            return false;
          }
          
          return true;
        });
        
        // ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®
        filteredAppointments.sort((a, b) => (a.serial || 0) - (b.serial || 0));
        
        // ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶∞‡ßã ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        for (const app of filteredAppointments) {
          foundAppointments = true;
          
          // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá - ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§
          let dayText = 'N/A';
          let formattedDate = 'N/A';
          let appointmentDate = null;
          
          // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá appointmentDate ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
          if (app.appointmentDate) {
            // YYYY-MM-DD ‡¶•‡ßá‡¶ï‡ßá JavaScript Date ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            const [year, month, day] = app.appointmentDate.split('-');
            appointmentDate = new Date(year, month - 1, day);
            
            // ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
            const dayNames = ['‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞', '‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞', '‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞'];
            const dayIndex = appointmentDate.getDay();
            dayText = dayNames[dayIndex];
            
            // ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶° ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            formattedDate = appointmentDate.toLocaleDateString('bn-BD', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          }
          // ‡¶Ø‡¶¶‡¶ø appointmentDate ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, timestamp ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
          else if (app.timestamp) {
            if (app.timestamp && app.timestamp.seconds) {
              appointmentDate = new Date(app.timestamp.seconds * 1000);
            } else if (app.timestamp instanceof Date) {
              appointmentDate = app.timestamp;
            } else if (app.timestamp && app.timestamp.toDate) {
              appointmentDate = app.timestamp.toDate();
            }
            
            if (appointmentDate) {
              const dayNames = ['‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞', '‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞', '‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞'];
              const dayIndex = appointmentDate.getDay();
              dayText = dayNames[dayIndex];
              
              formattedDate = appointmentDate.toLocaleDateString('bn-BD', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            }
          }
          
          const typeText = (app.patientType || app.type) === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
          
          // ‡¶¨‡ßü‡¶∏ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá
let ageDisplay = 'N/A';

if (app.ageYears !== undefined || app.ageMonths !== undefined || app.ageDays !== undefined) {
    ageDisplay = formatAge(
        Number(app.ageYears) || 0,
        Number(app.ageMonths) || 0,
        Number(app.ageDays) || 0
    );
} else if (app.ageString) {
    ageDisplay = app.ageString;
} else if (app.age && typeof app.age === 'string') {
    ageDisplay = app.age;
} else if (app.age && typeof app.age === 'number') {
    ageDisplay = `${app.age} ‡¶¨‡¶õ‡¶∞`;
}

// ‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
let bookingDate = 'N/A';
if (app.timestamp) {
    let bookingDateObj;
    if (app.timestamp.seconds) {
        bookingDateObj = new Date(app.timestamp.seconds * 1000);
    } else if (app.timestamp instanceof Date) {
        bookingDateObj = app.timestamp;
    } else if (app.timestamp && app.timestamp.toDate) {
        bookingDateObj = app.timestamp.toDate();
    }
    
    if (bookingDateObj) {
        bookingDate = bookingDateObj.toLocaleDateString('bn-BD', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second:  '2-digit'
        });
    }
} else if (app.bookingDate) {
    bookingDate = app.bookingDate;
}

const isSelected = selectedAppointments.has(app.id);

html += `
    <tr data-id="${app.id}" data-attendance="${app.attendance || 'absent'}" data-date="${app.appointmentDate || ''}">
        <td>
            <input type="checkbox" class="appointment-checkbox" value="${app.id}" 
                   data-appointment-id="${app.id}"
                   ${isSelected ? 'checked' : ''}>
        </td>
        <td>${app.serial || 'N/A'}</td>
        <td>${app.name || 'N/A'}</td>
        <td>${ageDisplay}</td>
        <td style="text-align: center;">${app.phone || 'N/A'}</td>
        <td>${dayText}</td>
        <td>${app.time || 'N/A'}</td>
        <td>${typeText}</td>
        <td>${app.appointmentDateDisplay || formattedDate}</td>
        <td>${bookingDate}</td>
        <td>
            <button class="action-btn edit-btn" onclick="appointmentsManager.editAppointment('${app.id}')">
                ‡¶è‡¶°‡¶ø‡¶ü
            </button>
            <button class="action-btn delete-btn" onclick="appointmentsManager.deleteAppointment('${app.id}')">
                ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
            </button>
        </td>
    </tr>
`;
        }
        
        if (!foundAppointments) {
          let message = '‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø';
          
          if (dateFilter) {
            const date = new Date(dateFilter);
            const dateString = date.toLocaleDateString('bn-BD', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
            message = `${dateString} ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø`;
          } else if (searchTerm) {
            message = `"${searchTerm}" ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø`;
          }
          
          html = `
            <tr>
              <td colspan="11" style="text-align: center; padding: 20px; color: #6b7280;">
                ${message}
              </td>
            </tr>
          `;
        }
        
        tableBody.innerHTML = html;
        
        // ‡¶ö‡ßá‡¶ï‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
        document.querySelectorAll('.appointment-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const appointmentId = e.target.value;
            const isChecked = e.target.checked;
            
            if (isChecked) {
              selectedAppointments.add(appointmentId);
            } else {
              selectedAppointments.delete(appointmentId);
              document.getElementById('selectAllAppointments').checked = false;
              document.getElementById('selectAll').checked = false;
            }
            
            updateBulkActions();
          });
        });
      }
      
      // ==================== CORRECTED CALCULATE SERIAL STATS ====================
      calculateSerialStats() {
        console.log("üìä Calculating serial statistics for CURRENT WEEK ONLY...");
        
        const dateFilter = document.getElementById('dateFilter')?.value || '';
        const typeFilter = document.querySelector('.type-filter-appointments')?.value || 'all';
        const timeFilter = document.getElementById('timeFilterSerial')?.value || 'all';
        
        // Get current week date range
        const currentWeek = getCurrentWeekDateRange();
        
        let totalSerials = 0;
        let availableSerials = 0;
        let pendingSerials = 0;
        let bookedSerials = 0;
        
        // Filtered appointments - ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá‡¶∞
        const filteredAppointments = this.appointments.filter(app => {
          // Date filter from UI
          if (dateFilter) {
            if (app.appointmentDate) {
              if (app.appointmentDate !== dateFilter) return false;
            }
            else if (app.timestamp) {
              let appointmentDate;
              if (app.timestamp.seconds) {
                appointmentDate = new Date(app.timestamp.seconds * 1000);
              } else {
                return false;
              }
              const appointmentDateStr = appointmentDate.toISOString().split('T')[0];
              if (appointmentDateStr !== dateFilter) return false;
            }
            else {
              return false;
            }
          } 
          // No date filter - show only current week
          else {
            if (app.appointmentDate) {
              const appointmentDate = parseDateString(app.appointmentDate);
              if (!appointmentDate || !currentWeek.isInCurrentWeek(appointmentDate)) {
                return false;
              }
            }
            else if (app.timestamp) {
              let appointmentDate;
              if (app.timestamp.seconds) {
                appointmentDate = new Date(app.timestamp.seconds * 1000);
              } else {
                return false;
              }
              if (!currentWeek.isInCurrentWeek(appointmentDate)) {
                return false;
              }
            }
            else {
              return false; // No date information
            }
          }
          
          // Type filter
          if (typeFilter !== 'all') {
            const patientType = app.patientType || app.type;
            if (patientType !== typeFilter) return false;
          }
          
          // Time filter
          if (timeFilter !== 'all' && app.time !== timeFilter) return false;
          
          return true;
        });
        
        // Get all serial ranges
        const serialCombinations = [];
        
        // For Thursday
        if (serialRanges.Thursday) {
          // New patients on Thursday
          if (serialRanges.Thursday.new) {
            for (const time in serialRanges.Thursday.new) {
              if (timeFilter === 'all' || time === timeFilter) {
                serialCombinations.push({
                  day: 'Thursday',
                  type: 'new',
                  time: time,
                  range: serialRanges.Thursday.new[time]
                });
              }
            }
          }
          
          // Old patients on Thursday
          if (serialRanges.Thursday.old) {
            for (const time in serialRanges.Thursday.old) {
              if (timeFilter === 'all' || time === timeFilter) {
                serialCombinations.push({
                  day: 'Thursday',
                  type: 'old',
                  time: time,
                  range: serialRanges.Thursday.old[time]
                });
              }
            }
          }
        }
        
        // For Friday
        if (serialRanges.Friday) {
          // New patients on Friday
          if (serialRanges.Friday.new) {
            for (const time in serialRanges.Friday.new) {
              if (timeFilter === 'all' || time === timeFilter) {
                serialCombinations.push({
                  day: 'Friday',
                  type: 'new',
                  time: time,
                  range: serialRanges.Friday.new[time]
                });
              }
            }
          }
          
          // Old patients on Friday
          if (serialRanges.Friday.old) {
            for (const time in serialRanges.Friday.old) {
              if (timeFilter === 'all' || time === timeFilter) {
                serialCombinations.push({
                  day: 'Friday',
                  type: 'old',
                  time: time,
                  range: serialRanges.Friday.old[time]
                });
              }
            }
          }
        }
        
        // Filter by type if specified
        const filteredCombinations = serialCombinations.filter(combo => {
          if (typeFilter !== 'all' && combo.type !== typeFilter) return false;
          return true;
        });
        
        // Calculate statistics for each combination
        filteredCombinations.forEach(combo => {
          if (!combo.range || !Array.isArray(combo.range) || combo.range.length !== 2) {
            return;
          }
          
          const [start, end] = combo.range;
          const totalInRange = end - start + 1;
          totalSerials += totalInRange;
          
          // Count booked serials for this combination (CURRENT WEEK ONLY)
          const bookedInRange = filteredAppointments.filter(app => {
            const patientType = app.patientType || app.type;
            return app.day === combo.day && 
                   app.time === combo.time && 
                   patientType === combo.type &&
                   app.serial >= start && 
                   app.serial <= end;
          }).length;
          
          bookedSerials += bookedInRange;
          
          // Count pending serials for this combination
          const pendingForCombo = this.getPendingSerialsForCombo(combo, currentWeek);
          pendingSerials += pendingForCombo;
          
          // Calculate available serials (never negative)
          const availableInRange = Math.max(0, totalInRange - bookedInRange - pendingForCombo);
          availableSerials += availableInRange;
          
          console.log(`üìä ${combo.day} ${combo.time} ${combo.type}: Total=${totalInRange}, Booked=${bookedInRange}, Pending=${pendingForCombo}, Available=${availableInRange}`);
        });
        
        // Update cards
        document.getElementById('pendingSerials').textContent = pendingSerials;
        document.getElementById('availableSerials').textContent = availableSerials;
        document.getElementById('totalSerials').textContent = totalSerials;
        
        console.log(`üìä FINAL Stats: Total=${totalSerials}, Available=${availableSerials}, Pending=${pendingSerials}, Booked=${bookedSerials}`);
      }
      
      // Pending serials for a specific combination (current week only)
      getPendingSerialsForCombo(combo, currentWeek) {
        let pendingCount = 0;
        
        // Check all pending selections
        for (const key in pendingSelections) {
          // Key format: date_day_time_type or day_time_type
          const parts = key.split('_');
          
          if (parts.length >= 3) {
            let day, time, type;
            
            if (parts.length === 4) {
              // Has date: date_day_time_type
              const dateStr = parts[0];
              day = parts[1];
              time = parts[2];
              type = parts[3];
              
              // Check if this pending is for current week
              const pendingDate = parseDateString(dateStr);
              if (pendingDate && !currentWeek.isInCurrentWeek(pendingDate)) {
                continue; // Skip pending from other weeks
              }
            } else {
              // No date: day_time_type
              day = parts[0];
              time = parts[1];
              type = parts[2];
            }
            
            // Check if this pending matches our combination
            if (day === combo.day && time === combo.time && type === combo.type) {
              const pendingData = pendingSelections[key];
              
              // Count user pending
              if (pendingData.user && Array.isArray(pendingData.user)) {
                pendingCount += pendingData.user.length;
              }
              
              // Count admin pending
              if (pendingData.admin) {
                // Flatten all admin pending arrays
                const adminPendingArrays = Object.values(pendingData.admin);
                adminPendingArrays.forEach(arr => {
                  if (Array.isArray(arr)) {
                    pendingCount += arr.length;
                  }
                });
              }
            }
          }
        }
        
        return pendingCount;
      }
      
      // ==================== CORRECTED UPDATE STATS ====================
      updateStats() {
        const dateFilter = document.getElementById('dateFilter')?.value || '';
        const typeFilter = document.querySelector('.type-filter-appointments')?.value || 'all';
        const timeFilter = document.getElementById('timeFilterSerial')?.value || 'all';
        const searchTerm = document.querySelector('.search-appointments')?.value || '';
        
        // Get current week
        const currentWeek = getCurrentWeekDateRange();
        
        const filteredAppointments = this.appointments.filter(app => {
          // Search term filter
          if (searchTerm && !(
            (app.name && app.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (app.phone && app.phone.includes(searchTerm)) ||
            (app.serial && app.serial.toString().includes(searchTerm))
          )) {
            return false;
          }
          
          // Date filter from UI
          if (dateFilter) {
            if (app.appointmentDate) {
              if (app.appointmentDate !== dateFilter) return false;
            }
            else if (app.timestamp) {
              let appointmentDate;
              if (app.timestamp.seconds) {
                appointmentDate = new Date(app.timestamp.seconds * 1000);
              } else {
                return false;
              }
              const appointmentDateStr = appointmentDate.toISOString().split('T')[0];
              if (appointmentDateStr !== dateFilter) return false;
            }
            else {
              return false;
            }
          }
          // No date filter - show only current week
          else {
            if (app.appointmentDate) {
              const appointmentDate = parseDateString(app.appointmentDate);
              if (!appointmentDate || !currentWeek.isInCurrentWeek(appointmentDate)) {
                return false;
              }
            }
            else if (app.timestamp) {
              let appointmentDate;
              if (app.timestamp.seconds) {
                appointmentDate = new Date(app.timestamp.seconds * 1000);
              } else {
                return false;
              }
              if (!currentWeek.isInCurrentWeek(appointmentDate)) {
                return false;
              }
            }
            else {
              return false;
            }
          }
          
          // Type filter
          if (typeFilter !== 'all') {
            const patientType = app.patientType || app.type;
            if (patientType !== typeFilter) return false;
          }
          
          // Time filter
          if (timeFilter !== 'all' && app.time !== timeFilter) return false;
          
          return true;
        });
        
        // Calculate appointments by day
        const thursdayApps = filteredAppointments.filter(app => {
          if (app.appointmentDate) {
            const [year, month, day] = app.appointmentDate.split('-');
            const appointmentDate = new Date(year, month - 1, day);
            return appointmentDate.getDay() === 4;
          }
          else if (app.timestamp && app.timestamp.seconds) {
            const appointmentDate = new Date(app.timestamp.seconds * 1000);
            return appointmentDate.getDay() === 4;
          }
          return false;
        });
        
        const fridayApps = filteredAppointments.filter(app => {
          if (app.appointmentDate) {
            const [year, month, day] = app.appointmentDate.split('-');
            const appointmentDate = new Date(year, month - 1, day);
            return appointmentDate.getDay() === 5;
          }
          else if (app.timestamp && app.timestamp.seconds) {
            const appointmentDate = new Date(app.timestamp.seconds * 1000);
            return appointmentDate.getDay() === 5;
          }
          return false;
        });
        
        const totalApps = filteredAppointments.length;
        
        document.getElementById('thursdayAppointments').textContent = thursdayApps.length;
        document.getElementById('fridayAppointments').textContent = fridayApps.length;
        document.getElementById('totalAppointments').textContent = totalApps;
        
        // Calculate serial stats
        this.calculateSerialStats();
      }
      
      // ==================== CORRECTED EDIT APPOINTMENT ====================
      editAppointment(id) {
        const appointment = this.appointments.find(app => app.id === id);
        
        if (!appointment) {
          showAlert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø', 'error');
          return;
        }
        
        // Initialize grid system if not already
        if (!editGridSystem) {
          initializeEditGridSystem();
        }
        
        this.currentEditSelection = {
          id: id,
          serial: appointment.serial,
          day: appointment.day,
          time: appointment.time,
          type: appointment.patientType || appointment.type,
          appointmentDate: appointment.appointmentDate
        };
        
        document.getElementById('editAppointmentId').value = id;
        document.getElementById('editName').value = appointment.name || '';
        document.getElementById('editPhone').value = appointment.phone || '';
        
        // Age fields
        let ageYears = 0, ageMonths = 0, ageDays = 0;
        
        if (appointment.ageYears !== undefined || appointment.ageMonths !== undefined || appointment.ageDays !== undefined) {
          ageYears = Number(appointment.ageYears) || 0;
          ageMonths = Number(appointment.ageMonths) || 0;
          ageDays = Number(appointment.ageDays) || 0;
        } else if (appointment.age && typeof appointment.age === 'string') {
          const parsedAge = parseAgeString(appointment.age);
          ageYears = parsedAge.years;
          ageMonths = parsedAge.months;
          ageDays = parsedAge.days;
        } else if (appointment.age && typeof appointment.age === 'number') {
          ageYears = appointment.age;
        }
        
        document.getElementById('editAgeYears').value = ageYears;
        document.getElementById('editAgeMonths').value = ageMonths;
        document.getElementById('editAgeDays').value = ageDays;
        
        document.getElementById('editDay').value = appointment.day || '';
        document.getElementById('editType').value = appointment.patientType || appointment.type || '';
        
        // Update time options based on day and type
        this.updateEditTimeOptions();
        
        // Set time and serial after a short delay
        setTimeout(() => {
          document.getElementById('editTime').value = appointment.time || '';
          document.getElementById('editSerial').value = appointment.serial || '';
          
          // Update the grid
          if (editGridSystem) {
            editGridSystem.updateGrid();
          }
          
          // Highlight selected serial
          if (appointment.serial) {
            setTimeout(() => {
              this.highlightEditSerial(appointment.serial);
            }, 500);
          }
        }, 100);
        
        // Show modal
        document.getElementById('editAppointmentModal').style.display = 'flex';
      }
      
      updateEditTimeOptions() {
        const day = document.getElementById('editDay').value;
        const type = document.getElementById('editType').value;
        const timeSelect = document.getElementById('editTime');
        
        timeSelect.innerHTML = '<option value="">-- ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
        
        if (!day || !type) {
          return;
        }
        
        // Get available times from serial ranges
        if (serialRanges[day] && serialRanges[day][type]) {
          const times = Object.keys(serialRanges[day][type]);
          
          if (times.length > 0) {
            // Sort times
            const sortedTimes = sortTimes(times);
            
            sortedTimes.forEach(time => {
              const option = document.createElement('option');
              option.value = time;
              option.textContent = time;
              timeSelect.appendChild(option);
            });
          }
        }
      }
      
      updateEditSerialGrid() {
        // This function is no longer needed as grid.js handles it
        if (editGridSystem) {
          editGridSystem.updateGrid();
        }
      }
      
      highlightEditSerial(serial) {
        if (!editGridSystem || !serial) return;
        
        const gridContainer = document.getElementById('editSerialGrid');
        if (!gridContainer) return;
        
        const serialItem = gridContainer.querySelector(`.serial-item[data-serial="${serial}"]`);
        if (serialItem) {
          // Remove selected class from all items
          gridContainer.querySelectorAll('.serial-item.selected').forEach(item => {
            item.classList.remove('selected');
            if (item.classList.contains('available')) {
              item.classList.add('available');
            }
          });
          
          // Add selected class to clicked item
          serialItem.classList.remove('available');
          serialItem.classList.add('selected');
          
          // Update hidden input
          document.getElementById('editSerial').value = serial;
        }
      }
      
      selectEditSerial(serial) {
        // This function is now handled by grid.js
        if (editGridSystem) {
          // Find and click the serial item
          const serialItem = document.querySelector(`#editSerialGrid .serial-item[data-serial="${serial}"]`);
          if (serialItem && !serialItem.classList.contains('booked') && !serialItem.classList.contains('pending')) {
            serialItem.click();
          }
        }
      }
      
      // ==================== CORRECTED UPDATE APPOINTMENT ====================
      async updateAppointment(e) {
        e.preventDefault();
        
        if (!db) return;
        
        const id = document.getElementById('editAppointmentId').value;
        const newSerial = parseInt(document.getElementById('editSerial').value);
        const day = document.getElementById('editDay').value;
        const time = document.getElementById('editTime').value;
        const type = document.getElementById('editType').value;
        
        const currentAppointment = this.appointments.find(app => app.id === id);
        if (!currentAppointment) return;
        
        // Validation
        if (!newSerial) {
          Swal.fire({
            title: '‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!',
            text: '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
            icon: 'warning'
          });
          return;
        }
        
        if (!day || !time || !type) {
          Swal.fire({
            title: '‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!',
            text: '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶®, ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶ß‡¶∞‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®',
            icon: 'warning'
          });
          return;
        }
        
        // Get age data
        const years = parseInt(document.getElementById('editAgeYears').value) || 0;
        const months = parseInt(document.getElementById('editAgeMonths').value) || 0;
        const days = parseInt(document.getElementById('editAgeDays').value) || 0;
        
        if (years === 0 && months === 0 && days === 0) {
          Swal.fire({
            title: '‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!',
            text: '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßü‡¶∏ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶¨‡¶õ‡¶∞/‡¶Æ‡¶æ‡¶∏/‡¶¶‡¶ø‡¶®)',
            icon: 'warning'
          });
          return;
        }
        
        // Create age string
        let ageString = '';
        if (years > 0) ageString += `${years} ‡¶¨‡¶õ‡¶∞`;
        if (months > 0) {
          if (ageString) ageString += ', ';
          ageString += `${months} ‡¶Æ‡¶æ‡¶∏`;
        }
        if (days > 0) {
          if (ageString) ageString += ', ';
          ageString += `${days} ‡¶¶‡¶ø‡¶®`;
        }
        
        // Calculate appointment date
        const nextDateInfo = getNextDateByDay(day);
        const appointmentDate = nextDateInfo.dateString;
        const appointmentDateDisplay = nextDateInfo.banglaDate;
        
        // Check if serial is available using grid system
        if (editGridSystem) {
          const range = editGridSystem.getSerialRange(day, type, time);
          if (range) {
            const [start, end] = range;
            if (newSerial < start || newSerial > end) {
              Swal.fire({
                title: '‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ!',
                text: `‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶ü‡¶ø ‡¶∞‡ßá‡¶û‡ßç‡¶ú‡ßá‡¶∞ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá (${start}-${end})`,
                icon: 'warning'
              });
              return;
            }
          }
        }
        
        const updatedData = {
          name: document.getElementById('editName').value,
          age: ageString,
          ageYears: years,
          ageMonths: months,
          ageDays: days,
          phone: document.getElementById('editPhone').value,
          day: day,
          time: time,
          patientType: type,
          serial: newSerial,
          appointmentDate: appointmentDate, // Add appointment date
          appointmentDateDisplay: appointmentDateDisplay, // Add display date
          updatedAt: new Date()
        };

        try {
          document.getElementById('submitEditBtn').innerHTML = '<div class="loading"></div>';
          document.getElementById('submitEditBtn').disabled = true;
          
          await db.collection('appointments').doc(id).update(updatedData);
          
          this.currentEditSelection = null;
          
          document.getElementById('editAppointmentModal').style.display = 'none';
          
          // Cleanup grid system
          if (editGridSystem) {
            editGridSystem.cleanup();
            editGridSystem = null;
          }
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
        } catch (error) {
          console.error('‚ùå Error updating appointment:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        } finally {
          document.getElementById('submitEditBtn').innerHTML = '‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
          document.getElementById('submitEditBtn').disabled = false;
        }
      }
      
      async checkEditSerialAvailability(currentId, newSerial, day, time, type) {
        const otherBookings = this.appointments.filter(app => 
          app.id !== currentId && 
          app.day === day && 
          app.time === time && 
          (app.patientType || app.type) === type &&
          app.serial === newSerial
        );
        
        return otherBookings.length === 0;
      }
      
      async deleteAppointment(appointmentId) {
        const appointment = this.appointments.find(app => app.id === appointmentId);
        if (!appointment) return;
        
        const result = await showConfirmation(
          '‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®',
          `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø "${appointment.name}" ‡¶è‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤: ${appointment.serial}\n‡¶¶‡¶ø‡¶®: ${appointment.day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞'}\n‡¶∏‡¶Æ‡¶Ø‡¶º: ${appointment.time}\n\n‡¶è‡¶á ‡¶è‡¶ï‡¶∂‡¶®‡¶ü‡¶ø ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!`,
          '‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®',
          '‡¶®‡¶æ, ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®'
        );
        
        if (!result.isConfirmed) {
          return;
        }
        
        try {
          await this.db.collection('appointments').doc(appointmentId).delete();
          
          if (selectedAppointments.has(appointmentId)) {
            selectedAppointments.delete(appointmentId);
            updateBulkActions();
          }
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
        } catch (error) {
          console.error('Error deleting appointment:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      // ==================== CORRECTED SETUP EVENT LISTENERS ====================
      setupEventListeners() {
        // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü
        document.getElementById('dateFilter')?.addEventListener('change', (e) => {
          const dateValue = e.target.value;
          
          if (dateValue) {
            // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá‡¶∞ ‡¶á‡¶®‡¶´‡ßã ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
            const weekInfo = document.getElementById('currentWeekInfo');
            if (weekInfo) {
              weekInfo.style.display = 'none';
            }
            
            // ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶á‡¶®‡¶´‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            showFilteredDateInfo(dateValue);
          } else {
            // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá‡¶∞ ‡¶á‡¶®‡¶´‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            const weekInfo = document.getElementById('currentWeekInfo');
            if (weekInfo) {
              weekInfo.style.display = 'block';
            }
          }
          
          const searchTerm = document.querySelector('.search-appointments').value || '';
          this.loadAppointmentsTable(searchTerm);
          this.updateStats();
        });
        
        document.querySelector('.type-filter-appointments')?.addEventListener('change', (e) => {
          const searchTerm = document.querySelector('.search-appointments').value || '';
          this.loadAppointmentsTable(searchTerm);
          this.updateStats();
        });
        
        document.getElementById('timeFilterSerial')?.addEventListener('change', () => {
          const searchTerm = document.querySelector('.search-appointments').value || '';
          this.loadAppointmentsTable(searchTerm);
          this.updateStats();
        });
        
        // Search input event
        const searchInput = document.querySelector('.search-appointments');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            clearTimeout(this.searchTimer);
            this.searchTimer = setTimeout(() => {
              this.loadAppointmentsTable(e.target.value);
              this.updateStats();
            }, 300);
          });
        }
        
        // Add appointment button
        document.getElementById('addAppointmentBtn')?.addEventListener('click', () => {
          Swal.fire({
            title: '‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá!',
            text: '‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞‡¶ü‡¶ø ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶∏‡¶õ‡ßá',
            icon: 'info'
          });
        });
        
        // Export button
        document.getElementById('exportAppointmentsBtn')?.addEventListener('click', () => {
          document.getElementById('exportModal').style.display = 'flex';
        });
        
        // Export options
        document.querySelectorAll('.export-option').forEach(option => {
          option.addEventListener('click', (e) => {
            const format = e.currentTarget.getAttribute('data-format');
            this.exportData(format);
          });
        });
        
        // Close export modal
        document.getElementById('closeExportModal')?.addEventListener('click', () => {
          document.getElementById('exportModal').style.display = 'none';
        });
        
        // Select all checkboxes
        document.getElementById('selectAllAppointments')?.addEventListener('change', (e) => {
          const isChecked = e.target.checked;
          document.querySelectorAll('.appointment-checkbox').forEach(checkbox => {
            const appointmentId = checkbox.value;
            checkbox.checked = isChecked;
            
            if (isChecked) {
              selectedAppointments.add(appointmentId);
            } else {
              selectedAppointments.delete(appointmentId);
            }
          });
          updateBulkActions();
        });
        
        // Bulk select all
        document.getElementById('selectAll')?.addEventListener('change', (e) => {
          const isChecked = e.target.checked;
          document.querySelectorAll('.appointment-checkbox').forEach(checkbox => {
            const appointmentId = checkbox.value;
            checkbox.checked = isChecked;
            
            if (isChecked) {
              selectedAppointments.add(appointmentId);
            } else {
              selectedAppointments.delete(appointmentId);
            }
          });
          document.getElementById('selectAllAppointments').checked = isChecked;
          updateBulkActions();
        });
        
        // Bulk delete button
        document.getElementById('deleteSelectedBtn')?.addEventListener('click', () => {
          deleteSelectedAppointments();
        });
        
        // Clear selection button
        document.getElementById('clearSelectionBtn')?.addEventListener('click', () => {
          clearSelection();
        });
        
        // Edit form submit
        document.getElementById('editAppointmentForm')?.addEventListener('submit', (e) => {
          this.updateAppointment(e);
        });
        
        // Edit modal day change
        document.getElementById('editDay')?.addEventListener('change', () => {
          this.updateEditTimeOptions();
          document.getElementById('editTime').value = '';
          document.getElementById('editSerial').value = '';
          
          if (editGridSystem) {
            editGridSystem.updateGrid();
          }
        });
        
        // Edit modal type change
        document.getElementById('editType')?.addEventListener('change', () => {
          this.updateEditTimeOptions();
          document.getElementById('editTime').value = '';
          document.getElementById('editSerial').value = '';
          
          if (editGridSystem) {
            editGridSystem.updateGrid();
          }
        });
        
        // Edit modal time change
        document.getElementById('editTime')?.addEventListener('change', () => {
          document.getElementById('editSerial').value = '';
          
          if (editGridSystem) {
            editGridSystem.updateGrid();
          }
        });
        
        // Close edit modal
        document.getElementById('closeEditModal')?.addEventListener('click', () => {
          document.getElementById('editAppointmentModal').style.display = 'none';
          this.currentEditSelection = null;
          
          if (editGridSystem) {
            editGridSystem.cleanup();
            editGridSystem = null;
          }
        });
        
        // Cancel edit modal
        document.getElementById('cancelEditModal')?.addEventListener('click', () => {
          document.getElementById('editAppointmentModal').style.display = 'none';
          this.currentEditSelection = null;
          
          if (editGridSystem) {
            editGridSystem.cleanup();
            editGridSystem = null;
          }
        });
        
        // Close modals on outside click
        window.addEventListener('click', (e) => {
          if (e.target === document.getElementById('editAppointmentModal')) {
            document.getElementById('editAppointmentModal').style.display = 'none';
            this.currentEditSelection = null;
            
            if (editGridSystem) {
              editGridSystem.cleanup();
              editGridSystem = null;
            }
          }
          if (e.target === document.getElementById('exportModal')) {
            document.getElementById('exportModal').style.display = 'none';
          }
        });
      }
      
      updateTimeFilterOptions(day, type) {
        const timeFilter = document.getElementById('timeFilterSerial');
        timeFilter.innerHTML = '<option value="all">‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>';
        
        if (day === 'all' || type === 'all') {
          const allTimes = new Set();
          
          for (const d in serialRanges) {
            if (day !== 'all' && d !== day) continue;
            
            for (const t in serialRanges[d]) {
              if (type !== 'all' && t !== type) continue;
              
              for (const time in serialRanges[d][t]) {
                allTimes.add(time);
              }
            }
          }
          
          const sortedTimes = sortTimes(Array.from(allTimes));
          sortedTimes.forEach(time => {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeFilter.appendChild(option);
          });
        } else {
          const times = this.getFilteredTimes(day, type);
          times.forEach(time => {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeFilter.appendChild(option);
          });
        }
      }
      
      exportData(format) {
        const dateFilter = document.getElementById('dateFilter')?.value || '';
        const typeFilter = document.querySelector('.type-filter-appointments')?.value || 'all';
        const timeFilter = document.getElementById('timeFilterSerial')?.value || 'all';
        const searchTerm = document.querySelector('.search-appointments')?.value || '';
        
        const filteredAppointments = this.appointments.filter(app => {
          // Search term filter
          if (searchTerm && !(
            (app.name && app.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (app.phone && app.phone.includes(searchTerm)) ||
            (app.serial && app.serial.toString().includes(searchTerm))
          )) {
            return false;
          }
          
          // Date filter
          if (dateFilter) {
            if (app.appointmentDate) {
              if (app.appointmentDate !== dateFilter) return false;
            }
            else if (app.timestamp) {
              let appointmentDate;
              if (app.timestamp.seconds) {
                appointmentDate = new Date(app.timestamp.seconds * 1000);
              } else {
                return false;
              }
              const appointmentDateStr = appointmentDate.toISOString().split('T')[0];
              if (appointmentDateStr !== dateFilter) return false;
            }
            else {
              return false;
            }
          }
          
          // Type filter
          if (typeFilter !== 'all') {
            const patientType = app.patientType || app.type;
            if (patientType !== typeFilter) return false;
          }
          
          // Time filter
          if (timeFilter !== 'all' && app.time !== timeFilter) return false;
          
          return true;
        });
        
        if (filteredAppointments.length === 0) {
          Swal.fire({
            title: '‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á',
            text: '‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á',
            icon: 'warning'
          });
          document.getElementById('exportModal').style.display = 'none';
          return;
        }
        
        switch(format) {
          case 'pdf':
            this.exportToPDF(filteredAppointments);
            break;
          case 'excel':
            this.exportToExcel(filteredAppointments);
            break;
          case 'word':
            this.exportToWord(filteredAppointments);
            break;
          case 'docs':
            this.exportToHTMLDocs(filteredAppointments);
            break;
        }
        
        document.getElementById('exportModal').style.display = 'none';
      }
      
      exportToPDF(appointments) {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);
          
          doc.setFontSize(16);
          doc.setTextColor(40, 40, 150);
          doc.text('Doctor Appointment Report', 105, 20, { align: 'center' });
          
          doc.setFontSize(10);
          doc.setTextColor(80, 80, 80);
          doc.text(`Generated Date: ${new Date().toLocaleDateString('en-BD')} | Time: ${new Date().toLocaleTimeString('en-BD')}`, 14, 30);
          
          const summaryLines = [
            `‚Ä¢ Total Appointments: ${sortedAppointments.length}`,
            `‚Ä¢ Date Filter: ${document.getElementById('dateFilter').value || 'Current Week'}`,
            `‚Ä¢ Type: ${document.querySelector('.type-filter-appointments').value === 'all' ? 'All Types' : document.querySelector('.type-filter-appointments').value}`,
            `‚Ä¢ Filtered Time: ${document.getElementById('timeFilterSerial').value === 'all' ? 'All Times' : document.getElementById('timeFilterSerial').value}`
          ];
          
          let yPosition = 40;
          summaryLines.forEach((text, index) => {
            doc.text(text, 14, yPosition);
            yPosition += 6;
          });
          
          const headers = [['Serial', 'Patient Name', 'Age', 'Phone', 'Day', 'Time', 'Type', 'Appointment Date']];
          
          const data = sortedAppointments.map(app => [
            app.serial.toString(),
            app.name,
            app.age || 'N/A',
            app.phone,
            app.day === 'Thursday' ? 'Thursday' : 'Friday',
            app.time,
            (app.patientType || app.type) === 'new' ? 'New' : 'Old',
            app.appointmentDateDisplay || 
              (app.timestamp ? 
                new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
                new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit'}) : 'N/A')
          ]);
          
          doc.autoTable({
            head: headers,
            body: data,
            startY: 65,
            styles: { 
              font: 'helvetica',
              fontSize: 9,
              cellPadding: 3
            },
            headStyles: { 
              fillColor: [41, 128, 185],
              textColor: 255,
              fontStyle: 'bold'
            },
            alternateRowStyles: {
              fillColor: [245, 245, 245]
            }
          });
          
          const pageCount = doc.internal.getNumberOfPages();
          for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Page ${i} / ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
          }
          
          const fileName = `appointments_${new Date().toISOString().split('T')[0]}.pdf`;
          doc.save(fileName);
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: `${sortedAppointments.length}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü PDF ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
          
        } catch (error) {
          console.error('PDF export error:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: 'PDF ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      exportToExcel(appointments) {
        try {
          const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);
          
          const data = sortedAppointments.map(app => ({
            'Serial No': app.serial,
            'Patient Name': app.name,
            'Age': app.age || 'N/A',
            'Phone Number': app.phone || 'N/A',
            'Day': app.day === 'Thursday' ? 'Thursday' : 'Friday',
            'Time': app.time,
            'Type': (app.patientType || app.type) === 'new' ? 'New Patient' : 'Old Patient',
            'Appointment Date': app.appointmentDateDisplay || 
              (app.timestamp ? 
                new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
                new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit'}) : 'N/A')
          }));
          
          const ws = XLSX.utils.json_to_sheet(data);
          
          const colWidths = [
            { wch: 10 }, { wch: 20 }, { wch: 15 }, { wch: 15 },
            { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 20 }
          ];
          ws['!cols'] = colWidths;
          
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Appointments');
          
          const fileName = `appointments_${new Date().toISOString().split('T')[0]}.xlsx`;
          XLSX.writeFile(wb, fileName);
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: `${sortedAppointments.length}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü Excel ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
          
        } catch (error) {
          console.error('Excel export error:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: 'Excel ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      exportToWord(appointments) {
        try {
          const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);

          let wordContent = `
    <meta charset="UTF-8">
    <html>
    <body>
      <h1 style="text-align: center; color: #2563eb; margin-bottom: 10px;">Doctor Appointment Report</h1>
      
      <p style="text-align: center; color: #666; margin-bottom: 15px;">
        <strong>Generated Date:</strong> ${new Date().toLocaleDateString('en-BD')} | 
        <strong>Time:</strong> ${new Date().toLocaleTimeString('en-BD')}
      </p>
      
      <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2563eb;">
        <strong>Summary:</strong><br>
        ‚Ä¢ Total Appointments: ${sortedAppointments.length}<br>
        ‚Ä¢ Date Filter: ${document.getElementById('dateFilter').value || 'Current Week'}<br>
        ‚Ä¢ Type: ${document.querySelector('.type-filter-appointments').value === 'all' ? 'All Types' : document.querySelector('.type-filter-appointments').value}<br>
        ‚Ä¢ Filtered Time: ${document.getElementById('timeFilterSerial').value === 'all' ? 'All Times' : document.getElementById('timeFilterSerial').value}
      </div>

      <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; font-size: 12px;">
        <tr style="background-color: #2563eb; color: white; font-weight: bold;">
          <th>Serial</th>
          <th>Patient Name</th>
          <th>Age</th>
          <th>Phone</th>
          <th>Day</th>
          <th>Time</th>
          <th>Type</th>
          <th>Appointment Date</th>
        </tr>
        ${sortedAppointments.map(app => {
          const age = app.age || 'N/A';
          const appointmentDate = app.appointmentDateDisplay || 
            (app.timestamp ? 
              new Date(app.timestamp.seconds * 1000).toLocaleDateString('en-BD') + ' ' + 
              new Date(app.timestamp.seconds * 1000).toLocaleTimeString('en-BD', {hour: '2-digit', minute: '2-digit'}) : 'N/A');
          
          return `
        <tr>
          <td>${app.serial}</td>
          <td>${app.name}</td>
          <td>${age}</td>
          <td>${app.phone || 'N/A'}</td>
          <td>${app.day === 'Thursday' ? 'Thursday' : 'Friday'}</td>
          <td>${app.time}</td>
          <td>${(app.patientType || app.type) === 'new' ? 'New' : 'Old'}</td>
          <td>${appointmentDate}</td>
        </tr>`;
        }).join('')}
      </table>
      
      <p style="margin-top: 20px; color: #666; font-size: 11px; text-align: center;">
        Generated by Admin Dashboard | ${new Date().getFullYear()}
      </p>
    </body>
    </html>`;

          const blob = new Blob([wordContent], { type: 'application/msword' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `appointments_${new Date().toISOString().split('T')[0]}.doc`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            text: `${sortedAppointments.length}‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü Word ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
          });
          
        } catch (error) {
          console.error('Word export error:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: 'Word ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      exportToHTMLDocs(appointments) {
        try {
          const sortedAppointments = [...appointments].sort((a, b) => a.serial - b.serial);
          
          const htmlContent = `
    <meta charset="UTF-8">
    <html>
    <head>
      <style>
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 20px;
          box-sizing: border-box;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          font-size: 11px;
          table-layout: fixed;
        }
        th, td {
          border: 1px solid #000;
          padding: 6px;
          word-wrap: break-word;
        }
      </style>
    </head>
    <body>
      <h1 style="text-align: center; color: #2563eb; margin-bottom: 10px; font-size: 16px;">Doctor Appointment Report</h1>
      
      <p style="text-align: center; color: #666; margin-bottom: 15px; font-size: 12px;">
        <strong>Generated Date:</strong> ${new Date().toLocaleDateString('en-BD')} | 
        <strong>Time:</strong> ${new Date().toLocaleTimeString('en-BD')}
      </p>
      
      <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #2563eb; font-size: 11px;">
        <strong>Summary:</strong><br>
        ‚Ä¢ Total Appointments: ${sortedAppointments.length}<br>
        ‚Ä¢ Date Filter: ${document.getElementById('dateFilter').value || 'Current Week'}<br>
        ‚Ä¢ Type: ${document.querySelector('.type-filter-appointments').value === 'all' ? 'All Types' : document.querySelector('.type-filter-appointments').value}<br>
        ‚Ä¢ Filtered Time: ${document.getElementById('timeFilterSerial').value === 'all' ? 'All Times' : document.getElementById('timeFilterSerial').value}
      </div>

      <table>
        <tr style="background-color: #2563eb; color: white; font-weight: bold;">
          <th style="width: 8%">Serial</th>
          <th style="width: 20%">Patient Name</th>
          <th style="width: 12%">Age</th>
          <th style="width: 15%">Phone</th>
          <th style="width: 10%">Day</th>
          <th style="width: 10%">Time</th>
          <th style="width: 10%">Type</th>
          <th style="width: 15%">Appointment Date</th>
        </tr>
        ${sortedAppointments.map(app => {
          let age = 'N/A';
          
          if (app.ageYears || app.ageMonths || app.ageDays) {
            const parts = [];
            if (app.ageYears && app.ageYears > 0) parts.push(`${app.ageYears} Years`);
            if (app.ageMonths && app.ageMonths > 0) parts.push(`${app.ageMonths} Months`);
            if (app.ageDays && app.ageDays > 0) parts.push(`${app.ageDays} Day`);
            age = parts.join(' ');
          } else if (app.age) {
            if (!isNaN(app.age) && app.age !== '') {
              age = app.age + ' Years';
            } else if (typeof app.age === 'string') {
              age = app.age;
            }
          }
          
          let appointmentDate = 'N/A';
          if (app.appointmentDateDisplay) {
            appointmentDate = app.appointmentDateDisplay;
          } else if (app.timestamp) {
            let dateObj;
            
            if (app.timestamp.toDate && typeof app.timestamp.toDate === 'function') {
              dateObj = app.timestamp.toDate();
            } else if (app.timestamp.seconds) {
              dateObj = new Date(app.timestamp.seconds * 1000);
            } else if (app.timestamp instanceof Date) {
              dateObj = app.timestamp;
            } else if (typeof app.timestamp === 'string') {
              dateObj = new Date(app.timestamp);
            }
            
            if (dateObj && !isNaN(dateObj.getTime())) {
              const dateStr = dateObj.toLocaleDateString('en-BD');
              const timeStr = dateObj.toLocaleTimeString('en-BD', {
                hour: '2-digit', 
                minute: '2-digit'
              });
              appointmentDate = `${dateStr} ${timeStr}`;
            }
          }
          
          return `
        <tr>
          <td style="width: 8%">${app.serial}</td>
          <td style="width: 20%">${app.name}</td>
          <td style="width: 12%">${age}</td>
          <td style="width: 15%">${app.phone}</td>
          <td style="width: 10%">${app.day === 'Thursday' ? 'Thursday' : 'Friday'}</td>
          <td style="width: 10%">${app.time}</td>
          <td style="width: 10%">${(app.patientType || app.type) === 'new' ? 'New' : 'Old'}</td>
          <td style="width: 15%">${appointmentDate}</td>
        </tr>`;
        }).join('')}
      </table>
      
      <p style="margin-top: 15px; color: #666; font-size: 10px; text-align: center;">
        Generated by Admin Dashboard | ${new Date().getFullYear()}
      </p>
    </body>
    </html>`;

          const blob = new Blob([htmlContent], { 
            type: 'text/html; charset=utf-8'
          });
          
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `appointments_${new Date().toISOString().split('T')[0]}.html`;
          
          link.click();
          
          Swal.fire({
            title: '‡¶∏‡¶´‡¶≤!',
            html: `
              <div style="text-align: left;">
                <strong>‚úÖ ‡¶°‡¶ï‡ßç‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!</strong><br><br>
                <strong>Google Docs ‡¶è ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶§‡ßá:</strong><br>
                1. Google Docs ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                2. File ‚Üí Import ‚Üí Upload<br>
                3. ‡¶è‡¶á HTML ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®<br>
                4. Insert ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
              </div>
            `,
            icon: 'success',
            timer: 8000,
            showConfirmButton: true
          });
          
          setTimeout(() => URL.revokeObjectURL(url), 5000);
          
        } catch (error) {
          console.error('Docs export error:', error);
          Swal.fire({
            title: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
            text: '‡¶°‡¶ï‡ßç‡¶∏ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            icon: 'error'
          });
        }
      }
      
      destroy() {
        this.realtimeListeners.forEach(unsubscribe => {
          if (unsubscribe && typeof unsubscribe === 'function') {
            unsubscribe();
          }
        });
        
        if (editGridSystem) {
          editGridSystem.cleanup();
          editGridSystem = null;
        }
      }
    }

    // ==================== INITIALIZATION ====================
    function initializeFirebase() {
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        console.log("‚úÖ Firebase initialized successfully");
        
        window.db = db;
        return true;
      } catch (error) {
        console.error("‚ùå Firebase initialization error:", error);
        Swal.fire({
          title: 'Firebase ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!',
          text: '‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message,
          icon: 'error'
        });
        return false;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAuthentication()) {
        return;
      }
      
      if (initializeFirebase()) {
        setTimeout(() => {
          appointmentsManager = new AppointmentsManagement();
          console.log('‚úÖ Appointments Management initialized');
          
          // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
          setTimeout(() => {
            displayCurrentWeekInfo();
          }, 500);
          
          // setTimeout(() => {
          //   Swal.fire({
          //     title: '‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!',
          //     text: '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ',
          //     icon: 'success',
          //     timer: 2000,
          //     showConfirmButton: false
          //   });
          // }, 1000);
        }, 100);
      }
    });

    window.addEventListener('beforeunload', function() {
      if (appointmentsManager) {
        appointmentsManager.destroy();
      }
      
      if (realtimeListeners.length > 0) {
        realtimeListeners.forEach(unsubscribe => {
          if (unsubscribe && typeof unsubscribe === 'function') {
            unsubscribe();
          }
        });
      }
    });
  </script>
</body>
</html>