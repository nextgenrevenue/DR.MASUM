<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="q6qnX2SH5llFty6Oy1rgN5_49L_ChMSuhR4jn8mZJNE" />
  <title>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Required Libraries for PDF/PNG Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --info: #3b82f6;
      --gray: #6b7280;
      --light-gray: #f3f4f6;
      --white: #ffffff;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Noto Sans Bengali', sans-serif;
      background: linear-gradient(135deg, #f0f8ff, #e1f5fe);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 20px auto;
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      position: relative;
    }
    
    .header {
      background: var(--primary);
      color: var(--white);
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    .header h2 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }
    
    .header::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 0;
      right: 0;
      height: 20px;
      background: var(--white);
      clip-path: ellipse(50% 50% at 50% 50%);
    }
    
    .search-section {
      padding: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .input-field {
      position: relative;
    }
    
    input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Noto Sans Bengali', sans-serif;
      transition: all 0.2s ease;
      background-color: var(--white);
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    input::placeholder {
      color: var(--gray);
      opacity: 0.6;
    }
    
    .error-msg {
      color: var(--danger);
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    
    .info-text {
      color: var(--gray);
      font-size: 13px;
      margin-top: 5px;
      display: block;
    }
    
    .search-btn {
      width: 100%;
      padding: 14px;
      background-color: var(--primary);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s ease;
      font-family: 'Noto Sans Bengali', sans-serif;
    }
    
    .search-btn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.2);
    }
    
    .search-btn:active {
      transform: translateY(0);
    }
    
    .search-btn.loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .back-btn {
      background-color: var(--gray);
      color: var(--white);
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 20px;
      transition: all 0.2s ease;
    }
    
    .back-btn:hover {
      background-color: #4b5563;
    }

    /* Results Section */
    .results-section {
      padding: 0 30px 30px;
      display: none;
    }
    
    .results-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #1f2937;
      text-align: center;
    }
    
    .no-results {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }
    
    .no-results i {
      font-size: 48px;
      margin-bottom: 15px;
      color: var(--gray);
    }
    
    .appointment-card {
      background: var(--white);
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }
    
    .appointment-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
    }
    
    .appointment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .appointment-serial {
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 18px;
      font-weight: 700;
    }
    
    .appointment-status {
      background: var(--success);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
   .appointment-details {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 15px;
}

.detail-row {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 15px;
  padding: 8px 0;
  border-bottom: 1px solid #f3f4f6;
  flex-wrap: wrap; /* ‡¶õ‡ßã‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶™ ‡¶π‡¶¨‡ßá */
}

.detail-label {
  font-weight: 600;
  color: #374151;
  font-size: 14px;
  min-width: 100px;
  text-align: left;
}

.detail-value {
  color: #1f2937;
  font-size: 14px;
  font-weight: 500;
  text-align: left;
  flex: 1;
}
    .download-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
    }
    
    .download-btn:hover {
      background: #15803d;
      transform: translateY(-1px);
    }

    /* Fixed Super Compact Slip - No Scroll, All Devices Friendly */
    .confirmation-slip {
    background: white;
    border: 2px solid #2563eb;
    border-radius: 10px;
    padding: 15px;
    margin: 15px auto; /* üî• auto margin for centering */
    text-align: center;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
    max-width: 300px;
    width: 100%; /* üî• Full width of parent */
    
    /* üî• Center alignment */
    display: block;
    margin-left: auto;
    margin-right: auto;
    
    /* üî• Prevent overflow */
    box-sizing: border-box;
    overflow: hidden;
}

    .slip-header {
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 8px;
        margin-bottom: 10px;
    }

    .slip-header h3 {
        color: #2563eb;
        font-size: 14px;
        margin-bottom: 3px;
        font-weight: 700;
    }

    .slip-header p {
        color: #6b7280;
        font-size: 12px;
        margin: 0;
    }

    .slip-details {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
        margin-bottom: 12px;
        font-size: 12px;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail-label {
        font-weight: 600;
        color: #374151;
        text-align: left;
        flex: 1;
        min-width: 60px;
    }

    .detail-value {
        color: #1f2937;
        text-align: right;
        flex: 1;
        font-weight: 500;
        min-width: 100px;
    }

    .serial-number {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 20px;
        font-weight: 700;
        border: 2px solid #3b82f6;
    }

    .slip-footer {
        border-top: 1px solid #e5e7eb;
        padding-top: 8px;
        color: #6b7280;
        font-size: 10px;
        line-height: 1.3;
        margin-top: 8px;
    }

    /* Download Buttons CSS */
    .download-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .download-btn-slip {
        background: #16a34a;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        min-width: 120px;
        justify-content: center;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .download-btn-slip:hover {
        background: #15803d;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .download-btn-slip.pdf {
        background: #dc2626;
    }

    .download-btn-slip.pdf:hover {
        background: #b91c1c;
    }

    /* Custom Popup Modal */
    .popup-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: popupIn 0.3s ease-out;
    }

    @keyframes popupIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .popup-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .popup-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #1f2937;
    }

    .popup-message {
      font-size: 16px;
      margin-bottom: 20px;
      color: #6b7280;
      line-height: 1.5;
      text-align: left;
    }

    .popup-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .popup-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .popup-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }

    .popup-btn.cancel {
      background: var(--gray);
    }

    .popup-btn.cancel:hover {
      background: #4b5563;
    }

    .popup-btn.success {
      background: var(--success);
    }

    .popup-btn.success:hover {
      background: #15803d;
    }

    /* Mobile First Design */
    @media (max-width: 600px) {
      .container {
        margin: 10px auto;
        border-radius: 0;
      }
      
      .search-section {
        padding: 20px;
      }
      
      .results-section {
        padding: 0 20px 20px;
      }
      
      .appointment-details {
        grid-template-columns: 1fr;
      }
      
      .appointment-header {
        flex-direction: row;
        gap: 10px;
        align-items: flex-start;
      }
      
      .download-buttons {
        flex-direction: column;
      }
      
      .download-btn-slip {
        min-width: 100%;
      }

      .confirmation-slip {
          max-width: 100%;
          padding: 12px;
      }
      
      .slip-details {
          gap: 4px;
          font-size: 11px;
      }
      
      .detail-item {
          padding: 2px 0;
      }
      
      .serial-number {
          font-size: 18px;
          padding: 10px;
      }
      
      .slip-footer {
          font-size: 9px;
          padding-top: 6px;
          margin-top: 6px;
      }
    }

    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .appointment-card {
      animation: fadeIn 0.3s ease forwards;
    }
  </style>
</head>
<body>
  <!-- Unified Popup Modal -->
  <div class="popup-modal" id="universalPopup">
    <div class="popup-content">
      <div class="popup-icon" id="popupIcon">‚ö†Ô∏è</div>
      <div class="popup-title" id="popupTitle">‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</div>
      <div class="popup-message" id="popupMessage">
        ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá
      </div>
      <!-- Confirmation Slip for Download -->
      <div class="confirmation-slip" id="confirmationSlip" style="display: none;">
        <div class="slip-header">
          <h3>üè• ‡¶°‡¶æ‡¶É ‡¶Æ‡ßã‡¶É ‡¶ì‡¶Ø‡¶º‡¶æ‡¶π‡¶ø‡¶¶‡ßÅ‡¶ú‡ßç‡¶ú‡¶æ‡¶Æ‡¶æ‡¶® ‡¶Æ‡¶æ‡¶∏‡ßÅ‡¶Æ</h3>
          <p>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶≤‡¶ø‡¶™</p>
        </div>
        <div class="slip-details">
          <div class="detail-item">
            <div class="detail-label">‡¶®‡¶æ‡¶Æ:</div>
            <div class="detail-value" id="slipName">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶¨‡ßü‡¶∏:</div>
            <div class="detail-value" id="slipAge">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶´‡ßã‡¶®:</div>
            <div class="detail-value" id="slipPhone">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶ß‡¶∞‡¶®:</div>
            <div class="detail-value" id="slipType">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶¶‡¶ø‡¶®:</div>
            <div class="detail-value" id="slipDay">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">‡¶∏‡¶Æ‡ßü:</div>
            <div class="detail-value" id="slipTime">-</div>
          </div>
        </div>
        <div class="serial-number" id="slipSerial">#‡ß¶</div>
        <div class="slip-footer">
          ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ì ‡¶∏‡¶Æ‡ßü: <span id="slipDateTime">-</span> | ‡¶è‡¶á ‡¶∏‡ßç‡¶≤‡¶ø‡¶™‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶∏‡¶æ‡¶•‡ßá ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶∏‡ßÅ‡¶®
        </div>
      </div>
      <div class="popup-buttons" id="popupButtons">
        <button class="popup-btn cancel" onclick="resetEverything()">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
      <!-- Download Buttons for Confirmation Slip -->
      <div class="download-buttons" id="downloadButtons" style="display: none;">
        <button class="download-btn-slip" onclick="downloadPNG()">
          üì∏ PNG ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        </button>
        <button class="download-btn-slip pdf" onclick="downloadPDF()">
          üìÑ PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        </button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <div class="header">
      <h2>‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</h2>
    </div>
    
    <div class="search-section">
     <button class="back-btn" onclick="location.href='/'">
      ‚Üê ‡¶π‡ßã‡¶Æ ‡¶™‡ßá‡¶ú‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
     </button>

      <div class="form-group">
        <label for="searchPhone">‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
        <div class="input-field">
          <input type="tel" id="searchPhone" name="searchPhone" placeholder="01XXXXXXXXX" required pattern="01[0-9]{9}"
            title="‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡ßß‡ßß ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
        </div>
        <small id="phoneError" class="error-msg">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (01XXXXXXXXX)</small>
        <small class="info-text">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶° ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</small>
      </div>

      <button type="button" class="search-btn" id="searchBtn" onclick="searchAppointments()">
        üîç ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
      </button>
    </div>
    
    <div class="results-section" id="resultsSection">
      <h3 class="results-title">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶∏</h3>
      <div id="resultsContainer">
        <!-- Results will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCUGkcHFSYVmA0KUSRHhY-ZFFAS6jpJe4M",
      authDomain: "doctor-appointment-syste-23828.firebaseapp.com",
      projectId: "doctor-appointment-syste-23828",
      storageBucket: "doctor-appointment-syste-23828.appspot.com",
      messagingSenderId: "79600391014",
      appId: "1:79600391014:web:9688db8bb62f431ae16ea7"
    };

    // Global db variable
    let db;
    let currentAppointmentData = null;

    // ==================== ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶ó‡¶£‡¶®‡¶æ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ====================
    function getNextDateByDay(targetDay) {
      const daysMap = {
        "Sunday": 0,
        "Monday": 1,
        "Tuesday": 2,
        "Wednesday": 3,
        "Thursday": 4,
        "Friday": 5,
        "Saturday": 6
      };
      
      const targetDayIndex = daysMap[targetDay];
      const today = new Date();
      
      const todayIndex = today.getDay();
      let daysToAdd = targetDayIndex - todayIndex;
      
      if (daysToAdd < 0) {
        daysToAdd += 7;
      }
      
      const nextDate = new Date(today);
      nextDate.setDate(today.getDate() + daysToAdd);
      
      const year = nextDate.getFullYear();
      const month = String(nextDate.getMonth() + 1).padStart(2, '0');
      const day = String(nextDate.getDate()).padStart(2, '0');
      
      const banglaMonths = [
        '‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡ßÄ', '‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡ßÄ', '‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö', '‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤', '‡¶Æ‡ßá', '‡¶ú‡ßÅ‡¶®',
        '‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á', '‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü', '‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞', '‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'
      ];
      
      const banglaDays = [
        '‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞', '‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞', 
        '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞', '‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞'
      ];
      
      const banglaDate = `${banglaDays[nextDate.getDay()]}, ${nextDate.getDate()} ${banglaMonths[nextDate.getMonth()]} ${year}`;
      
      return {
        date: nextDate,
        dateString: `${year}-${month}-${day}`,
        displayDate: nextDate.toLocaleDateString('bn-BD', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        }),
        banglaDate: banglaDate,
        isToday: daysToAdd === 0
      };
    }

    // ==================== ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ====================
    function getDateForAppointment(appointmentDay, appointmentTimestamp) {
      // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶ï
      const isExpired = checkIfAppointmentExpired(appointmentDay, appointmentTimestamp);
      
      // ‡¶Ø‡¶¶‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶π‡¶Ø‡¶º, ‡¶Ü‡¶∏‡¶≤ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
      if (isExpired && appointmentTimestamp) {
        try {
          const bookingDate = appointmentTimestamp.toDate();
          const daysMap = {
            "Sunday": 0, "Monday": 1, "Tuesday": 2, "Wednesday": 3,
            "Thursday": 4, "Friday": 5, "Saturday": 6
          };
          
          const targetDayIndex = daysMap[appointmentDay];
          let appointmentDate = new Date(bookingDate);
          const bookingDayIndex = appointmentDate.getDay();
          
          let daysToAdd = targetDayIndex - bookingDayIndex;
          
          // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá ‡¶π‡¶Ø‡¶º
          if (daysToAdd < 0) {
            daysToAdd += 7;
          }
          
          appointmentDate.setDate(bookingDate.getDate() + daysToAdd);
          
          const year = appointmentDate.getFullYear();
          const month = String(appointmentDate.getMonth() + 1).padStart(2, '0');
          const day = String(appointmentDate.getDate()).padStart(2, '0');
          
          const banglaMonths = [
            '‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡ßÄ', '‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡ßÄ', '‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö', '‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤', '‡¶Æ‡ßá', '‡¶ú‡ßÅ‡¶®',
            '‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á', '‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü', '‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞', '‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'
          ];
          
          const banglaDays = [
            '‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞', '‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞', '‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞', 
            '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞', '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞', '‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞'
          ];
          
          const banglaDate = `${banglaDays[appointmentDate.getDay()]}, ${appointmentDate.getDate()} ${banglaMonths[appointmentDate.getMonth()]} ${year}`;
          
          return {
            date: appointmentDate,
            dateString: `${year}-${month}-${day}`,
            displayDate: appointmentDate.toLocaleDateString('bn-BD', { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            }),
            banglaDate: banglaDate,
            isExpired: true
          };
        } catch (error) {
          console.error('Error calculating expired date:', error);
          // Fallback to getNextDateByDay if error
          return getNextDateByDay(appointmentDay);
        }
      } else {
        // ‡¶Ø‡¶¶‡¶ø ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶° ‡¶•‡¶æ‡¶ï‡ßá, ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        return getNextDateByDay(appointmentDay);
      }
    }

    // ==================== ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶´‡¶∞‡ßç‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ====================
    function getAgeDisplay(appointmentData) {
      if (appointmentData.ageDisplay) {
        return appointmentData.ageDisplay;
      } else if (appointmentData.ageString) {
        return appointmentData.ageString;
      } else if (appointmentData.ageYears || appointmentData.ageMonths || appointmentData.ageDays) {
        const parts = [];
        if (appointmentData.ageYears > 0) parts.push(`${appointmentData.ageYears} ‡¶¨‡¶õ‡¶∞`);
        if (appointmentData.ageMonths > 0) parts.push(`${appointmentData.ageMonths} ‡¶Æ‡¶æ‡¶∏`);
        if (appointmentData.ageDays > 0) parts.push(`${appointmentData.ageDays} ‡¶¶‡¶ø‡¶®`);
        return parts.join(' ') || '‡ß¶ ‡¶¨‡¶õ‡¶∞ ‡ß¶ ‡¶Æ‡¶æ‡¶∏ ‡ß¶ ‡¶¶‡¶ø‡¶®';
      } else if (appointmentData.age) {
        const years = Math.floor(appointmentData.age / 12);
        const months = Math.round(appointmentData.age % 12);
        if (years > 0) {
          return `${years} ‡¶¨‡¶õ‡¶∞${months > 0 ? ` ${months} ‡¶Æ‡¶æ‡¶∏` : ''}`;
        } else {
          return `${months} ‡¶Æ‡¶æ‡¶∏`;
        }
      } else {
        return '‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á';
      }
    }

    // Firebase initialization
    function initializeFirebase() {
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        console.log("‚úÖ Firebase initialized successfully in search page");
        return true;
      } catch (error) {
        console.error("‚ùå Firebase initialization error in search page:", error);
        return false;
      }
    }

    // Initialize Firebase immediately
    initializeFirebase();

    // ==================== DOM ELEMENTS ====================
    const searchPhone = document.getElementById('searchPhone');
    const phoneError = document.getElementById('phoneError');
    const searchBtn = document.getElementById('searchBtn');
    const resultsSection = document.getElementById('resultsSection');
    const resultsContainer = document.getElementById('resultsContainer');

    // Popup Elements
    const universalPopup = document.getElementById('universalPopup');
    const popupIcon = document.getElementById('popupIcon');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');
    const popupButtons = document.getElementById('popupButtons');
    const confirmationSlip = document.getElementById('confirmationSlip');
    const downloadButtons = document.getElementById('downloadButtons');

    // Slip Elements
    const slipName = document.getElementById('slipName');
    const slipAge = document.getElementById('slipAge');
    const slipPhoneEl = document.getElementById('slipPhone');
    const slipType = document.getElementById('slipType');
    const slipDay = document.getElementById('slipDay');
    const slipTime = document.getElementById('slipTime');
    const slipSerial = document.getElementById('slipSerial');
    const slipDateTime = document.getElementById('slipDateTime');

    // ==================== COMPLETE RESET FUNCTION ====================
    function resetEverything() {
      console.log('üîÑ Resetting everything...');
      
      // 1. Reset popup and data
      currentAppointmentData = null;
      confirmationSlip.style.display = 'none';
      downloadButtons.style.display = 'none';
      universalPopup.style.display = 'none';
      
      // 2. Reset slip visual data
      slipName.textContent = '-';
      slipAge.textContent = '-';
      slipPhoneEl.textContent = '-';
      slipType.textContent = '-';
      slipDay.textContent = '-';
      slipTime.textContent = '-';
      slipSerial.textContent = '#‡ß¶';
      slipDateTime.textContent = '-';
      
      // 3. Clear search results
      resultsSection.style.display = 'none';
      resultsContainer.innerHTML = '';
      
      // 4. Clear phone input
      searchPhone.value = '';
      phoneError.style.display = 'none';
      
      // 5. Focus back on search input for new search
      searchPhone.focus();
      
      console.log('‚úÖ Everything reset completed');
    }

    function resetPopup() {
      resetEverything();
    }

    function closePopup() {
      resetEverything();
    }

    // ==================== UNIFIED POPUP SYSTEM ====================
    function showPopup(type, title, message, options = {}) {
      // Reset popup state
      confirmationSlip.style.display = 'none';
      downloadButtons.style.display = 'none';
      popupButtons.innerHTML = '';

      // Reset current appointment data when showing new popup (unless we're showing slip)
      if (!options.showSlip) {
        currentAppointmentData = null;
      }

      // Set icon based on type
      const icons = {
        warning: '‚ö†Ô∏è',
        error: '‚ùå',
        success: '‚úÖ',
        info: '‚ÑπÔ∏è'
      };

      popupIcon.textContent = icons[type] || '‚ö†Ô∏è';
      popupTitle.textContent = title;
      popupMessage.innerHTML = message;

      // Set button colors based on type
      const buttonColors = {
        warning: 'warning',
        error: 'cancel',
        success: 'success',
        info: 'primary'
      };

      // For all popups - reset everything when closed
      popupButtons.innerHTML = `
        <button class="popup-btn ${buttonColors[type]}" onclick="resetEverything()">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
      `;

      // Show confirmation slip if requested
      if (options.showSlip && currentAppointmentData) {
        showConfirmationSlip(currentAppointmentData);
      }

      universalPopup.style.display = 'flex';
    }

    // Close popup when clicking outside
    universalPopup.addEventListener('click', function(e) {
      if (e.target === universalPopup) {
        resetEverything();
      }
    });

    // ==================== CONFIRMATION SLIP SYSTEM ====================
    function showConfirmationSlip(appointmentData) {
      // ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶ï (‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ ‡¶∏‡¶π)
      const isExpired = checkIfAppointmentExpired(appointmentData.day, appointmentData.timestamp);
      
      // Update slip content
      slipName.textContent = appointmentData.name;
      slipAge.textContent = getAgeDisplay(appointmentData);
      slipPhoneEl.textContent = appointmentData.phone;
      slipType.textContent = appointmentData.patientType === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
      
      // ‚úÖ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® - getDateForAppointment ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
      const dateInfo = getDateForAppointment(appointmentData.day, appointmentData.timestamp);
      slipDay.textContent = dateInfo.banglaDate;
      slipTime.textContent = appointmentData.time + "\n" + "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§/‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá ‡¶ö‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡¶®";
      slipSerial.textContent = '#' + appointmentData.serial;
      
      // Set current date and time
      const now = new Date();
      const dateTimeString = now.toLocaleDateString('bn-BD', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      }) + ' ' + now.toLocaleTimeString('bn-BD', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      slipDateTime.textContent = dateTimeString;
      
      // Show slip and download buttons (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶° ‡¶π‡¶≤‡ßá)
      if (!isExpired) {
        confirmationSlip.style.display = 'block';
        downloadButtons.style.display = 'flex';
      } else {
        // ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶π‡¶≤‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®, ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶¨‡¶æ‡¶ü‡¶® ‡¶®‡¶Ø‡¶º
        confirmationSlip.style.display = 'block';
        downloadButtons.style.display = 'none';
        popupButtons.innerHTML = `
          <button class="popup-btn cancel" onclick="resetEverything()">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        `;
      }
    }

    // ==================== DOWNLOAD FUNCTIONS ====================
    async function downloadPNG() {
      try {
        console.log('üîÑ Starting PNG download...');
        
        if (typeof html2canvas === 'undefined') {
          throw new Error('html2canvas library not loaded');
        }
        
        const slipElement = document.getElementById('confirmationSlip');
        
        if (!slipElement) {
          throw new Error('Confirmation slip element not found');
        }

        // Create a clone for screenshot
        const clone = slipElement.cloneNode(true);
        clone.style.display = 'block';
        clone.style.position = 'fixed';
        clone.style.left = '0';
        clone.style.top = '0';
        clone.style.transform = 'none';
        clone.style.zIndex = '9999';
        clone.style.margin = '0';
        clone.style.background = 'white';
        
        // Append clone to body
        document.body.appendChild(clone);

        console.log('üé® Generating canvas...');
        const canvas = await html2canvas(clone, {
          scale: 3,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          width: clone.offsetWidth,
          height: clone.offsetHeight,
          x: 0,
          y: 0,
          scrollX: 0,
          scrollY: 0,
          windowWidth: clone.offsetWidth,
          windowHeight: clone.offsetHeight
        });

        // Remove clone
        document.body.removeChild(clone);

        console.log('‚úÖ Canvas generated, creating download...');
        const link = document.createElement('a');
        link.download = `appointment-serial-${currentAppointmentData.serial}.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('‚úÖ PNG download completed');
        
        // Show success message with OK button
        showPopup('success', '‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤', 'PNG ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
        
      } catch (error) {
        console.error('‚ùå PNG download error:', error);
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', `PNG ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${error.message}`);
      }
    }

    async function downloadPDF() {
      try {
        console.log('üîÑ Starting PDF download...');
        
        if (typeof window.jspdf === 'undefined') {
          throw new Error('jsPDF library not loaded');
        }
        if (typeof html2canvas === 'undefined') {
          throw new Error('html2canvas library not loaded');
        }

        const jsPDF = window.jspdf.jsPDF;
        const slipElement = document.getElementById('confirmationSlip');
        
        if (!slipElement) {
          throw new Error('Confirmation slip element not found');
        }

        // Create a clone for screenshot
        const clone = slipElement.cloneNode(true);
        clone.style.display = 'block';
        clone.style.position = 'fixed';
        clone.style.left = '0';
        clone.style.top = '0';
        clone.style.transform = 'none';
        clone.style.zIndex = '9999';
        clone.style.margin = '0';
        clone.style.background = 'white';
        
        // Append clone to body
        document.body.appendChild(clone);

        console.log('üé® Generating canvas for PDF...');
        const canvas = await html2canvas(clone, {
          scale: 3,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          width: clone.offsetWidth,
          height: clone.offsetHeight,
          x: 0,
          y: 0,
          scrollX: 0,
          scrollY: 0
        });

        // Remove clone
        document.body.removeChild(clone);

        console.log('üìÑ Creating PDF...');
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a6'
        });
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        // Add image to PDF
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`appointment-serial-${currentAppointmentData.serial}.pdf`);
        
        console.log('‚úÖ PDF download completed');
        
        // Show success message with OK button
        showPopup('success', '‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤', 'PDF ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
        
      } catch (error) {
        console.error('‚ùå PDF download error:', error);
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', `PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${error.message}`);
      }
    }

    // ==================== SEARCH FUNCTIONS ====================
    async function searchAppointments() {
      const phone = searchPhone.value.trim();
      
      // Validation
      if (!phone) {
        phoneError.textContent = '‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡¶§‡ßá ‡¶π‡¶¨‡ßá';
        phoneError.style.display = 'block';
        searchPhone.focus();
        return;
      }
      
      if (!/^01[0-9]{9}$/.test(phone)) {
        phoneError.textContent = '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (01XXXXXXXXX)';
        phoneError.style.display = 'block';
        searchPhone.focus();
        return;
      }
      
      phoneError.style.display = 'none';
      
      if (!db) {
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        return;
      }
      
      try {
        // Show loading
        searchBtn.classList.add('loading');
        searchBtn.textContent = 'üîç ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶õ‡¶ø...';
        
        console.log(`üîç Searching CONFIRMED appointments for phone: ${phone}`);
        
        // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ (‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶®‡¶Ø‡¶º)
        const snapshot = await db.collection('appointments')
          .where('phone', '==', phone)
          .where('status', '==', 'confirmed')
          .get();
        
        const appointments = [];
        snapshot.forEach(doc => {
          appointments.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Hide loading
        searchBtn.classList.remove('loading');
        searchBtn.textContent = 'üîç ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®';
        
        // Display results
        displaySearchResults(appointments);
        
      } catch (error) {
        console.error('‚ùå Error searching appointments:', error);
        searchBtn.classList.remove('loading');
        searchBtn.textContent = 'üîç ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®';
        showPopup('error', '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
      }
    }

    // ==================== ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶ï ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ ‡¶∏‡¶π) ====================
    function checkIfAppointmentExpired(appointmentDay, appointmentTimestamp) {
      const now = new Date();
      const today = now.getDay(); // 0=‡¶∞‡¶¨‡¶ø, 1=‡¶∏‡ßã‡¶Æ, 2=‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤, 3=‡¶¨‡ßÅ‡¶ß, 4=‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø, 5=‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞, 6=‡¶∂‡¶®‡¶ø
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      
      // ‡¶°‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç
      const dayMap = {
        "Thursday": 4,
        "Friday": 5
      };
      
      const appDayIndex = dayMap[appointmentDay];
      
      // ‡¶Ø‡¶¶‡¶ø ‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶®‡¶æ ‡¶π‡ßü
      if (appDayIndex === undefined) {
        return false;
      }
      
      // ‚úÖ ‡¶Ø‡¶¶‡¶ø ‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶∏‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
      if (appointmentTimestamp) {
        try {
          const appointmentDate = appointmentTimestamp.toDate ? appointmentTimestamp.toDate() : new Date(appointmentTimestamp);
          
          // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶Ü‡¶∏‡¶≤ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶•‡ßá‡¶ï‡ßá)
          const daysMap = {
            "Sunday": 0, "Monday": 1, "Tuesday": 2, "Wednesday": 3,
            "Thursday": 4, "Friday": 5, "Saturday": 6
          };
          
          const targetDayIndex = daysMap[appointmentDay];
          const bookingDayIndex = appointmentDate.getDay();
          
          // ‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶•‡ßá‡¶ï‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶® ‡¶ï‡¶§‡¶¶‡¶ø‡¶® ‡¶™‡¶∞
          let daysToAdd = targetDayIndex - bookingDayIndex;
          if (daysToAdd < 0) {
            daysToAdd += 7; // ‡¶™‡¶∞‡ßá‡¶∞ ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá
          }
          
          // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶Ü‡¶∏‡¶≤ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ
          const actualAppointmentDate = new Date(appointmentDate);
          actualAppointmentDate.setDate(appointmentDate.getDate() + daysToAdd);
          
          // ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ, ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡¶æ‡¶¶)
          const todayDateOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          
          // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ, ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡¶æ‡¶¶)
          const appointmentDateOnly = new Date(
            actualAppointmentDate.getFullYear(), 
            actualAppointmentDate.getMonth(), 
            actualAppointmentDate.getDate()
          );
          
          // ‚úÖ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶ö‡ßá‡¶ï:
          // 1. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ < ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‚Üí ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°
          if (appointmentDateOnly < todayDateOnly) {
            return true;
          }
          // 2. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ === ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‚Üí ‡¶∞‡¶æ‡¶§ ‡ßß‡ßß:‡ß´‡ßØ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶°
          else if (appointmentDateOnly.getTime() === todayDateOnly.getTime()) {
            if (currentHour < 23 || (currentHour === 23 && currentMinute < 59)) {
              return false; // ‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶°
            } else {
              return true; // ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶°
            }
          }
          // 3. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ > ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‚Üí ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶°
          else {
            return false;
          }
          
        } catch (error) {
          console.error('Error calculating expired status with timestamp:', error);
          // Error ‡¶π‡¶≤‡ßá ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        }
      }
      
      // ‚úÖ ‡¶Ø‡¶¶‡¶ø ‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
      // ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ
      if (today === appDayIndex) {
        // ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®
        // ‡¶∞‡¶æ‡¶§ ‡ßß‡ßß:‡ß´‡ßØ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶° ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
        if (currentHour < 23 || (currentHour === 23 && currentMinute < 59)) {
          return false; // ‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶°
        } else {
          return true; // ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶°
        }
      } else if (today > appDayIndex) {
        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶™‡¶æ‡¶∞ ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡ßá
        return true; // ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶°
      } else {
        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶è‡¶ñ‡¶®‡¶ì ‡¶Ü‡¶∏‡ßá‡¶®‡¶ø
        return false; // ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶°
      }
    }

    function displaySearchResults(appointments) {
      resultsContainer.innerHTML = '';
      
      if (!appointments || appointments.length === 0) {
        resultsContainer.innerHTML = `
          <div class="no-results">
            <div>üîç</div>
            <h3>‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</h3>
            <p>‡¶è‡¶á ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á</p>
            <p>‡¶Ö‡¶•‡¶¨‡¶æ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡ßá</p>
          </div>
        `;
        resultsSection.style.display = 'block';
        return;
      }
      
      // Sort appointments by day and serial
      appointments.sort((a, b) => {
        // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶ï (‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ ‡¶∏‡¶π)
        const aExpired = checkIfAppointmentExpired(a.day, a.timestamp);
        const bExpired = checkIfAppointmentExpired(b.day, b.timestamp);
        
        // ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶° ‡¶â‡¶™‡¶∞‡ßá, ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶ö‡ßá
        if (!aExpired && bExpired) return -1; // a ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶°, b ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‚Üí a ‡¶â‡¶™‡¶∞‡ßá
        if (aExpired && !bExpired) return 1;  // a ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶°, b ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶° ‚Üí b ‡¶â‡¶™‡¶∞‡ßá
        if (a.day !== b.day) {
          return a.day === 'Thursday' ? -1 : 1;
        }
        return a.serial - b.serial;
      });
      
      let html = '';
      
      appointments.forEach(app => {
        const dayText = app.day === 'Thursday' ? '‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø‡¶¨‡¶æ‡¶∞' : '‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞‡¶¨‡¶æ‡¶∞';
        const typeText = app.patientType === 'new' ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ' : '‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßã‡¶ó‡ßÄ';
        
        // ‚úÖ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶ï (‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ ‡¶∏‡¶π)
        const isExpired = checkIfAppointmentExpired(app.day, app.timestamp);
        const statusText = isExpired ? '‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶°' : '‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶°';
        const statusColor = isExpired ? 'background: var(--danger); color: white;' : 'background: var(--success); color: white;';
        
        // ‚úÖ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® - getDateForAppointment ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        const dateInfo = getDateForAppointment(app.day, app.timestamp);
        
        // ‚úÖ ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ
        let ageDisplayText = getAgeDisplay(app);

        // ‚úÖ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶π‡¶≤‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶¨‡¶æ‡¶ü‡¶® ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ
        const downloadButtonHTML = isExpired 
          ? `<div class="expired-notice" style="color: var(--danger); font-style: italic; margin-top: 10px; padding: 10px; background: #fee; border-radius: 5px;">
              ‚õî ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° - ‡¶∏‡ßç‡¶≤‡¶ø‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ<br>
              <small>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${dateInfo.banglaDate}</small>
             </div>` 
          : `<button class="download-btn" onclick="downloadAppointmentSlip(${JSON.stringify(app).replace(/"/g, '&quot;')})">
              üìÑ ‡¶∏‡ßç‡¶≤‡¶ø‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>`;
        
        html += `
          <div class="appointment-card">
            <div class="appointment-header">
              <div class="appointment-serial">‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ #${app.serial}</div>
              <div class="appointment-status" style="${statusColor}">
                ${statusText}
              </div>
            </div>
            
            <div class="appointment-details">
              <div class="detail-row">
                <span class="detail-label">‡¶®‡¶æ‡¶Æ:</span>
                <span class="detail-value">${app.name}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">‡¶¨‡¶Ø‡¶º‡¶∏:</span>
                <span class="detail-value">${ageDisplayText}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">‡¶¶‡¶ø‡¶®:</span>
                <span class="detail-value">${dateInfo.banglaDate}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">‡¶∏‡¶Æ‡¶Ø‡¶º:</span>
                <span class="detail-value">${app.time}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">‡¶ß‡¶∞‡¶®:</span>
                <span class="detail-value">${typeText}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</span>
                <span class="detail-value">${formatTimestamp(app.timestamp)}</span>
              </div>
            </div>
            
            ${downloadButtonHTML}
          </div>
        `;
      });
      
      resultsContainer.innerHTML = html;
      resultsSection.style.display = 'block';
      
      // Scroll to results
      resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    function downloadAppointmentSlip(appointmentData) {
      // ‚úÖ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ ‡¶∏‡¶π)
      const isExpired = checkIfAppointmentExpired(appointmentData.day, appointmentData.timestamp);
      
      if (isExpired) {
        showPopup('error', '‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶°', '‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡¶æ‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡ßç‡¶≤‡¶ø‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§');
        return;
      }
      // Store for slip generation
      currentAppointmentData = appointmentData;
      
      // Show popup with slip
      showPopup('success', '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶≤‡¶ø‡¶™', 
        '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡¶ø‡¶ö‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡ßç‡¶≤‡¶ø‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§',
        { showSlip: true });
    }

    function formatTimestamp(timestamp) {
      if (!timestamp) return 'N/A';
      
      try {
        const date = timestamp.toDate();
        return date.toLocaleDateString('bn-BD', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (error) {
        return 'N/A';
      }
    }

    // ==================== UTILITY FUNCTIONS ====================

    // Phone validation
    searchPhone.addEventListener('input', () => {
      const val = searchPhone.value;
      const valid = /^01[0-9]{9}$/.test(val);
      
      if(!valid && val.length > 0) {
        phoneError.style.display = 'block';
      } else {
        phoneError.style.display = 'none';
      }
    });

    // Enter key support
    searchPhone.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchAppointments();
      }
    });

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîç Search page loaded');
      
      // Auto-focus on phone input
      searchPhone.focus();
    });
</script>
</body>
</html>